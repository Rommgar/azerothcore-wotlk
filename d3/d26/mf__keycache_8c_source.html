<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Azerotcore-wotlk: deps/mysqllite/mysys/mf_keycache.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Azerotcore-wotlk
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_94a36784afa54c0b50996002372b429e.html">deps</a></li><li class="navelem"><a class="el" href="../../dir_c19b06727b8b6746540d83e2aa4b49f4.html">mysqllite</a></li><li class="navelem"><a class="el" href="../../dir_13dccb09ed58d8961791937bd7e01efd.html">mysys</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">mf_keycache.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d3/d26/mf__keycache_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Copyright (C) 2000 MySQL AB, 2008-2009 Sun Microsystems, Inc</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">   This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">   it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">   the Free Software Foundation; version 2 of the License.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">   This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">   GNU General Public License for more details.</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">   You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">   along with this program; if not, write to the Free Software</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">  Key Cache Locking</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">  =================</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">  All key cache locking is done with a single mutex per key cache:</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">  keycache-&gt;cache_lock. This mutex is locked almost all the time</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">  when executing code in this file (mf_keycache.c).</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">  However it is released for I/O and some copy operations.</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">  The cache_lock is also released when waiting for some event. Waiting</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">  and signalling is done via condition variables. In most cases the</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">  thread waits on its thread-&gt;suspend condition variable. Every thread</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">  has a my_thread_var structure, which contains this variable and a</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">  &#39;*next&#39; and &#39;**prev&#39; pointer. These pointers are used to insert the</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">  thread into a wait queue.</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">  A thread can wait for one block and thus be in one wait queue at a</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">  time only.</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">  Before starting to wait on its condition variable with</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">  mysql_cond_wait(), the thread enters itself to a specific wait queue</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">  with link_into_queue() (double linked with &#39;*next&#39; + &#39;**prev&#39;) or</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">  wait_on_queue() (single linked with &#39;*next&#39;).</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">  Another thread, when releasing a resource, looks up the waiting thread</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">  in the related wait queue. It sends a signal with</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">  mysql_cond_signal() to the waiting thread.</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">  NOTE: Depending on the particular wait situation, either the sending</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">  thread removes the waiting thread from the wait queue with</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">  unlink_from_queue() or release_whole_queue() respectively, or the waiting</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">  thread removes itself.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">  There is one exception from this locking scheme when one thread wants</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">  to reuse a block for some other address. This works by first marking</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">  the block reserved (status= BLOCK_IN_SWITCH) and then waiting for all</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">  threads that are reading the block to finish. Each block has a</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">  reference to a condition variable (condvar). It holds a reference to</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">  the thread-&gt;suspend condition variable for the waiting thread (if such</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">  a thread exists). When that thread is signaled, the reference is</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">  cleared. The number of readers of a block is registered in</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">  block-&gt;hash_link-&gt;requests. See wait_for_readers() / remove_reader()</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">  for details. This is similar to the above, but it clearly means that</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">  only one thread can wait for a particular block. There is no queue in</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">  this case. Strangely enough block-&gt;convar is used for waiting for the</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">  assigned hash_link only. More precisely it is used to wait for all</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">  requests to be unregistered from the assigned hash_link.</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">  The resize_queue serves two purposes:</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">  1. Threads that want to do a resize wait there if in_resize is set.</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">     This is not used in the server. The server refuses a second resize</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">     request if one is already active. keycache-&gt;in_init is used for the</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">     synchronization. See set_var.cc.</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">  2. Threads that want to access blocks during resize wait here during</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">     the re-initialization phase.</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">  When the resize is done, all threads on the queue are signalled.</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">  Hypothetical resizers can compete for resizing, and read/write</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">  requests will restart to request blocks from the freshly resized</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">  cache. If the cache has been resized too small, it is disabled and</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">  &#39;can_be_used&#39; is false. In this case read/write requests bypass the</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">  cache. Since they increment and decrement &#39;cnt_for_resize_op&#39;, the</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">  next resizer can wait on the queue &#39;waiting_for_resize_cnt&#39; until all</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">  I/O finished.</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/d34/mysys__priv_8h.html">mysys_priv.h</a>&quot;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d3/dcf/mysys__err_8h.html">mysys_err.h</a>&quot;</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../de/dc2/keycache_8h.html">keycache.h</a>&gt;</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/dda/my__static_8h.html">my_static.h</a>&quot;</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d6/dda/m__string_8h.html">m_string.h</a>&gt;</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../de/dec/my__bit_8h.html">my_bit.h</a>&gt;</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/dd4/probes__mysql_8h.html">probes_mysql.h</a>&quot;</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160; </div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">  Some compilation flags have been added specifically for this module</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">  to control the following:</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">  - not to let a thread to yield the control when reading directly</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">    from key cache, which might improve performance in many cases;</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">    to enable this add:</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">    #define SERIALIZED_READ_FROM_CACHE</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">  - to set an upper bound for number of threads simultaneously</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">    using the key cache; this setting helps to determine an optimal</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">    size for hash table and improve performance when the number of</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">    blocks in the key cache much less than the number of threads</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">    accessing it;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">    to set this number equal to &lt;N&gt; add</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">      #define MAX_THREADS &lt;N&gt;</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">  - to substitute calls of mysql_cond_wait for calls of</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">    mysql_cond_timedwait (wait with timeout set up);</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">    this setting should be used only when you want to trap a deadlock</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">    situation, which theoretically should not happen;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">    to set timeout equal to &lt;T&gt; seconds add</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">      #define KEYCACHE_TIMEOUT &lt;T&gt;</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">  - to enable the module traps and to send debug information from</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">    key cache module to a special debug log add:</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">      #define KEYCACHE_DEBUG</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">    the name of this debug log file &lt;LOG NAME&gt; can be set through:</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">      #define KEYCACHE_DEBUG_LOG  &lt;LOG NAME&gt;</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">    if the name is not defined, it&#39;s set by default;</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">    if the KEYCACHE_DEBUG flag is not set up and we are in a debug</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">    mode, i.e. when ! defined(DBUG_OFF), the debug information from the</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">    module is sent to the regular debug log.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">  Example of the settings:</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">    #define SERIALIZED_READ_FROM_CACHE</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">    #define MAX_THREADS   100</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">    #define KEYCACHE_TIMEOUT  1</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">    #define KEYCACHE_DEBUG</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">    #define KEYCACHE_DEBUG_LOG  &quot;my_key_cache_debug.log&quot;</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a201eb06374e27d8a1f76f1af79813571">  155</a></span>&#160;<span class="preprocessor">#define STRUCT_PTR(TYPE, MEMBER, a)                                           \</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="preprocessor">          (TYPE *) ((char *) (a) - offsetof(TYPE, MEMBER))</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">/* types of condition variables */</span></div>
<div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">  159</a></span>&#160;<span class="preprocessor">#define  COND_FOR_REQUESTED 0</span></div>
<div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">  160</a></span>&#160;<span class="preprocessor">#define  COND_FOR_SAVED     1</span></div>
<div class="line"><a name="l00161"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#af0a3c2d0bea0c5e7b1807de8b9a786fe">  161</a></span>&#160;<span class="preprocessor">#define  COND_FOR_READERS   2</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a459e57d1695b31814a33224b5dd81b2e">  163</a></span>&#160;<span class="keyword">typedef</span> <a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a459e57d1695b31814a33224b5dd81b2e">KEYCACHE_CONDVAR</a>;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">/* descriptor of the page in the key cache block buffer */</span></div>
<div class="line"><a name="l00166"></a><span class="lineno"><a class="line" href="../../d1/d62/structst__keycache__page.html">  166</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d1/d62/structst__keycache__page.html">st_keycache_page</a></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;{</div>
<div class="line"><a name="l00168"></a><span class="lineno"><a class="line" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">  168</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">file</a>;               <span class="comment">/* file to which the page belongs to  */</span></div>
<div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">  169</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> <a class="code" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">filepos</a>;       <span class="comment">/* position of the page in the file   */</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;};</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">/* element in the chain of a hash table bucket */</span></div>
<div class="line"><a name="l00173"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html">  173</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/d23/structst__hash__link.html">st_hash_link</a></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;{</div>
<div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">  175</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="../../df/d23/structst__hash__link.html">st_hash_link</a> *<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>, **<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>; <span class="comment">/* to connect links in the same bucket  */</span></div>
<div class="line"><a name="l00176"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">  176</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="../../df/d94/structst__block__link.html">st_block_link</a> *<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>;       <span class="comment">/* reference to the block for the page: */</span></div>
<div class="line"><a name="l00177"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">  177</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>;                         <span class="comment">/* from such a file                     */</span></div>
<div class="line"><a name="l00178"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">  178</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> <a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>;                  <span class="comment">/* with such an offset                  */</span></div>
<div class="line"><a name="l00179"></a><span class="lineno"><a class="line" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">  179</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>;                     <span class="comment">/* number of requests for the page      */</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;};</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">/* simple states of a block */</span></div>
<div class="line"><a name="l00183"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">  183</a></span>&#160;<span class="preprocessor">#define BLOCK_ERROR           1 </span><span class="comment">/* an error occured when performing file i/o */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">  184</a></span>&#160;<span class="preprocessor">#define BLOCK_READ            2 </span><span class="comment">/* file block is in the block buffer         */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">  185</a></span>&#160;<span class="preprocessor">#define BLOCK_IN_SWITCH       4 </span><span class="comment">/* block is preparing to read new page       */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">  186</a></span>&#160;<span class="preprocessor">#define BLOCK_REASSIGNED      8 </span><span class="comment">/* blk does not accept requests for old page */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">  187</a></span>&#160;<span class="preprocessor">#define BLOCK_IN_FLUSH       16 </span><span class="comment">/* block is selected for flush               */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">  188</a></span>&#160;<span class="preprocessor">#define BLOCK_CHANGED        32 </span><span class="comment">/* block buffer contains a dirty page        */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">  189</a></span>&#160;<span class="preprocessor">#define BLOCK_IN_USE         64 </span><span class="comment">/* block is not free                         */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00190"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">  190</a></span>&#160;<span class="preprocessor">#define BLOCK_IN_EVICTION   128 </span><span class="comment">/* block is selected for eviction            */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00191"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">  191</a></span>&#160;<span class="preprocessor">#define BLOCK_IN_FLUSHWRITE 256 </span><span class="comment">/* block is in write to file                 */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00192"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">  192</a></span>&#160;<span class="preprocessor">#define BLOCK_FOR_UPDATE    512 </span><span class="comment">/* block is selected for buffer modification */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">/* page status, returned by find_key_block */</span></div>
<div class="line"><a name="l00195"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">  195</a></span>&#160;<span class="preprocessor">#define PAGE_READ               0</span></div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">  196</a></span>&#160;<span class="preprocessor">#define PAGE_TO_BE_READ         1</span></div>
<div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">  197</a></span>&#160;<span class="preprocessor">#define PAGE_WAIT_TO_BE_READ    2</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160; </div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">/* block temperature determines in which (sub-)chain the block currently is */</span></div>
<div class="line"><a name="l00200"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550">  200</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ad">BLOCK_TEMPERATURE</a> { <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550">BLOCK_COLD</a> <span class="comment">/*free*/</span> , <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a> , <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada9b0e5b737da218510a23b0d69cd4ccf0">BLOCK_HOT</a> };</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">/* key cache block */</span></div>
<div class="line"><a name="l00203"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html">  203</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/d94/structst__block__link.html">st_block_link</a></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;{</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../df/d94/structst__block__link.html">st_block_link</a></div>
<div class="line"><a name="l00206"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a278733a568c53aa510f3de746b5154b4">  206</a></span>&#160;    *<a class="code" href="../../df/d94/structst__block__link.html#a278733a568c53aa510f3de746b5154b4">next_used</a>, **<a class="code" href="../../df/d94/structst__block__link.html#a77125bee1c76f943553d6d0a4c06f16b">prev_used</a>;   <span class="comment">/* to connect links in the LRU chain (ring)   */</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../df/d94/structst__block__link.html">st_block_link</a></div>
<div class="line"><a name="l00208"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a96d770defa3d3cbd10a4ba16854d3152">  208</a></span>&#160;    *<a class="code" href="../../df/d94/structst__block__link.html#a96d770defa3d3cbd10a4ba16854d3152">next_changed</a>, **<a class="code" href="../../df/d94/structst__block__link.html#a0c8c850da8a98c38513e6300e9bf73ca">prev_changed</a>; <span class="comment">/* for lists of file dirty/clean blocks   */</span></div>
<div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#ad38f5e1b5c350f96a1d78c97a896fbc2">  209</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="../../df/d23/structst__hash__link.html">st_hash_link</a> *<a class="code" href="../../df/d94/structst__block__link.html#ad38f5e1b5c350f96a1d78c97a896fbc2">hash_link</a>; <span class="comment">/* backward ptr to referring hash_link     */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">  210</a></span>&#160;  <a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> <a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[2]; <span class="comment">/* queues on waiting requests for new/old pages */</span></div>
<div class="line"><a name="l00211"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a2861454c5ee71acb232f1dc5eb61b109">  211</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d94/structst__block__link.html#a2861454c5ee71acb232f1dc5eb61b109">requests</a>;          <span class="comment">/* number of requests for the block                */</span></div>
<div class="line"><a name="l00212"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#af763a5b12221b1b6d045cc3d99eb3e53">  212</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *<a class="code" href="../../df/d94/structst__block__link.html#af763a5b12221b1b6d045cc3d99eb3e53">buffer</a>;           <span class="comment">/* buffer for the block page                       */</span></div>
<div class="line"><a name="l00213"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a11541c03ef485eebc6e178f138954599">  213</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d94/structst__block__link.html#a11541c03ef485eebc6e178f138954599">offset</a>;            <span class="comment">/* beginning of modified data in the buffer        */</span></div>
<div class="line"><a name="l00214"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a2957e0cd022418bbc39c5e44d3e747ed">  214</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d94/structst__block__link.html#a2957e0cd022418bbc39c5e44d3e747ed">length</a>;            <span class="comment">/* end of data in the buffer                       */</span></div>
<div class="line"><a name="l00215"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">  215</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">status</a>;            <span class="comment">/* state of the block                              */</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keyword">enum</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ad">BLOCK_TEMPERATURE</a> <a class="code" href="../../df/d94/structst__block__link.html#a0d784e15066be2b2a0b1334838595843">temperature</a>; <span class="comment">/* block temperature: cold, warm, hot */</span></div>
<div class="line"><a name="l00217"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#afc4d5c506ed49d7d462293085f8bf04c">  217</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/d94/structst__block__link.html#afc4d5c506ed49d7d462293085f8bf04c">hits_left</a>;         <span class="comment">/* number of hits left until promotion             */</span></div>
<div class="line"><a name="l00218"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a6b4b3c3f8bef2b254407348a80f3e055">  218</a></span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#ae7c11be50f0b11d048979398c5fdcfa5">ulonglong</a> <a class="code" href="../../df/d94/structst__block__link.html#a6b4b3c3f8bef2b254407348a80f3e055">last_hit_time</a>; <span class="comment">/* timestamp of the last hit                      */</span></div>
<div class="line"><a name="l00219"></a><span class="lineno"><a class="line" href="../../df/d94/structst__block__link.html#a3569839d38938a759f68f71c9b9175a1">  219</a></span>&#160;  <a class="code" href="../../d9/d27/structst__mysql__cond.html">KEYCACHE_CONDVAR</a> *<a class="code" href="../../df/d94/structst__block__link.html#a3569839d38938a759f68f71c9b9175a1">condvar</a>; <span class="comment">/* condition variable for &#39;no readers&#39; event    */</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;};</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#a4fc715bfb4b31e5ea371b4613f246d42">  222</a></span>&#160;<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4fc715bfb4b31e5ea371b4613f246d42">dflt_key_cache_var</a>;</div>
<div class="line"><a name="l00223"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ab800abece46f16337a8575f6f94fa5bb">  223</a></span>&#160;<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *<a class="code" href="../../d3/d26/mf__keycache_8c.html#ab800abece46f16337a8575f6f94fa5bb">dflt_key_cache</a>= &amp;<a class="code" href="../../d3/d26/mf__keycache_8c.html#a4fc715bfb4b31e5ea371b4613f246d42">dflt_key_cache_var</a>;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">  225</a></span>&#160;<span class="preprocessor">#define FLUSH_CACHE         2000            </span><span class="comment">/* sort this many blocks at once */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e9e1708936ac404c45527d26958ae16">flush_all_key_blocks</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue,</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                          <a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160; </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">  235</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                           <span class="keyword">const</span> <span class="keywordtype">char</span> *where, <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> lock);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#afced45e5c89364d6703389c01e68f55f">  239</a></span>&#160;<span class="preprocessor">#define KEYCACHE_HASH(f, pos)                                                 \</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="preprocessor">(((ulong) ((pos) / keycache-&gt;key_cache_block_size) +                          \</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="preprocessor">                                     (ulong) (f)) &amp; (keycache-&gt;hash_entries-1))</span></div>
<div class="line"><a name="l00242"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">  242</a></span>&#160;<span class="preprocessor">#define FILE_HASH(f)                 ((uint) (f) &amp; (CHANGED_BLOCKS_HASH-1))</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a8279bb6de4d3e84aa0e696d8714caa46">  244</a></span>&#160;<span class="preprocessor">#define DEFAULT_KEYCACHE_DEBUG_LOG  &quot;keycache_debug.log&quot;</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG) &amp;&amp; ! defined(KEYCACHE_DEBUG_LOG)</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor">#define KEYCACHE_DEBUG_LOG  DEFAULT_KEYCACHE_DEBUG_LOG</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160; </div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG_LOG)</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keyword">static</span> FILE *keycache_debug_log=<a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> keycache_debug_print(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d7a/fmt_8cc.html#a7fb945a0739ee85a6cb82424f6043d27">fmt</a>,...);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor">#define KEYCACHE_DEBUG_OPEN                                                   \</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">          if (!keycache_debug_log)                                            \</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">          {                                                                   \</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">            keycache_debug_log= fopen(KEYCACHE_DEBUG_LOG, &quot;w&quot;</span>);               \</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            (void) setvbuf(keycache_debug_log, NULL, _IOLBF, BUFSIZ);         \</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;          }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">#define KEYCACHE_DEBUG_CLOSE                                                  \</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor">          if (keycache_debug_log)                                             \</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">          {                                                                   \</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">            fclose(keycache_debug_log);                                       \</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">            keycache_debug_log= 0;                                            \</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">          }</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00267"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1d4c7082211af7b0a0d2e1594785aa3e">  267</a></span>&#160;<span class="preprocessor">#define KEYCACHE_DEBUG_OPEN</span></div>
<div class="line"><a name="l00268"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a8ee571cefdea70da535b27a8d27f4885">  268</a></span>&#160;<span class="preprocessor">#define KEYCACHE_DEBUG_CLOSE</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG_LOG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160; </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG_LOG) &amp;&amp; defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="preprocessor">#define KEYCACHE_DBUG_PRINT(l, m)                                             \</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="preprocessor">            { if (keycache_debug_log) fprintf(keycache_debug_log, &quot;%s: &quot;</span>, l); \</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;              keycache_debug_print m; }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#define KEYCACHE_DBUG_ASSERT(a)                                               \</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="preprocessor">            { if (! (a) &amp;&amp; keycache_debug_log) fclose(keycache_debug_log);    \</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">              assert(a); }</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00280"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">  280</a></span>&#160;<span class="preprocessor">#define KEYCACHE_DBUG_PRINT(l, m)  DBUG_PRINT(l, m)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">  281</a></span>&#160;<span class="preprocessor">#define KEYCACHE_DBUG_ASSERT(a)    DBUG_ASSERT(a)</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG_LOG) &amp;&amp; defined(KEYCACHE_DEBUG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG) || !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a15355029fead2872a757e1d854f8f0d8">  286</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a15355029fead2872a757e1d854f8f0d8">keycache_thread_id</a>;</div>
<div class="line"><a name="l00287"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">  287</a></span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE(l)                                              \</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="preprocessor">             KEYCACHE_DBUG_PRINT(l,(&quot;|thread %ld&quot;</span>,keycache_thread_id))</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9b494c4988b087161e4073fbd4b595aa">  290</a></span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE_BEGIN(l)                                        \</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="preprocessor">            { struct st_my_thread_var *thread_var= my_thread_var;             \</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="preprocessor">              keycache_thread_id= thread_var-&gt;id;                             \</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">              KEYCACHE_DBUG_PRINT(l,(&quot;[thread %ld&quot;</span>,keycache_thread_id)) }</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160; </div>
<div class="line"><a name="l00295"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a5be6b9a8727840f3707d846228fbe51f">  295</a></span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE_END(l)                                          \</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="preprocessor">            KEYCACHE_DBUG_PRINT(l,(&quot;]thread %ld&quot;</span>,keycache_thread_id))</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE_BEGIN(l)</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE_END(l)</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="preprocessor">#define KEYCACHE_THREAD_TRACE(l)</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG) || !defined(DBUG_OFF) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160; </div>
<div class="line"><a name="l00303"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">  303</a></span>&#160;<span class="preprocessor">#define BLOCK_NUMBER(b)                                                       \</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">  ((uint) (((char*)(b)-(char *) keycache-&gt;block_root)/sizeof(BLOCK_LINK)))</span></div>
<div class="line"><a name="l00305"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9ac6a20acf7c4e32dd0daa72a96d4381">  305</a></span>&#160;<span class="preprocessor">#define HASH_LINK_NUMBER(h)                                                   \</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="preprocessor">  ((uint) (((char*)(h)-(char *) keycache-&gt;hash_link_root)/sizeof(HASH_LINK)))</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor">#if (defined(KEYCACHE_TIMEOUT) &amp;&amp; !defined(__WIN__)) || defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(<a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> *cond,</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                                      <a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">  312</a></span>&#160;<span class="preprocessor">#define keycache_pthread_cond_wait(C, M) mysql_cond_wait(C, M)</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(<a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(<a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(<a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> *cond);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00320"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">  320</a></span>&#160;<span class="preprocessor">#define keycache_pthread_mutex_lock(M) mysql_mutex_lock(M)</span></div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">  321</a></span>&#160;<span class="preprocessor">#define keycache_pthread_mutex_unlock(M) mysql_mutex_unlock(M)</span></div>
<div class="line"><a name="l00322"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">  322</a></span>&#160;<span class="preprocessor">#define keycache_pthread_cond_signal(C) mysql_cond_signal(C)</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="preprocessor">#if defined(inline)</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="preprocessor">#undef inline</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00329"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a00d24c7231be28dbaf71f5408f30e44c">  329</a></span>&#160;<span class="preprocessor">#define inline  </span><span class="comment">/* disabled inline for easier debugging */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aea0bccc76a000e75ef1905fd76dd640b">fail_hlink</a>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hlink);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2a0dda2a2b90dff2a89dd93c15149d2">cache_empty</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a27848979817f779cd73b4a58b6fcccaf">  335</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a27848979817f779cd73b4a58b6fcccaf">next_power</a>(<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d7/d71/classvalue.html">value</a>)</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;{</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="keywordflow">return</span> (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../de/dec/my__bit_8h.html#a0cb6c7080d6e67aba03a79591bdbbb8d">my_round_up_to_next_power</a>((<a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a>) <a class="code" href="../../d7/d71/classvalue.html">value</a>) &lt;&lt; 1;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">  Initialize a key cache</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">    init_key_cache()</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">    keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">    key_cache_block_size    size of blocks to keep cached data</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">    use_mem                     total memory to use for the key cache</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">    division_limit      division limit (may be zero)</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">    age_threshold       age threshold (may be zero)</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">    number of blocks in the key cache, if successful,</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">    0 - otherwise.</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">    if keycache-&gt;key_cache_inited != 0 we assume that the key cache</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">    is already initialized.  This is for now used by myisamchk, but shouldn&#39;t</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">    be something that a program should rely on!</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">    It&#39;s assumed that no two threads call this function simultaneously</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">    referring to the same key cache handle.</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#ad0fc8526a7a2b14f31b9df818414a224">  366</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ad0fc8526a7a2b14f31b9df818414a224">init_key_cache</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> key_cache_block_size,</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                   <span class="keywordtype">size_t</span> use_mem, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> division_limit,</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                   <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> age_threshold)</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;{</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> blocks, hash_links;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  <span class="keywordtype">size_t</span> <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;init_key_cache&quot;</span>);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(key_cache_block_size &gt;= 512);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4c7082211af7b0a0d2e1594785aa3e">KEYCACHE_DEBUG_OPEN</a>;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a> &amp;&amp; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &gt; 0)</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  {</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;warning&quot;</span>,(<span class="stringliteral">&quot;key cache already in use&quot;</span>));</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160; </div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>= 0;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>= 0;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>= -1;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="keywordflow">if</span> (! keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>= 1;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">      Initialize these variables once only.</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">      Their value must survive re-initialization during resizing.</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>= 0;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>= 0;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a195a3307538d819f13b9e91a025b4a8f">cnt_for_resize_op</a>= 0;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae3c67ed105880d4caf9f1664140a21b8">waiting_for_resize_cnt</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6a006dd56ebd3b5e4ae9a485799881c5">in_init</a>= 0;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <a class="code" href="../../de/d55/group___thread__instrumentation.html#gaf4fc58e68eb34057e9954944a34824c1">mysql_mutex_init</a>(key_KEY_CACHE_cache_lock,</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                     &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>, <a class="code" href="../../da/da8/my__pthread_8h.html#a7ac1faca6820fee0cb790ee7a7e68fea">MY_MUTEX_INIT_FAST</a>);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">resize_queue</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  }</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160; </div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8a83a6143b60800f36c9e4ec01b1e0c7">key_cache_mem_size</a>= use_mem;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>= key_cache_block_size;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;info&quot;</span>, (<span class="stringliteral">&quot;key_cache_block_size: %u&quot;</span>,</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;              key_cache_block_size));</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  blocks= (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (use_mem / (<span class="keyword">sizeof</span>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>) + 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>) +</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                              <span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>*) * 5/4 + key_cache_block_size));</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="comment">/* It doesn&#39;t make sense to have too few blocks (less than 8) */</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">if</span> (blocks &gt;= 8)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  {</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">for</span> ( ; ; )</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      <span class="comment">/* Set my_hash_entries to the next bigger 2 power */</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <span class="keywordflow">if</span> ((keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a27848979817f779cd73b4a58b6fcccaf">next_power</a>(blocks)) &lt; blocks * 5/4)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a>&lt;&lt;= 1;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      hash_links= 2 * blocks;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;#<span class="keywordflow">if</span> defined(<a class="code" href="../../d1/d09/thr__lock_8c.html#a8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a>)</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      <span class="keywordflow">if</span> (hash_links &lt; <a class="code" href="../../d1/d09/thr__lock_8c.html#a8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a> + blocks - 1)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        hash_links= <a class="code" href="../../d1/d09/thr__lock_8c.html#a8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a> + blocks - 1;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      <span class="keywordflow">while</span> ((<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>= (<a class="code" href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a>(blocks * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>)) +</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;               <a class="code" href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a>(hash_links * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>)) +</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;               <a class="code" href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>*) *</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a>))) +</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;         ((size_t) blocks * keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>) &gt; use_mem)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        blocks--;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <span class="comment">/* Allocate memory for cache page buffers */</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      <span class="keywordflow">if</span> ((keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>=</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;       <a class="code" href="../../db/da9/my__sys_8h.html#aeddd90998bb0136c794fc7ba7e54adb5">my_large_malloc</a>((<span class="keywordtype">size_t</span>) blocks * keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>,</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;              <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(0))))</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      {</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">      Allocate memory for blocks, hash_links and hash entries;</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">      For each block 2 hash links are allocated</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">if</span> ((keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>= (<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>*) <a class="code" href="../../db/da9/my__sys_8h.html#a8f7b30ff5d0e10610637aa30c3e0048b">my_malloc</a>(<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>,</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                                                           <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(0))))</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <a class="code" href="../../db/da9/my__sys_8h.html#aba32e671624503b488323bcbd0454bef">my_large_free</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>);</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>= 0;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      }</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordflow">if</span> (blocks &lt; 8)</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      {</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <a class="code" href="../../da/da8/my__pthread_8h.html#ab607b8ccc65b942b3d56aa2aa2e507eb">my_errno</a>= ENOMEM;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <a class="code" href="../../db/da9/my__sys_8h.html#a19ebf963aef6b242322e15e01811972e">my_error</a>(<a class="code" href="../../d3/dcf/mysys__err_8h.html#ac6ce260c4e07352e8294c636515fb5a1">EE_OUTOFMEMORY</a>, <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(0), blocks * keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="keywordflow">goto</span> err;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      blocks= blocks / 4*3;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    }</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a>= blocks;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>= (int) blocks;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a>= hash_links;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a>= (<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>**) ((<span class="keywordtype">char</span>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a> +</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                        <a class="code" href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a>(blocks*<span class="keyword">sizeof</span>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>)));</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">hash_link_root</a>= (<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>*) ((<span class="keywordtype">char</span>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a> +</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                            <a class="code" href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a>((<span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>*) *</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                            keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a>)));</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <a class="code" href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>,</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>));</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <a class="code" href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a>,</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>*));</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <a class="code" href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">hash_link_root</a>,</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a>));</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a01c4fedeb76ae5e06f29f7d1eeba7583">hash_links_used</a>= 0;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">blocks_changed</a>= 0;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">global_blocks_changed</a>= 0;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">blocks_available</a>=0;       <span class="comment">/* For debugging */</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160; </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="comment">/* The LRU chain is empty after initialization */</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">used_ins</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6d94ce3a7dd45735a3791f499fac1b48">keycache_time</a>= 0;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>= 0;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a5747065352c894e9888321d843039dc2">min_warm_blocks</a>= (division_limit ?</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                blocks * division_limit / 100 + 1 :</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                blocks);</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#acdc4f979ecbe74d9625194ab8f96d596">age_threshold</a>= (age_threshold ?</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                  blocks * age_threshold / 100 :</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                  blocks);</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160; </div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>= 1;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160; </div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">waiting_for_hash_link</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;exit&quot;</span>,</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;           (<span class="stringliteral">&quot;disk_blocks: %d  block_root: 0x%lx  hash_entries: %d\</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="stringliteral"> hash_root: 0x%lx  hash_links: %d  hash_link_root: 0x%lx&quot;</span>,</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>,  (<span class="keywordtype">long</span>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>,</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">hash_entries</a>, (<span class="keywordtype">long</span>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a>,</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a>,   (<span class="keywordtype">long</span>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">hash_link_root</a>));</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <a class="code" href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>,</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;      <span class="keyword">sizeof</span>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[0]) * <a class="code" href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a>);</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <a class="code" href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>,</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;      <span class="keyword">sizeof</span>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>[0]) * <a class="code" href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a>);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">/* key_buffer_size is specified too small. Disable the cache. */</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>= 0;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  }</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160; </div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a53fccf40f036616da23983f571bacb5c">blocks</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &gt; 0 ? keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> : 0;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>((<span class="keywordtype">int</span>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>);</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160; </div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;err:</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= <a class="code" href="../../da/da8/my__pthread_8h.html#ab607b8ccc65b942b3d56aa2aa2e507eb">my_errno</a>;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>= 0;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a53fccf40f036616da23983f571bacb5c">blocks</a>=  0;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>)</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  {</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <a class="code" href="../../db/da9/my__sys_8h.html#aba32e671624503b488323bcbd0454bef">my_large_free</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>);</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  }</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>)</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  {</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <a class="code" href="../../db/da9/my__sys_8h.html#a3a3ddffcaadb60b7715c9889f8c56afb">my_free</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>);</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <a class="code" href="../../da/da8/my__pthread_8h.html#ab607b8ccc65b942b3d56aa2aa2e507eb">my_errno</a>= <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>= 0;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;}</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160; </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160; </div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">  Resize a key cache</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">    resize_key_cache()</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">    keycache                pointer to a key cache data structure</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">    key_cache_block_size        size of blocks to keep cached data</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment">    use_mem         total memory to use for the new key cache</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="comment">    division_limit      new division limit (if not zero)</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">    age_threshold       new age threshold (if not zero)</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">    number of blocks in the key cache, if successful,</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">    0 - otherwise.</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">    The function first compares the memory size and the block size parameters</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">    with the key cache values.</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">    If they differ the function free the the memory allocated for the</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">    old key cache blocks by calling the end_key_cache function and</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">    then rebuilds the key cache with new blocks by calling</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">    init_key_cache.</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">    The function starts the operation only when all other threads</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">    performing operations with the key cache let her to proceed</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">    (when cnt_for_resize=0).</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160; </div>
<div class="line"><a name="l00559"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#a8d6892bc7cb4a979cbc23e89a22b386e">  559</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d6892bc7cb4a979cbc23e89a22b386e">resize_key_cache</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> key_cache_block_size,</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                     <span class="keywordtype">size_t</span> use_mem, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> division_limit,</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                     <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> age_threshold)</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;{</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="keywordtype">int</span> blocks;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;resize_key_cache&quot;</span>);</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160; </div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="keywordflow">if</span>(key_cache_block_size == keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a> &amp;&amp;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;     use_mem == keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8a83a6143b60800f36c9e4ec01b1e0c7">key_cache_mem_size</a>)</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  {</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a108f066be8ee492a53e3e6cca587fd28">change_key_cache_param</a>(keycache, division_limit, age_threshold);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  }</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160; </div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; </div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">    We may need to wait for another thread which is doing a resize</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">    already. This cannot happen in the MySQL server though. It allows</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">    one resizer only. In set_var.cc keycache-&gt;in_init is used to block</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment">    multiple attempts.</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordflow">while</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  {</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="comment">/* purecov: begin inspected */</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">resize_queue</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="comment">/* purecov: end */</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  }</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160; </div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">    Mark the operation in progress. This blocks other threads from doing</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">    a resize in parallel. It prohibits new blocks to enter the cache.</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">    Read/write requests can bypass the cache during the flush phase.</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>= 1;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160; </div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="comment">/* Need to flush only if keycache is enabled. */</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="comment">/* Start the flush phase. */</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>= 1;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160; </div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e9e1708936ac404c45527d26958ae16">flush_all_key_blocks</a>(keycache))</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    {</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">/* TODO: if this happens, we should write a warning in the log file ! */</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>= 0;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      blocks= 0;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>= 0;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="../../dd/d0e/tools_2mmaps__generator_2_path_generator_8cpp.html#a32e7545f3a98690aeb284a4eb66f272d">finish</a>;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2a0dda2a2b90dff2a89dd93c15149d2">cache_empty</a>(keycache));</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="comment">/* End the flush phase. */</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>= 0;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  }</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160; </div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">    Some direct read/write operations (bypassing the cache) may still be</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment">    unfinished. Wait until they are done. If the key cache can be used,</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="comment">    direct I/O is done in increments of key_cache_block_size. That is,</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="comment">    every block is checked if it is in the cache. We need to wait for</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="comment">    pending I/O before re-initializing the cache, because we may change</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">    the block size. Otherwise they could check for blocks at file</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">    positions where the new block division has none. We do also want to</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment">    wait for I/O done when (if) the cache was disabled. It must not</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment">    run in parallel with normal cache operation.</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keywordflow">while</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a195a3307538d819f13b9e91a025b4a8f">cnt_for_resize_op</a>)</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae3c67ed105880d4caf9f1664140a21b8">waiting_for_resize_cnt</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">    Free old cache structures, allocate new structures, and initialize</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="comment">    them. Note that the cache_lock mutex and the resize_queue are left</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">    untouched. We do not lose the cache_lock and will release it only at</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">    the end of this function.</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8ee68b09652c680c421c3caa4c02a476">end_key_cache</a>(keycache, 0);           <span class="comment">/* Don&#39;t free mutex */</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  <span class="comment">/* The following will work even if use_mem is 0 */</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  blocks= <a class="code" href="../../d3/d26/mf__keycache_8c.html#ad0fc8526a7a2b14f31b9df818414a224">init_key_cache</a>(keycache, key_cache_block_size, use_mem,</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;             division_limit, age_threshold);</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160; </div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<a class="code" href="../../dd/d0e/tools_2mmaps__generator_2_path_generator_8cpp.html#a32e7545f3a98690aeb284a4eb66f272d">finish</a>:</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">    Mark the resize finished. This allows other threads to start a</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">    resize or to request new cache blocks.</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>= 0;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160; </div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="comment">/* Signal waiting threads. */</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">resize_queue</a>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160; </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(blocks);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;}</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160; </div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160; </div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">  Increment counter blocking resize key cache operation</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00661"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">  661</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache)</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;{</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a195a3307538d819f13b9e91a025b4a8f">cnt_for_resize_op</a>++;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;}</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160; </div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment">  Decrement counter blocking resize key cache operation;</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment">  Signal the operation to proceed when counter becomes equal zero</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00671"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">  671</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache)</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;{</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keywordflow">if</span> (!--keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a195a3307538d819f13b9e91a025b4a8f">cnt_for_resize_op</a>)</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae3c67ed105880d4caf9f1664140a21b8">waiting_for_resize_cnt</a>);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;}</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">  Change the key cache parameters</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">    change_key_cache_param()</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">    keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">    division_limit      new division limit (if not zero)</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">    age_threshold       new age threshold (if not zero)</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment">    Presently the function resets the key cache parameters</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">    concerning midpoint insertion strategy - division_limit and</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment">    age_threshold.</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#a108f066be8ee492a53e3e6cca587fd28">  695</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a108f066be8ee492a53e3e6cca587fd28">change_key_cache_param</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> division_limit,</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> age_threshold)</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;{</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;change_key_cache_param&quot;</span>);</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160; </div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordflow">if</span> (division_limit)</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a5747065352c894e9888321d843039dc2">min_warm_blocks</a>= (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> *</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                division_limit / 100 + 1);</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  <span class="keywordflow">if</span> (age_threshold)</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#acdc4f979ecbe74d9625194ab8f96d596">age_threshold</a>=   (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> *</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                age_threshold / 100);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a2d990f1c0bd095fcbac9c6596274be55">DBUG_VOID_RETURN</a>;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;}</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160; </div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">  Remove key_cache from memory</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment">    end_key_cache()</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">    keycache        key cache handle</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">    cleanup     Complete free (Free also mutex for key cache)</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#a8ee68b09652c680c421c3caa4c02a476">  724</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8ee68b09652c680c421c3caa4c02a476">end_key_cache</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> cleanup)</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;{</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;end_key_cache&quot;</span>);</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>, (<span class="stringliteral">&quot;key_cache: 0x%lx&quot;</span>, (<span class="keywordtype">long</span>) keycache));</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160; </div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#a2d990f1c0bd095fcbac9c6596274be55">DBUG_VOID_RETURN</a>;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &gt; 0)</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  {</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>)</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      <a class="code" href="../../db/da9/my__sys_8h.html#aba32e671624503b488323bcbd0454bef">my_large_free</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;      <a class="code" href="../../db/da9/my__sys_8h.html#a3a3ddffcaadb60b7715c9889f8c56afb">my_free</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>);</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>= -1;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="comment">/* Reset blocks_changed to be safe if flush_all_key_blocks is called */</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">blocks_changed</a>= 0;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  }</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;status&quot;</span>, (<span class="stringliteral">&quot;used: %lu  changed: %lu  w_requests: %lu  &quot;</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                        <span class="stringliteral">&quot;writes: %lu  r_requests: %lu  reads: %lu&quot;</span>,</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">global_blocks_changed</a>,</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                        (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>,</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                        (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>,</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                        (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>,</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                        (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>));</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160; </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">    Reset these values to be able to detect a disabled key cache.</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">    See Bug#44068 (RESTORE can disable the MyISAM Key Cache).</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>= 0;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a>= 0;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160; </div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="keywordflow">if</span> (cleanup)</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <a class="code" href="../../de/d55/group___thread__instrumentation.html#ga37298c942ab1882a74ed52b787605132">mysql_mutex_destroy</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>= 0;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8ee571cefdea70da535b27a8d27f4885">KEYCACHE_DEBUG_CLOSE</a>;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  }</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a2d990f1c0bd095fcbac9c6596274be55">DBUG_VOID_RETURN</a>;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;} <span class="comment">/* end_key_cache */</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160; </div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160; </div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment">  Link a thread into double-linked queue of waiting threads.</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="comment">    link_into_queue()</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="comment">      wqueue              pointer to the queue structure</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="comment">      thread              pointer to the thread to be added to the queue</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">    Queue is represented by a circular list of the thread structures</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="comment">    The list is double-linked of the type (**prev,*next), accessed by</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="comment">    a pointer to the last element.</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">  788</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">link_into_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue,</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                                   <span class="keyword">struct</span> <a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread)</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;{</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a> &amp;&amp; !thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>);</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  <span class="keywordflow">if</span> (! (last= wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>))</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  {</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">/* Queue is empty */</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= thread;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>= &amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  {</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>= last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>= &amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= thread;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  }</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= thread;</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;}</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment">  Unlink a thread from double-linked queue of waiting threads</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="comment">    unlink_from_queue()</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="comment">      wqueue              pointer to the queue structure</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="comment">      thread              pointer to the thread to be removed from the queue</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment">    See NOTES for link_into_queue</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160; </div>
<div class="line"><a name="l00825"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aacb004d165a9f0075595fa689016ebc7">  825</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aacb004d165a9f0075595fa689016ebc7">unlink_from_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue,</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                                     <span class="keyword">struct</span> <a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread)</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;{</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unlink_from_queue&quot;</span>, (<span class="stringliteral">&quot;thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a> &amp;&amp; thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keywordflow">if</span> (thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a> == thread)</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="comment">/* The queue contains only one member */</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  {</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>= thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>;</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    *thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>=thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> (wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a> == thread)</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a201eb06374e27d8a1f76f1af79813571">STRUCT_PTR</a>(<span class="keyword">struct</span> <a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a>, <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>,</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                                      thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  }</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">    This makes it easier to see it&#39;s not in a chain during debugging.</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment">    And some DBUG_ASSERT() rely on it.</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;}</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160; </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="comment">  Add a thread to single-linked queue of waiting threads</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment">    wait_on_queue()</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="comment">      wqueue            Pointer to the queue structure.</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="comment">      mutex             Cache_lock to acquire after awake.</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="comment">    Queue is represented by a circular list of the thread structures</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="comment">    The list is single-linked of the type (*next), accessed by a pointer</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">    to the last element.</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="comment">    The function protects against stray signals by verifying that the</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="comment">    current thread is unlinked from the queue when awaking. However,</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="comment">    since several threads can wait for the same event, it might be</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="comment">    necessary for the caller of the function to check again if the</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="comment">    condition for awake is indeed matched.</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160; </div>
<div class="line"><a name="l00875"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">  875</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue,</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                          <a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *<a class="code" href="../../de/d9e/structst__my__thread__var.html#aa65ed44b8f48d67dd074ff4139ea1ee2">mutex</a>)</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;{</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread= <a class="code" href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a>;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160; </div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="comment">/* Add to queue. */</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>);</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">prev</a>); <span class="comment">/* Not required, but must be true anyway. */</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keywordflow">if</span> (! (last= wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>))</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= thread;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;  {</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= thread;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  }</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= thread;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160; </div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="comment">    Wait until thread is removed from queue by the signalling thread.</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="comment">    The loop protects against stray signals.</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;  {</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;wait&quot;</span>, (<span class="stringliteral">&quot;suspend thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>, <a class="code" href="../../de/d9e/structst__my__thread__var.html#aa65ed44b8f48d67dd074ff4139ea1ee2">mutex</a>);</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;  }</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;  <span class="keywordflow">while</span> (thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>);</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;}</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160; </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="comment">  Remove all threads from queue signaling them to proceed</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="comment">    release_whole_queue()</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="comment">      wqueue            pointer to the queue structure</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="comment">    See notes for wait_on_queue().</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="comment">    When removed from the queue each thread is signaled via condition</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="comment">    variable thread-&gt;suspend.</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160; </div>
<div class="line"><a name="l00922"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">  922</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue)</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;{</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160; </div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="comment">/* Queue may be empty. */</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  <span class="keywordflow">if</span> (!(last= wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>))</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160; </div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>= last-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  {</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    thread=<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;release_whole_queue: signal&quot;</span>,</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                        (<span class="stringliteral">&quot;thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">/* Signal the thread. */</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>);</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">/* Take thread from queue. */</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>=thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  }</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  <span class="keywordflow">while</span> (thread != last);</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160; </div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="comment">/* Now queue is definitely empty. */</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;}</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160; </div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160; </div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="comment">  Unlink a block from the chain of dirty/clean blocks</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160; </div>
<div class="line"><a name="l00955"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">  955</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;{</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed)</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed-&gt;prev_changed= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160; </div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment">    This makes it easier to see it&#39;s not in a chain during debugging.</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="comment">    And some DBUG_ASSERT() rely on it.</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;}</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160; </div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160; </div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="comment">  Link a block into the chain of dirty/clean blocks</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160; </div>
<div class="line"><a name="l00977"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">  977</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">link_changed</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **phead)</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;{</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed);</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed= phead;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed= *phead))</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    (*phead)-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a0c8c850da8a98c38513e6300e9bf73ca">prev_changed</a>= &amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  *phead= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;}</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160; </div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160; </div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">  Link a block in a chain of clean blocks of a file.</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">    link_to_file_list()</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">      keycache      Key cache handle</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment">      block             Block to relink</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment">      file              File to be linked to</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="comment">      unlink            If to unlink first</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment">  DESCRIPTION</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="comment">    Unlink a block from whichever chain it is linked in, if it&#39;s</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="comment">    asked for, and link it to the chain of clean blocks of the</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="comment">    specified file.</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="comment">  NOTE</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="comment">    Please do never set/clear BLOCK_CHANGED outside of</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="comment">    link_to_file_list() or link_to_changed_list().</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="comment">    You would risk to damage correct counting of changed blocks</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="comment">    and to find blocks in the wrong hash.</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">    void</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a"> 1013</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                              <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <span class="keywordtype">int</span> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>,</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                              <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>)</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;{</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>)</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">link_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)]);</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>)</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  {</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">blocks_changed</a>--;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">global_blocks_changed</a>--;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;  }</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;}</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160; </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160; </div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="comment">  Re-link a block from the clean chain to the dirty chain of a file.</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">    link_to_changed_list()</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">      keycache      key cache handle</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">      block             block to relink</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">  DESCRIPTION</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">    Unlink a block from the chain of clean blocks of a file</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">    and link it to the chain of dirty blocks of the same file.</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">  NOTE</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">    Please do never set/clear BLOCK_CHANGED outside of</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment">    link_to_file_list() or link_to_changed_list().</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="comment">    You would risk to damage correct counting of changed blocks</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment">    and to find blocks in the wrong hash.</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment">    void</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160; </div>
<div class="line"><a name="l01054"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ae31bae037244419366e24306ddaf78d5"> 1054</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae31bae037244419366e24306ddaf78d5">link_to_changed_list</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                                 <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;{</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>));</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160; </div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">link_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>,</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;               &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file)]);</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|=<a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">blocks_changed</a>++;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">global_blocks_changed</a>++;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;}</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160; </div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160; </div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="comment">  Link a block to the LRU chain at the beginning or at the end of</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="comment">  one of two parts.</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">    link_block()</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">      block               pointer to the block to link to the LRU chain</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment">      hot                 &lt;-&gt; to link the block into the hot subchain</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="comment">      at_end              &lt;-&gt; to link the block at the end of the subchain</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment">    The LRU ring is represented by a circular list of block structures.</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">    The list is double-linked of the type (**prev,*next) type.</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment">    The LRU ring is divided into two parts - hot and warm.</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment">    There are two pointers to access the last blocks of these two</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="comment">    parts. The beginning of the warm part follows right after the</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="comment">    end of the hot part.</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="comment">    Only blocks of the warm part can be used for eviction.</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment">    The first block from the beginning of this subchain is always</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="comment">    taken for eviction (keycache-&gt;last_used-&gt;next)</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="comment">    LRU chain:       +------+   H O T    +------+</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="comment">                +----| end  |----...&lt;----| beg  |----+</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="comment">                |    +------+last        +------+    |</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="comment">                v&lt;-link in latest hot (new end)      |</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;<span class="comment">                |     link in latest warm (new end)-&gt;^</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;<span class="comment">                |    +------+  W A R M   +------+    |</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;<span class="comment">                +----| beg  |----&gt;...----| end  |----+</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;<span class="comment">                     +------+            +------+ins</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="comment">                  first for eviction</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="comment">    It is also possible that the block is selected for eviction and thus</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="comment">    not linked in the LRU ring.</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160; </div>
<div class="line"><a name="l01109"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a4d1a6ff619e0c008f6fb923dbd0760d8"> 1109</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4d1a6ff619e0c008f6fb923dbd0760d8">link_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> hot,</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                       <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> at_end)</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;{</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *ins;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **<a class="code" href="../../de/d17/lf_8h.html#ada1f7cc38a0951ca7a4f263a30d43984">pins</a>;</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160; </div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>) == (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link); <span class="comment">/*backptr to block NULL from free_block()*/</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160; </div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keywordflow">if</span> (!hot &amp;&amp; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>)</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  {</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    <span class="comment">/* Signal that in the LRU warm sub-chain an available block has appeared */</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last_thread=</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                               keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *first_thread= last_thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *next_thread= first_thread;</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link= (<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *) first_thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <span class="keyword">struct</span> <a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    {</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;      thread= next_thread;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;      next_thread= thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="comment">         We notify about the event all threads that ask</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="comment">         for the same page as the first thread in the queue</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;      <a class="code" href="../../dd/d68/_c_make_lists_8txt.html#a0b5da418382bdd0db6dff439e2863979">if</a> ((<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *) thread-&gt;opt_info == hash_link)</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;      {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;link_block: signal&quot;</span>, (<span class="stringliteral">&quot;thread %ld&quot;</span>, thread-&gt;id));</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(&amp;thread-&gt;suspend);</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aacb004d165a9f0075595fa689016ebc7">unlink_from_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>, thread);</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests++;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      }</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    }</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    <span class="keywordflow">while</span> (thread != last_thread);</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    hash_link-&gt;block= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment">      NOTE: We assigned the block to the hash_link and signalled the</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="comment">      requesting thread(s). But it is possible that other threads runs</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="comment">      first. These threads see the hash_link assigned to a block which</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment">      is assigned to another hash_link and not marked BLOCK_IN_SWITCH.</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="comment">      This can be a problem for functions that do not select the block</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment">      via its hash_link: flush and free. They do only see a block which</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="comment">      is in a &quot;normal&quot; state and don&#39;t know that it will be evicted soon.</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="comment">      We cannot set BLOCK_IN_SWITCH here because only one of the</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="comment">      requesting threads must handle the eviction. All others must wait</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="comment">      for it to complete. If we set the flag here, the threads would not</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="comment">      know who is in charge of the eviction. Without the flag, the first</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="comment">      thread takes the stick and sets the flag.</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="comment">      But we need to note in the block that is has been selected for</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="comment">      eviction. It must not be freed. The evicting thread will not</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="comment">      expect the block in the free list. Before freeing we could also</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment">      check if block-&gt;requests &gt; 1. But I think including another flag</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment">      in the check of block-&gt;status is slightly more efficient and</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">      probably easier to read.</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;link_block: after signaling&quot;</span>);</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;link_block&quot;</span>,</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        (<span class="stringliteral">&quot;linked,unlinked block %u  status=%x  #requests=%u  #available=%u&quot;</span>,</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;         <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>), <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status,</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;         <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">blocks_available</a>));</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  }</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <a class="code" href="../../de/d17/lf_8h.html#ada1f7cc38a0951ca7a4f263a30d43984">pins</a>= hot ? &amp;keycache-&gt;used_ins : &amp;keycache-&gt;used_last;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  ins= *<a class="code" href="../../de/d17/lf_8h.html#ada1f7cc38a0951ca7a4f263a30d43984">pins</a>;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="keywordflow">if</span> (ins)</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  {</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    ins-&gt;next_used-&gt;prev_used= &amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used= ins-&gt;next_used;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used= &amp;ins-&gt;next_used;</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    ins-&gt;next_used= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    <span class="keywordflow">if</span> (at_end)</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;      *<a class="code" href="../../de/d17/lf_8h.html#ada1f7cc38a0951ca7a4f263a30d43984">pins</a>= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  }</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  {</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <span class="comment">/* The LRU ring is empty. Let the block point to itself. */</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    keycache-&gt;used_last= keycache-&gt;used_ins= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used= &amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  }</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;link_block&quot;</span>);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  keycache-&gt;blocks_available++;</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;link_block&quot;</span>,</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      (<span class="stringliteral">&quot;linked block %u:%1u  status=%x  #requests=%u  #available=%u&quot;</span>,</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;       <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>), at_end, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status,</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;       <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests, keycache-&gt;blocks_available));</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;blocks_available &lt;=</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                       keycache-&gt;blocks_used);</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;}</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160; </div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160; </div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="comment">  Unlink a block from the LRU chain</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="comment">    unlink_block()</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="comment">      block               pointer to the block to unlink from the LRU chain</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="comment">    See NOTES for link_block</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160; </div>
<div class="line"><a name="l01227"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8"> 1227</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;{</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>) == (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link); <span class="comment">/*backptr to block NULL from free_block()*/</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used &amp;&amp;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;              (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used-&gt;prev_used == &amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used) &amp;&amp;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;              (*<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used == <a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used == <a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <span class="comment">/* The list contains only one member */</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">used_ins</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  {</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used-&gt;prev_used= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a> == <a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a201eb06374e27d8a1f76f1af79813571">STRUCT_PTR</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>, next_used, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">used_ins</a> == <a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">used_ins</a>=<a class="code" href="../../d3/d26/mf__keycache_8c.html#a201eb06374e27d8a1f76f1af79813571">STRUCT_PTR</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>, next_used, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;  }</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment">    This makes it easier to see it&#39;s not in a chain during debugging.</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="comment">    And some DBUG_ASSERT() rely on it.</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160; </div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;unlink_block&quot;</span>);</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">blocks_available</a> != 0);</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">blocks_available</a>--;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unlink_block&quot;</span>,</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    (<span class="stringliteral">&quot;unlinked block %u  status=%x   #requests=%u  #available=%u&quot;</span>,</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;     <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>), <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status,</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;     <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">blocks_available</a>));</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;}</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160; </div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160; </div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="comment">  Register requests for a block.</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="comment">    reg_requests()</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="comment">      keycache          Pointer to a key cache data structure.</span></div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="comment">      block             Pointer to the block to register a request on.</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;<span class="comment">      count             Number of requests. Always 1.</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="comment">  NOTE</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;<span class="comment">    The first request unlinks the block from the LRU ring. This means</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;<span class="comment">    that it is protected against eveiction.</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;<span class="comment">    void</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c"> 1285</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <span class="keywordtype">int</span> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>)</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;{</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160; </div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests)</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests+=<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;}</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160; </div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160; </div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="comment">  Unregister request for a block</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="comment">  linking it to the LRU chain if it&#39;s the last request</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="comment">    unreg_request()</span></div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="comment">    keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment">    block               pointer to the block to link to the LRU chain</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="comment">    at_end              &lt;-&gt; to link the block at the end of the LRU chain</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="comment">    none</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment">    Every linking to the LRU ring decrements by one a special block</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="comment">    counter (if it&#39;s positive). If the at_end parameter is TRUE the block is</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">    added either at the end of warm sub-chain or at the end of hot sub-chain.</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">    It is added to the hot subchain if its counter is zero and number of</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">    blocks in warm sub-chain is not less than some low limit (determined by</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="comment">    the division_limit parameter). Otherwise the block is added to the warm</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="comment">    sub-chain. If the at_end parameter is FALSE the block is always added</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment">    at beginning of the warm sub-chain.</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="comment">    Thus a warm block can be promoted to the hot sub-chain when its counter</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment">    becomes zero for the first time.</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="comment">    At the same time  the block at the very beginning of the hot subchain</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="comment">    might be moved to the beginning of the warm subchain if it stays untouched</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;<span class="comment">    for a too long time (this time is determined by parameter age_threshold).</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="comment">    It is also possible that the block is selected for eviction and thus</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;<span class="comment">    not linked in the LRU ring.</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160; </div>
<div class="line"><a name="l01328"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9"> 1328</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                          <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <span class="keywordtype">int</span> at_end)</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;{</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link); <span class="comment">/*backptr to block NULL from free_block()*/</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="comment">    Unregister the request, but do not link erroneous blocks into the</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="comment">    LRU ring.</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <span class="keywordflow">if</span> (!--<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests &amp;&amp; !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  {</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> hot;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hits_left)</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hits_left--;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    hot= !<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hits_left &amp;&amp; at_end &amp;&amp;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a> &gt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a5747065352c894e9888321d843039dc2">min_warm_blocks</a>;</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keywordflow">if</span> (hot)</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    {</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a>)</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>--;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada9b0e5b737da218510a23b0d69cd4ccf0">BLOCK_HOT</a>;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unreg_request&quot;</span>, (<span class="stringliteral">&quot;#warm_blocks: %lu&quot;</span>,</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                           keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>));</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    }</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4d1a6ff619e0c008f6fb923dbd0760d8">link_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, hot, (<a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a>)at_end);</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;last_hit_time= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6d94ce3a7dd45735a3791f499fac1b48">keycache_time</a>;</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6d94ce3a7dd45735a3791f499fac1b48">keycache_time</a>++;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">      At this place, the block might be in the LRU ring or not. If an</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="comment">      evicter was waiting for a block, it was selected for eviction and</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="comment">      not linked in the LRU ring.</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160; </div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;<span class="comment">      Check if we should link a hot block to the warm block sub-chain.</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;<span class="comment">      It is possible that we select the same block as above. But it can</span></div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="comment">      also be another block. In any case a block from the LRU ring is</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="comment">      selected. In other words it works even if the above block was</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="comment">      selected for eviction and not linked in the LRU ring. Since this</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="comment">      happens only if the LRU ring is empty, the block selected below</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;<span class="comment">      would be NULL and the rest of the function skipped.</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">used_ins</a>;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a> &amp;&amp; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6d94ce3a7dd45735a3791f499fac1b48">keycache_time</a> - <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;last_hit_time &gt;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#acdc4f979ecbe74d9625194ab8f96d596">age_threshold</a>)</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    {</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4d1a6ff619e0c008f6fb923dbd0760d8">link_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 0, 0);</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature != <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a>)</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;      {</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>++;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a>;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;      }</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unreg_request&quot;</span>, (<span class="stringliteral">&quot;#warm_blocks: %lu&quot;</span>,</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;                           keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>));</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    }</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  }</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;}</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160; </div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="comment">  Remove a reader of the page in block</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160; </div>
<div class="line"><a name="l01395"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979"> 1395</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;{</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;requests);</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160; </div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;  <span class="keywordflow">if</span> (! --<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;requests &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar)</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar);</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;}</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160; </div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160; </div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;<span class="comment">  Wait until the last reader of the page in block</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="comment">  signals on its termination</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160; </div>
<div class="line"><a name="l01414"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a36c6785bea71fce1b852570282a32897"> 1414</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a36c6785bea71fce1b852570282a32897">wait_for_readers</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                             <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;{</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread= <a class="code" href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a>;</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>)));</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;  <span class="comment">/* Linked in file_blocks or changed_blocks hash. */</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  <span class="comment">/* Not linked in LRU ring. */</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;  <span class="keywordflow">while</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;requests)</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  {</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;wait_for_readers: wait&quot;</span>,</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                        (<span class="stringliteral">&quot;suspend thread %ld  block %u&quot;</span>,</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                         thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>, <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>)));</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="comment">/* There must be no other waiter. We have no queue here. */</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar= &amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>;</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  }</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;}</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160; </div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160; </div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;<span class="comment">  Add a hash link to a bucket in the hash_table</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160; </div>
<div class="line"><a name="l01445"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a5caec46b7508fa71623331f57a65ca94"> 1445</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5caec46b7508fa71623331f57a65ca94">link_hash</a>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> **start, <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link)</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;{</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="keywordflow">if</span> (*start)</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    (*start)-&gt;prev= &amp;hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>= *start;</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>= start;</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  *start= hash_link;</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;}</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160; </div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160; </div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;<span class="comment">  Remove a hash link from the hash table</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160; </div>
<div class="line"><a name="l01459"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc"> 1459</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc">unlink_hash</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link)</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;{</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unlink_hash&quot;</span>, (<span class="stringliteral">&quot;fd: %u  pos_ %lu  #requests=%u&quot;</span>,</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;      (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>, hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>));</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a> == 0);</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <span class="keywordflow">if</span> ((*hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>= hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>))</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>= hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>;</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160; </div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">waiting_for_hash_link</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>)</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  {</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;    <span class="comment">/* Signal that a free hash link has appeared */</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last_thread=</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                               keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">waiting_for_hash_link</a>.<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>;</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *first_thread= last_thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *next_thread= first_thread;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *first_page= (<a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *) (first_thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>);</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread;</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160; </div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>= first_page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">file</a>;</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>= first_page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">filepos</a>;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;    {</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;      <a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *page;</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;      thread= next_thread;</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;      page= (<a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *) thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>;</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;      next_thread= thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment">         We notify about the event all threads that ask</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">         for the same page as the first thread in the queue</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;      <a class="code" href="../../dd/d68/_c_make_lists_8txt.html#a0b5da418382bdd0db6dff439e2863979">if</a> (page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">file</a> == hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a> &amp;&amp; page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">filepos</a> == hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>)</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;      {</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;unlink_hash: signal&quot;</span>, (<span class="stringliteral">&quot;thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>);</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aacb004d165a9f0075595fa689016ebc7">unlink_from_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">waiting_for_hash_link</a>, thread);</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;      }</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;    }</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;    <span class="keywordflow">while</span> (thread != last_thread);</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5caec46b7508fa71623331f57a65ca94">link_hash</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#afced45e5c89364d6703389c01e68f55f">KEYCACHE_HASH</a>(hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>,</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                             hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>)],</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;              hash_link);</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  }</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>;</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>= hash_link;</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;}</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160; </div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160; </div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="comment">  Get the hash link for a page</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160; </div>
<div class="line"><a name="l01512"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a9136bb4caea5054f49fee78aad69f3b2"> 1512</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *<a class="code" href="../../d3/d26/mf__keycache_8c.html#a9136bb4caea5054f49fee78aad69f3b2">get_hash_link</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                                <span class="keywordtype">int</span> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> filepos)</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;{</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a5baef0dcbf233902f75830ce890d9ba6">reg1</a> <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link, **start;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  <span class="keywordtype">int</span> cnt;</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160; </div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;get_hash_link&quot;</span>, (<span class="stringliteral">&quot;fd: %u  pos: %lu&quot;</span>,</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                      (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos));</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160; </div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;restart:</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment">     Find the bucket in the hash table for the pair (file, filepos);</span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;<span class="comment">     start contains the head of the bucket list,</span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="comment">     hash_link points to the first member of the list</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;  hash_link= *(start= &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">hash_root</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#afced45e5c89364d6703389c01e68f55f">KEYCACHE_HASH</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, filepos)]);</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  cnt= 0;</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="comment">/* Look for an element for the pair (file, filepos) in the bucket chain */</span></div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  <span class="keywordflow">while</span> (hash_link &amp;&amp;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;         (hash_link-&gt;diskpos != filepos || hash_link-&gt;file != <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>))</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  {</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    hash_link= hash_link-&gt;next;</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    cnt++;</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    <span class="keywordflow">if</span> (! (cnt &lt;= keycache-&gt;hash_links_used))</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    {</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;      <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;      <span class="keywordflow">for</span> (i=0, hash_link= *start ;</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;           i &lt; cnt ; i++, hash_link= hash_link-&gt;next)</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;      {</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;get_hash_link&quot;</span>, (<span class="stringliteral">&quot;fd: %u  pos: %lu&quot;</span>,</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;            (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) hash_link-&gt;file,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hash_link-&gt;diskpos));</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;      }</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;    }</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(cnt &lt;= keycache-&gt;hash_links_used);</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;  }</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;  <span class="keywordflow">if</span> (! hash_link)</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;  {</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <span class="comment">/* There is no hash link in the hash table for the pair (file, filepos) */</span></div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>)</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    {</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;      hash_link= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">free_hash_list</a>= hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    }</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a01c4fedeb76ae5e06f29f7d1eeba7583">hash_links_used</a> &lt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a>)</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    {</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;      hash_link= &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">hash_link_root</a>[keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a01c4fedeb76ae5e06f29f7d1eeba7583">hash_links_used</a>++];</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    }</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    {</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;      <span class="comment">/* Wait for a free hash link */</span></div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread= <a class="code" href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a>;</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;      <a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> page;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;get_hash_link&quot;</span>, (<span class="stringliteral">&quot;waiting&quot;</span>));</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;      page.<a class="code" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">file</a>= <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>;</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;      page.<a class="code" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">filepos</a>= filepos;</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;      thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= (<span class="keywordtype">void</span> *) &amp;page;</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">link_into_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">waiting_for_hash_link</a>, thread);</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;get_hash_link: wait&quot;</span>,</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;                        (<span class="stringliteral">&quot;suspend thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>,</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;                                 &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;      thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;      <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    }</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    hash_link-&gt;file= <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>;</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    hash_link-&gt;diskpos= filepos;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5caec46b7508fa71623331f57a65ca94">link_hash</a>(start, hash_link);</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;  }</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <span class="comment">/* Register the request for the page */</span></div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  hash_link-&gt;requests++;</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160; </div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;  <span class="keywordflow">return</span> hash_link;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;}</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160; </div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160; </div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="comment">  Get a block for the file page requested by a keycache read/write operation;</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="comment">  If the page is not in the cache return a free block, if there is none</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="comment">  return the lru block after saving its buffer if the page is dirty.</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="comment">    find_key_block()</span></div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="comment">      file                handler for the file to read page from</span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="comment">      filepos             position of the page in the file</span></div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="comment">      init_hits_left      how initialize the block counter for the page</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="comment">      wrmode              &lt;-&gt; get for writing</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;<span class="comment">      page_st        out  {PAGE_READ,PAGE_TO_BE_READ,PAGE_WAIT_TO_BE_READ}</span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="comment">    Pointer to the found block if successful, 0 - otherwise</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment">    For the page from file positioned at filepos the function checks whether</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="comment">    the page is in the key cache specified by the first parameter.</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">    If this is the case it immediately returns the block.</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment">    If not, the function first chooses  a block for this page. If there is</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="comment">    no not used blocks in the key cache yet, the function takes the block</span></div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="comment">    at the very beginning of the warm sub-chain. It saves the page in that</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="comment">    block if it&#39;s dirty before returning the pointer to it.</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="comment">    The function returns in the page_st parameter the following values:</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="comment">      PAGE_READ         - if page already in the block,</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="comment">      PAGE_TO_BE_READ   - if it is to be read yet by the current thread</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="comment">      WAIT_TO_BE_READ   - if it is to be read by another thread</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="comment">    If an error occurs THE BLOCK_ERROR bit is set in the block status.</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="comment">    It might happen that there are no blocks in LRU chain (in warm part) -</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="comment">    all blocks  are unlinked for some read/write operations. Then the function</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="comment">    waits until first of this operations links any block back.</span></div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160; </div>
<div class="line"><a name="l01629"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293"> 1629</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293">find_key_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;                                  <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> filepos,</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                                  <span class="keywordtype">int</span> init_hits_left,</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                                  <span class="keywordtype">int</span> wrmode, <span class="keywordtype">int</span> *page_st)</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;{</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;  <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link;</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 0;</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;  <span class="keywordtype">int</span> page_status;</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160; </div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>);</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;find_key_block:begin&quot;</span>);</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>, (<span class="stringliteral">&quot;fd: %d  pos: %lu  wrmode: %d&quot;</span>,</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;                       <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos, wrmode));</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>, (<span class="stringliteral">&quot;fd: %d  pos: %lu  wrmode: %d&quot;</span>,</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;                                         <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos,</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                                         wrmode));</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF) &amp;&amp; defined(EXTRA_DEBUG)</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;check_keycache2&quot;</span>,</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;start of find_key_block&quot;</span>, 0););</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160; </div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;restart:</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;<span class="comment">    If the flush phase of a resize operation fails, the cache is left</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="comment">    unusable. This will be detected only after &quot;goto restart&quot;.</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;  <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>)</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160; </div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="comment">    Find the hash_link for the requested file block (file, filepos). We</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="comment">    do always get a hash_link here. It has registered our request so</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="comment">    that no other thread can use it for another file block until we</span></div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="comment">    release the request (which is done by remove_reader() usually). The</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="comment">    hash_link can have a block assigned to it or not. If there is a</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="comment">    block, it may be assigned to this hash_link or not. In cases where a</span></div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="comment">    block is evicted from the cache, it is taken from the LRU ring and</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="comment">    referenced by the new hash_link. But the block can still be assigned</span></div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="comment">    to its old hash_link for some time if it needs to be flushed first,</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="comment">    or if there are other threads still reading it.</span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="comment">    Summary:</span></div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="comment">      hash_link is always returned.</span></div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;<span class="comment">      hash_link-&gt;block can be:</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="comment">      - NULL or</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="comment">      - not assigned to this hash_link or</span></div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="comment">      - assigned to this hash_link. If assigned, the block can have</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="comment">        - invalid data (when freshly assigned) or</span></div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="comment">        - valid data. Valid data can be</span></div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;<span class="comment">          - changed over the file contents (dirty) or</span></div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;<span class="comment">          - not changed (clean).</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;  hash_link= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9136bb4caea5054f49fee78aad69f3b2">get_hash_link</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, filepos);</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a> == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp; (hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a> == filepos));</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160; </div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;  page_status= -1;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;  <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>= hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>) &amp;&amp;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link &amp;&amp; (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>))</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;  {</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    <span class="comment">/* Assigned block with valid (changed or unchanged) contents. */</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    page_status= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;  }</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="comment">    else (page_status == -1)</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="comment">      - block == NULL or</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="comment">      - block not assigned to this hash_link or</span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="comment">      - block assigned but not yet read from file (invalid data).</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160; </div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;  {</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;    <span class="comment">/* This is a request during a resize operation */</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160; </div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    {</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;      <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread;</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160; </div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="comment">        The file block is not in the cache. We don&#39;t need it in the</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="comment">        cache: we are going to read or write directly to file. Cancel</span></div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="comment">        the request. We can simply decrement hash_link-&gt;requests because</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="comment">        we did not release cache_lock since increasing it. So no other</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="comment">        thread can wait for our request to become released.</span></div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;      <span class="keywordflow">if</span> (hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a> == 1)</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;      {</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="comment">          We are the only one to request this hash_link (this file/pos).</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="comment">          Free the hash_link.</span></div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>--;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc">unlink_hash</a>(keycache, hash_link);</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      }</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160; </div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="comment">        More requests on the hash_link. Someone tries to evict a block</span></div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="comment">        for this hash_link (could have started before resizing started).</span></div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;<span class="comment">        This means that the LRU ring is empty. Otherwise a block could</span></div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;<span class="comment">        be assigned immediately. Behave like a thread that wants to</span></div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;<span class="comment">        evict a block for this file/pos. Add to the queue of threads</span></div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="comment">        waiting for a block. Wait until there is one assigned.</span></div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;<span class="comment">        Refresh the request on the hash-link so that it cannot be reused</span></div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="comment">        for another file/pos.</span></div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;      thread= <a class="code" href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a>;</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;      thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= (<span class="keywordtype">void</span> *) hash_link;</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">link_into_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>, thread);</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;      <span class="keywordflow">do</span></div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;      {</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block: wait&quot;</span>,</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;                            (<span class="stringliteral">&quot;suspend thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>,</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;                                   &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;      } <span class="keywordflow">while</span> (thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>);</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;      thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="comment">        A block should now be assigned to the hash_link. But it may</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;<span class="comment">        still need to be evicted. Anyway, we should re-check the</span></div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="comment">        situation. page_status must be set correctly.</span></div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;      hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>--;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;      <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    } <span class="comment">/* end of if (!block) */</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160; </div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;<span class="comment">      There is a block for this file/pos in the cache. Register a</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;<span class="comment">      request on it. This unlinks it from the LRU ring (if it is there)</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;<span class="comment">      and hence protects it against eviction (if not already in</span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="comment">      eviction). We need this for returning the block to the caller, for</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="comment">      calling remove_reader() (for debugging purposes), and for calling</span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="comment">      free_block(). The only case where we don&#39;t need the request is if</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="comment">      the block is in eviction. In that case we have to unregister the</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;<span class="comment">      request later.</span></div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160; </div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="keywordflow">if</span> (page_status != <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>)</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    {</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="comment">        - block not assigned to this hash_link or</span></div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="comment">        - block assigned but not yet read from file (invalid data).</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="comment">        This must be a block in eviction. It will be read soon. We need</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="comment">        to wait here until this happened. Otherwise the caller could</span></div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="comment">        access a wrong block or a block which is in read. While waiting</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="comment">        we cannot lose hash_link nor block. We have registered a request</span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">        on the hash_link. Everything can happen to the block but changes</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment">        in the hash_link -&gt; block relationship. In other words:</span></div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="comment">        everything can happen to the block but free or another completed</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="comment">        eviction.</span></div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="comment">        Note that we bahave like a secondary requestor here. We just</span></div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="comment">        cannot return with PAGE_WAIT_TO_BE_READ. This would work for</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="comment">        read requests and writes on dirty blocks that are not in flush</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment">        only. Waiting here on COND_FOR_REQUESTED works in all</span></div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment">        situations.</span></div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link != hash_link) &amp;&amp;</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;                   (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>))) ||</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                  ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link) &amp;&amp;</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                   !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>)));</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>], &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="comment">        Here we can trust that the block has been assigned to this</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="comment">        hash_link (block-&gt;hash_link == hash_link) and read into the</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="comment">        buffer (BLOCK_READ). The worst things possible here are that the</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="comment">        block is in free (BLOCK_REASSIGNED). But the block is still</span></div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="comment">        assigned to the hash_link. The freeing thread waits until we</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="comment">        release our request on the hash_link. The block must not be</span></div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="comment">        again in eviction because we registered an request on it before</span></div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="comment">        starting to wait.</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link);</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>)));</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    }</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="comment">      The block is in the cache. Assigned to the hash_link. Valid data.</span></div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="comment">      Note that in case of page_st == PAGE_READ, the block can be marked</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="comment">      for eviction. In any case it can be marked for freeing.</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160; </div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <span class="keywordflow">if</span> (!wrmode)</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    {</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      <span class="comment">/* A reader can just read the block. */</span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;      *page_st= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a> == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp;</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;                  (hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a> == filepos) &amp;&amp;</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;                  (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link));</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;      <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;    }</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160; </div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="comment">      This is a writer. No two writers for the same block can exist.</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="comment">      This must be assured by locks outside of the key cache.</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160; </div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>)</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    {</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="comment">        Wait until the block is flushed to file. Do not release the</span></div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="comment">        request on the hash_link yet to prevent that the block is freed</span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="comment">        or reassigned while we wait. While we wait, several things can</span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="comment">        happen to the block, including another flush. But the block</span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="comment">        cannot be reassigned to another hash_link until we release our</span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">        request on it. But it can be marked BLOCK_REASSIGNED from free</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="comment">        or eviction, while they wait for us to release the hash_link.</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>], &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="comment">        If the flush phase failed, the resize could have finished while</span></div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;<span class="comment">        we waited here.</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;      <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;      {</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;        <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;      }</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link);</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    }</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160; </div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>)</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    {</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;<span class="comment">        We want to write a block with changed contents. If the cache</span></div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;<span class="comment">        block size is bigger than the callers block size (e.g. MyISAM),</span></div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;<span class="comment">        the caller may replace part of the block only. Changes of the</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="comment">        other part of the block must be preserved. Since the block has</span></div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;<span class="comment">        not yet been selected for flush, we can still add our changes.</span></div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;      *page_st= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a> == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;                  (hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a> == filepos) &amp;&amp;</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                  (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link));</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;      <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    }</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160; </div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;<span class="comment">      This is a write request for a clean block. We do not want to have</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="comment">      new dirty blocks in the cache while resizing. We will free the</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;<span class="comment">      block and write directly to file. If the block is in eviction or</span></div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;<span class="comment">      in free, we just let it go.</span></div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="comment">      Unregister from the hash_link. This must be done before freeing</span></div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;<span class="comment">      the block. And it must be done if not freeing the block. Because</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;<span class="comment">      we could have waited above, we need to call remove_reader(). Other</span></div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;<span class="comment">      threads could wait for us to release our request on the hash_link.</span></div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160; </div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    <span class="comment">/* If the block is not in eviction and not in free, we can free it. */</span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>)))</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    {</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="comment">        Free block as we are going to write directly to file.</span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="comment">        Although we have an exlusive lock for the updated key part,</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="comment">        the control can be yielded by the current thread as we might</span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;<span class="comment">        have unfinished readers of other key parts in the block</span></div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="comment">        buffer. Still we are guaranteed not to have any readers</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="comment">        of the key part we are writing into until the block is</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment">        removed from the cache as we set the BLOCK_REASSIGNED</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="comment">        flag (see the code below that handles reading requests).</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    }</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    {</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;<span class="comment">        The block will be evicted/freed soon. Don&#39;t touch it in any way.</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="comment">        Unregister the request that we registered above.</span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160; </div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;<span class="comment">        The block is still assigned to the hash_link (the file/pos that</span></div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;<span class="comment">        we are going to write to). Wait until the eviction/free is</span></div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;<span class="comment">        complete. Otherwise the direct write could complete before all</span></div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;<span class="comment">        readers are done with the block. So they could read outdated</span></div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;<span class="comment">        data.</span></div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;<span class="comment">        Since we released our request on the hash_link, it can be reused</span></div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;<span class="comment">        for another file/pos. Hence we cannot just check for</span></div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;<span class="comment">        block-&gt;hash_link == hash_link. As long as the resize is</span></div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;<span class="comment">        proceeding the block cannot be reassigned to the same file/pos</span></div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;<span class="comment">        again. So we can terminate the loop when the block is no longer</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;<span class="comment">        assigned to this file/pos.</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;      <span class="keywordflow">do</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;      {</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>],</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;                      &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="comment">          If the flush phase failed, the resize could have finished</span></div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="comment">          while we waited here.</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;        <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;          <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;      } <span class="keywordflow">while</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp;</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;               (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp;</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;               (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos));</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    }</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;  }</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160; </div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;  <span class="keywordflow">if</span> (page_status == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a> &amp;&amp;</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;      (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;                        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>)))</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;  {</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="comment">      This is a request for a block to be removed from cache. The block</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="comment">      is assigned to this hash_link and contains valid data, but is</span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">      marked for eviction or to be freed. Possible reasons why it has</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="comment">      not yet been evicted/freed can be a flush before reassignment</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">      (BLOCK_IN_SWITCH), readers of the block have not finished yet</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment">      (BLOCK_REASSIGNED), or the evicting thread did not yet awake after</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">      the block has been selected for it (BLOCK_IN_EVICTION).</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160; </div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;                        (<span class="stringliteral">&quot;request for old page in block %u &quot;</span></div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;                         <span class="stringliteral">&quot;wrmode: %d  block-&gt;status: %d&quot;</span>,</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;                         <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>), wrmode, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status));</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="comment">       Only reading requests can proceed until the old dirty page is flushed,</span></div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="comment">       all others are to be suspended, then resubmitted</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="keywordflow">if</span> (!wrmode &amp;&amp; !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>))</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    {</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="comment">        This is a read request and the block not yet reassigned. We can</span></div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="comment">        register our request and proceed. This unlinks the block from</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="comment">        the LRU ring and protects it against eviction.</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    }</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    {</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;<span class="comment">        Either this is a write request for a block that is in eviction</span></div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;<span class="comment">        or in free. We must not use it any more. Instead we must evict</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="comment">        another block. But we cannot do this before the eviction/free is</span></div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;<span class="comment">        done. Otherwise we would find the same hash_link + block again</span></div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="comment">        and again.</span></div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;<span class="comment">        Or this is a read request for a block in eviction/free that does</span></div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;<span class="comment">        not require a flush, but waits for readers to finish with the</span></div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;<span class="comment">        block. We do not read this block to let the eviction/free happen</span></div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;<span class="comment">        as soon as possible. Again we must wait so that we don&#39;t find</span></div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;<span class="comment">        the same hash_link + block again and again.</span></div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>);</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;      hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a>--;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;                          (<span class="stringliteral">&quot;request waiting for old page to be saved&quot;</span>));</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>], &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;                          (<span class="stringliteral">&quot;request for old page resubmitted&quot;</span>));</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="comment">        The block is no longer assigned to this hash_link.</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;<span class="comment">        Get another one.</span></div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;      <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    }</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  }</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;  {</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment">      This is a request for a new block or for a block not to be removed.</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="comment">      Either</span></div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="comment">      - block == NULL or</span></div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="comment">      - block not assigned to this hash_link or</span></div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;<span class="comment">      - block assigned but not yet read from file,</span></div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;<span class="comment">      or</span></div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;<span class="comment">      - block assigned with valid (changed or unchanged) data and</span></div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="comment">      - it will not be reassigned/freed.</span></div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;    <span class="keywordflow">if</span> (! <a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    {</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;      <span class="comment">/* No block is assigned to the hash_link yet. */</span></div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;      <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a>)</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;      {</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;        <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>)</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;        {</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;          <span class="comment">/* There is a block in the free list. */</span></div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        }</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;        {</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;          <span class="keywordtype">size_t</span> block_mem_offset;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;          <span class="comment">/* There are some never used blocks, take first of them */</span></div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> &lt;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;                      (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>);</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>= &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>[keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>];</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;          block_mem_offset= </div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;           ((size_t) keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>) * keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer= <a class="code" href="../../d9/df6/my__global_8h.html#a633e1ce2fa5c05eb1b11004dd8f8d42a">ADD_TO_PTR</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">block_mem</a>,</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;                                    block_mem_offset,</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;                                    <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*);</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>++;</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;        }</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed);</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed);</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status);</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a>--;</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>;</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length= 0;</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>;</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests= 1;</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550">BLOCK_COLD</a>;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hits_left= init_hits_left;</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;last_hit_time= 0;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link= hash_link;</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;        hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, 0);</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;        page_status= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>;</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                            (<span class="stringliteral">&quot;got free or never used block %u&quot;</span>,</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                             <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>)));</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;      }</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;      {</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="comment">          There are no free blocks and no never used blocks, use a block</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="comment">          from the LRU ring.</span></div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160; </div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        <span class="keywordflow">if</span> (! keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>)</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        {</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;<span class="comment">            The LRU ring is empty. Wait until a new block is added to</span></div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;<span class="comment">            it. Several threads might wait here for the same hash_link,</span></div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;<span class="comment">            all of them must get the same block. While waiting for a</span></div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;<span class="comment">            block, after a block is selected for this hash_link, other</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="comment">            threads can run first before this one awakes. During this</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;<span class="comment">            time interval other threads find this hash_link pointing to</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="comment">            the block, which is still assigned to another hash_link. In</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;<span class="comment">            this case the block is not marked BLOCK_IN_SWITCH yet, but</span></div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="comment">            it is marked BLOCK_IN_EVICTION.</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160; </div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;          <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread= <a class="code" href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a>;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;          thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= (<span class="keywordtype">void</span> *) hash_link;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">link_into_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">waiting_for_block</a>, thread);</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;          <span class="keywordflow">do</span></div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;          {</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block: wait&quot;</span>,</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;                                (<span class="stringliteral">&quot;suspend thread %ld&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>));</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(&amp;thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">suspend</a>,</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;                                       &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;          }</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;          <span class="keywordflow">while</span> (thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>);</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;          thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;          <span class="comment">/* Assert that block has a request registered. */</span></div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a2861454c5ee71acb232f1dc5eb61b109">requests</a>);</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;          <span class="comment">/* Assert that block is not in LRU ring. */</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a278733a568c53aa510f3de746b5154b4">next_used</a>);</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a77125bee1c76f943553d6d0a4c06f16b">prev_used</a>);</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        }</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160; </div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">          If we waited above, hash_link-&gt;block has been assigned by</span></div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">          link_block(). Otherwise it is still NULL. In the latter case</span></div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">          we need to grab a block from the LRU ring ourselves.</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>= hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>;</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;        <span class="keywordflow">if</span> (! <a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;        {</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;          <span class="comment">/* Select the last block from the LRU ring. */</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a278733a568c53aa510f3de746b5154b4">next_used</a>;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hits_left= init_hits_left;</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;last_hit_time= 0;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;          hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="comment">            Register a request on the block. This unlinks it from the</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="comment">            LRU ring and protects it against eviction.</span></div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>,1);</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="comment">            We do not need to set block-&gt;status|= BLOCK_IN_EVICTION here</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;<span class="comment">            because we will set block-&gt;status|= BLOCK_IN_SWITCH</span></div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;<span class="comment">            immediately without releasing the lock in between. This does</span></div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="comment">            also support debugging. When looking at the block, one can</span></div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="comment">            see if the block has been selected by link_block() after the</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="comment">            LRU ring was empty, or if it was grabbed directly from the</span></div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="comment">            LRU ring in this branch.</span></div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;        }</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160; </div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="comment">          If we had to wait above, there is a small chance that another</span></div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;<span class="comment">          thread grabbed this block for the same file block already. But</span></div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="comment">          in most cases the first condition is true.</span></div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link != hash_link &amp;&amp;</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;        ! (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>) )</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;        {</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;      <span class="comment">/* this is a primary request for a new page */</span></div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160; </div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                        (<span class="stringliteral">&quot;got block %u for new page&quot;</span>, <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>)));</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160; </div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>)</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;          {</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;        <span class="comment">/* The block contains a dirty page - push it out of the cache */</span></div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160; </div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>, (<span class="stringliteral">&quot;block is dirty&quot;</span>));</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>)</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;            {</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;<span class="comment">                The block is marked for flush. If we do not wait here,</span></div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;<span class="comment">                it could happen that we write the block, reassign it to</span></div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;<span class="comment">                another file block, then, before the new owner can read</span></div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;<span class="comment">                the new file block, the flusher writes the cache block</span></div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="comment">                (which still has the old contents) to the new file block!</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>],</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;                            &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;<span class="comment">                The block is marked BLOCK_IN_SWITCH. It should be left</span></div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;<span class="comment">                alone except for reading. No free, no write.</span></div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a> |</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                                             <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> |</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                                             <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)));</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;            }</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;            {</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;              <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a>;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;<span class="comment">                BLOCK_IN_EVICTION may be true or not. Other flags must</span></div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;<span class="comment">                have a fixed value.</span></div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>) ==</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;                          (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a> |</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160; </div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;<span class="comment">                The call is thread safe because only the current</span></div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;<span class="comment">                thread might change the block-&gt;hash_link value</span></div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;              <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= <a class="code" href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file,</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;                               <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer + <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;                               <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length - <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;                               <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos + <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;                               <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a> | <a class="code" href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a>));</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160; </div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;              <span class="comment">/* Block status must not have changed. */</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>) ==</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;                          (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a> |</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;              keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>++;</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;            }</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;          }</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160; </div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>;</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;<span class="comment">            The block comes from the LRU ring. It must have a hash_link</span></div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;<span class="comment">            assigned.</span></div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link)</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;          {</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="comment">              All pending requests for this page must be resubmitted.</span></div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;<span class="comment">              This must be done before waiting for readers. They could</span></div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;<span class="comment">              wait for the flush to complete. And we must also do it</span></div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;<span class="comment">              after the wait. Flushers might try to free the block while</span></div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;<span class="comment">              we wait. They would wait until the reassignment is</span></div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;<span class="comment">              complete. Also the block status must reflect the correct</span></div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;<span class="comment">              situation: The block is not changed nor in flush any more.</span></div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;<span class="comment">              Note that we must not change the BLOCK_CHANGED flag</span></div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;<span class="comment">              outside of link_to_file_list() so that it is always in the</span></div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;<span class="comment">              correct queue and the *blocks_changed counters are</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;<span class="comment">              correct.</span></div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~(<a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a>);</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file, 1);</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>]);</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;<span class="comment">              The block is still assigned to its old hash_link.</span></div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;<span class="comment">          Wait until all pending read requests</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;<span class="comment">          for this page are executed</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="comment">          (we could have avoided this waiting, if we had read</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;<span class="comment">          a page in the cache in a sweep, without yielding control)</span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a36c6785bea71fce1b852570282a32897">wait_for_readers</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;            <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a> &amp;&amp;</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;                        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed);</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;            <span class="comment">/* The reader must not have been a writer. */</span></div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;            <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>));</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160; </div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;            <span class="comment">/* Wake flushers that might have found the block in between. */</span></div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>]);</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160; </div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;            <span class="comment">/* Remove the hash link for the old file block from the hash. */</span></div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc">unlink_hash</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160; </div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment">              For sanity checks link_to_file_list() asserts that block</span></div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="comment">              and hash_link refer to each other. Hence we need to assign</span></div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="comment">              the hash_link first, but then we would not know if it was</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="comment">              linked before. Hence we would not know if to unlink it. So</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="comment">              unlink it here and call link_to_file_list(..., FALSE).</span></div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;          }</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status= <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a> ? <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a> : <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a> ;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length= 0;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>;</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link= hash_link;</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, 0);</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;          page_status= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>;</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160; </div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>-&gt;<a class="code" href="../../df/d94/structst__block__link.html#ad38f5e1b5c350f96a1d78c97a896fbc2">hash_link</a> == hash_link);</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        }</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        {</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;<span class="comment">            Either (block-&gt;hash_link == hash_link),</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="comment">        or     (block-&gt;status &amp; BLOCK_IN_SWITCH).</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;<span class="comment">            This is for secondary requests for a new file block only.</span></div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;<span class="comment">            Either it is already assigned to the new hash_link meanwhile</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;<span class="comment">            (if we had to wait due to empty LRU), or it is already in</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="comment">            eviction by another thread. Since this block has been</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="comment">            grabbed from the LRU ring and attached to this hash_link,</span></div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="comment">            another thread cannot grab the same block from the LRU ring</span></div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="comment">            anymore. If the block is in eviction already, it must become</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="comment">            attached to the same hash_link and as such destined for the</span></div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="comment">            same file block.</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;                              (<span class="stringliteral">&quot;block-&gt;hash_link: %p  hash_link: %p  &quot;</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;                               <span class="stringliteral">&quot;block-&gt;status: %u&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link,</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                               hash_link, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status ));</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;          page_status= (((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link) &amp;&amp;</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;                         (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>)) ?</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;                        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a> : <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>);</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;        }</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;      }</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    }</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    {</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="comment">        Block is not NULL. This hash_link points to a block.</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="comment">        Either</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="comment">        - block not assigned to this hash_link (yet) or</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="comment">        - block assigned but not yet read from file,</span></div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="comment">        or</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="comment">        - block assigned with valid (changed or unchanged) data and</span></div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="comment">        - it will not be reassigned/freed.</span></div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="comment">        The first condition means hash_link points to a block in</span></div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="comment">        eviction. This is not necessarily marked by BLOCK_IN_SWITCH yet.</span></div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="comment">        But then it is marked BLOCK_IN_EVICTION. See the NOTE in</span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="comment">        link_block(). In both cases it is destined for this hash_link</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="comment">        and its file block address. When this hash_link got its block</span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;<span class="comment">        address, the block was removed from the LRU ring and cannot be</span></div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="comment">        selected for eviction (for another hash_link) again.</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;<span class="comment">        Register a request on the block. This is another protection</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="comment">        against eviction.</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link != hash_link) &amp;&amp;</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;                   (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>))) ||</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;                  ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link) &amp;&amp;</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;                   !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>)) ||</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;                  ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>) &amp;&amp;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;                   !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>))));</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;                          (<span class="stringliteral">&quot;block-&gt;hash_link: %p  hash_link: %p  &quot;</span></div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;                           <span class="stringliteral">&quot;block-&gt;status: %u&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link,</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;                           hash_link, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status ));</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;      page_status= (((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link == hash_link) &amp;&amp;</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;                     (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>)) ?</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;                    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a> : <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>);</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;    }</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;  }</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160; </div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(page_status != -1);</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;  <span class="comment">/* Same assert basically, but be very sure. */</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;  <span class="comment">/* Assert that block has a request and is not in LRU ring. */</span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;  <span class="comment">/* Assert that we return the correct block. */</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((page_status == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>) ||</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;              ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp;</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;               (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos)));</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;  *page_st=page_status;</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;find_key_block&quot;</span>,</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;                      (<span class="stringliteral">&quot;fd: %d  pos: %lu  block-&gt;status: %u  page_status: %d&quot;</span>,</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;                       <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status,</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;                       page_status));</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160; </div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF) &amp;&amp; defined(EXTRA_DEBUG)</span></div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;check_keycache2&quot;</span>,</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;end of find_key_block&quot;</span>,0););</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;find_key_block:end&quot;</span>);</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;}</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160; </div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160; </div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;<span class="comment">  Read into a key cache block buffer from disk.</span></div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="comment">    read_block()</span></div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;<span class="comment">      block               block to which buffer the data is to be read</span></div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;<span class="comment">      read_length         size of data to be read</span></div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="comment">      min_length          at least so much data must be read</span></div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="comment">      primary             &lt;-&gt; the current thread will read the data</span></div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;<span class="comment">    The function either reads a page data from file to the block buffer,</span></div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;<span class="comment">    or waits until another thread reads it. What page to read is determined</span></div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;<span class="comment">    by a block parameter - reference to a hash link for this page.</span></div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;<span class="comment">    If an error occurs THE BLOCK_ERROR bit is set in the block status.</span></div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;<span class="comment">    We do not report error when the size of successfully read</span></div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;<span class="comment">    portion is less than read_length, but not less than min_length.</span></div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160; </div>
<div class="line"><a name="l02382"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50"> 2382</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50">read_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;                       <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> read_length,</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;                       <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> min_length, <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> primary)</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;{</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;  <span class="keywordtype">size_t</span> got_length;</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160; </div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;  <span class="comment">/* On entry cache_lock is locked */</span></div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160; </div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;read_block&quot;</span>);</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;  <span class="keywordflow">if</span> (primary)</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;  {</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;<span class="comment">      This code is executed only by threads that submitted primary</span></div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;<span class="comment">      requests. Until block-&gt;status contains BLOCK_READ, all other</span></div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;<span class="comment">      request for the block become secondary requests. For a primary</span></div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="comment">      request the block must be properly initialized.</span></div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>) == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>) ||</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length == 0) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset == keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>) ||</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests &gt; 0) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160; </div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;read_block&quot;</span>,</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;                        (<span class="stringliteral">&quot;page to be read by primary request&quot;</span>));</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160; </div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>++;</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;    <span class="comment">/* Page is not in buffer yet, is to be read from disk */</span></div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="comment">      Here other threads may step in and register as secondary readers.</span></div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;<span class="comment">      They will register in block-&gt;wqueue[COND_FOR_REQUESTED].</span></div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;    got_length= <a class="code" href="../../db/da9/my__sys_8h.html#a6d70f7239c6dfd15f74c22fd35eed350">my_pread</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer,</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;                         read_length, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos, <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(0));</div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="comment">      The block can now have been marked for free (in case of</span></div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;<span class="comment">      FLUSH_RELEASE). Otherwise the state must be unchanged.</span></div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~(<a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a> |</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;                                    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)) == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>) ||</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length == 0) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset == keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>) ||</div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests &gt; 0) || <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160; </div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;    <span class="keywordflow">if</span> (got_length &lt; min_length)</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>;</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;    {</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>;</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length= got_length;</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="comment">        Do not set block-&gt;offset here. If this block is marked</span></div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;<span class="comment">        BLOCK_CHANGED later, we want to flush only the modified part. So</span></div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="comment">        only a writer may set block-&gt;offset down from</span></div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="comment">        keycache-&gt;key_cache_block_size.</span></div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;    }</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;read_block&quot;</span>,</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;                        (<span class="stringliteral">&quot;primary request: new page in cache&quot;</span>));</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;    <span class="comment">/* Signal that all pending requests for this page now can be processed */</span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>]);</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;  }</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;  {</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="comment">      This code is executed only by threads that submitted secondary</span></div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;<span class="comment">      requests. At this point it could happen that the cache block is</span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="comment">      not yet assigned to the hash_link for the requested file block.</span></div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;<span class="comment">      But at awake from the wait this should be the case. Unfortunately</span></div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment">      we cannot assert this here because we do not know the hash_link</span></div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;<span class="comment">      for the requested file block nor the file and position. So we have</span></div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="comment">      to assert this in the caller.</span></div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;read_block&quot;</span>,</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;                      (<span class="stringliteral">&quot;secondary request waiting for new page to be read&quot;</span>));</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>], &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;read_block&quot;</span>,</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;                        (<span class="stringliteral">&quot;secondary request: new page in cache&quot;</span>));</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;  }</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;}</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160; </div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160; </div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="comment">  Read a block of data from a cached file into a buffer;</span></div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="comment">    key_cache_read()</span></div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="comment">      file                handler for the file for the block of data to be read</span></div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;<span class="comment">      filepos             position of the block of data in the file</span></div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;<span class="comment">      level               determines the weight of the data</span></div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;<span class="comment">      buff                buffer to where the data must be placed</span></div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;<span class="comment">      length              length of the buffer</span></div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;<span class="comment">      block_length        length of the block in the key cache buffer</span></div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;<span class="comment">      return_buffer       return pointer to the key cache buffer with the data</span></div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;<span class="comment">    Returns address from where the data is placed if sucessful, 0 - otherwise.</span></div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;<span class="comment">    The function ensures that a block of data of size length from file</span></div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;<span class="comment">    positioned at filepos is in the buffers for some key cache blocks.</span></div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;<span class="comment">    Then the function either copies the data into the buffer buff, or,</span></div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;<span class="comment">    if return_buffer is TRUE, it just returns the pointer to the key cache</span></div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;<span class="comment">    buffer with the data.</span></div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;<span class="comment">    Filepos must be a multiple of &#39;block_length&#39;, but it doesn&#39;t</span></div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;<span class="comment">    have to be a multiple of key_cache_block_size;</span></div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160; </div>
<div class="line"><a name="l02497"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a267ec136ad3cba2c6901459d19e9c16e"> 2497</a></span>&#160;<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *<a class="code" href="../../d3/d26/mf__keycache_8c.html#a267ec136ad3cba2c6901459d19e9c16e">key_cache_read</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;                      <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> filepos, <span class="keywordtype">int</span> level,</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;                      <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *buff, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>,</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;                      <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> block_length <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)),</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;                      <span class="keywordtype">int</span> return_buffer <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)))</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;{</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>=0;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *start= buff;</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;key_cache_read&quot;</span>);</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>, (<span class="stringliteral">&quot;fd: %u  pos: %lu  length: %u&quot;</span>,</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;               (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>));</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160; </div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;  {</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;    <span class="comment">/* Key cache is used */</span></div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a5baef0dcbf233902f75830ce890d9ba6">reg1</a> <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> read_length;</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> offset;</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;    <span class="keywordtype">int</span> page_st;</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160; </div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a65f00a50395efc0d7e5dda17b0fc9ea3">MYSQL_KEYCACHE_READ_START_ENABLED</a>())</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;    {</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;      <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a46615f7f9e2623345e76b6485dd79f25">MYSQL_KEYCACHE_READ_START</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a8d3ef6a3b12a1c6958836b08df7ebeab">my_filename</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>), <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>,</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;                                (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> *</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;                                         keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>),</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;                                (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a> *</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;                                         keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>));</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;    }</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;  </div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;<span class="comment">      When the key cache is once initialized, we use the cache_lock to</span></div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;<span class="comment">      reliably distinguish the cases of normal operation, resizing, and</span></div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;<span class="comment">      disabled cache. We always increment and decrement</span></div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;<span class="comment">      &#39;cnt_for_resize_op&#39; so that a resizer can wait for pending I/O.</span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="comment">      Cache resizing has two phases: Flushing and re-initializing. In</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;<span class="comment">      the flush phase read requests are allowed to bypass the cache for</span></div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;<span class="comment">      blocks not in the cache. find_key_block() returns NULL in this</span></div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;<span class="comment">      case.</span></div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="comment">      After the flush phase new I/O requests must wait until the</span></div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;<span class="comment">      re-initialization is done. The re-initialization can be done only</span></div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;<span class="comment">      if no I/O request is in progress. The reason is that</span></div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;<span class="comment">      key_cache_block_size can change. With enabled cache, I/O is done</span></div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;<span class="comment">      in chunks of key_cache_block_size. Every chunk tries to use a</span></div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;<span class="comment">      cache block first. If the block size changes in the middle, a</span></div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;<span class="comment">      block could be missed and old data could be read.</span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;    <span class="keywordflow">while</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a> &amp;&amp; !keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>)</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">resize_queue</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;    <span class="comment">/* Register the I/O for the next resize. */</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;    locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;    <span class="comment">/* Requested data may not always be aligned to cache blocks. */</span></div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;    offset= (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) (filepos % keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;    <span class="comment">/* Read data in key_cache_block_size increments */</span></div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;    {</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;      <span class="comment">/* Cache could be disabled in a later iteration. */</span></div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;      <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>)</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;      {</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;key_cache_read&quot;</span>, (<span class="stringliteral">&quot;keycache cannot be used&quot;</span>));</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;        <span class="keywordflow">goto</span> no_key_cache;</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;      }</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;      <span class="comment">/* Start reading at the beginning of the cache block. */</span></div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;      filepos-= offset;</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;      <span class="comment">/* Do not read beyond the end of the cache block. */</span></div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;      read_length= <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#aadeec961a0e84bb1fa3cded11703cf2f">set_if_smaller</a>(read_length, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>-offset);</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(read_length &gt; 0);</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160; </div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;      <span class="keywordflow">if</span> (block_length &gt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a> || offset)</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;    return_buffer=0;</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160; </div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;      <span class="comment">/* Request the cache block that matches file/pos. */</span></div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>++;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160; </div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;      <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a897e7297f5fb5a9c78fd42b00bca35e0">MYSQL_KEYCACHE_READ_BLOCK</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160; </div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>=<a class="code" href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293">find_key_block</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, filepos, level, 0, &amp;page_st);</div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;      {</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;<span class="comment">          This happens only for requests submitted during key cache</span></div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;<span class="comment">          resize. The block is not in the cache and shall not go in.</span></div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;<span class="comment">          Read directly from file.</span></div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>++;</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;        <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= (<a class="code" href="../../db/da9/my__sys_8h.html#a6d70f7239c6dfd15f74c22fd35eed350">my_pread</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) buff, read_length,</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;                         filepos + offset, <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a>)) != 0);</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;        <span class="keywordflow">goto</span> next_block;</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;      }</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;      {</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;        <span class="keywordflow">if</span> (page_st != <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>)</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;        {</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;          <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a7cc90d6c8a0998aa1ddfce204e65ed77">MYSQL_KEYCACHE_READ_MISS</a>();</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;          <span class="comment">/* The requested page is to be read into the block buffer */</span></div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50">read_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>,</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;                     keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>, read_length+offset,</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;                     (<a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a>)(page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>));</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;<span class="comment">            A secondary request must now have the block assigned to the</span></div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;<span class="comment">            requested file block. It does not hurt to check it for</span></div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;<span class="comment">            primary requests too.</span></div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>);</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos);</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;        }</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length &lt; read_length + offset)</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;        {</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;<span class="comment">            Impossible if nothing goes wrong:</span></div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;<span class="comment">            this could only happen if we are using a file with</span></div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;<span class="comment">            small key blocks and are trying to read outside the file</span></div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;          <a class="code" href="../../da/da8/my__pthread_8h.html#ab607b8ccc65b942b3d56aa2aa2e507eb">my_errno</a>= -1;</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;        }</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;        {</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;          <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a3d5514fca1d1fb3b0a472aa246131317">MYSQL_KEYCACHE_READ_HIT</a>();</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;        }</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;      }</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160; </div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;      <span class="comment">/* block status may have added BLOCK_ERROR in the above &#39;if&#39;. */</span></div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;      {</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;        {</div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160; </div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;          <span class="comment">/* Copy data from the cache buffer */</span></div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;          <a class="code" href="../../d6/dda/m__string_8h.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a>(buff, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer+offset, (<span class="keywordtype">size_t</span>) read_length);</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160; </div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;        }</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;      }</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160; </div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160; </div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;      <span class="comment">/* Error injection for coverage testing. */</span></div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#a1f2d1168faa35ce15f1b058a5fe9c630">DBUG_EXECUTE_IF</a>(<span class="stringliteral">&quot;key_cache_read_block_error&quot;</span>,</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;                      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>;);</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160; </div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;      <span class="comment">/* Do not link erroneous blocks into the LRU ring, but free them. */</span></div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;      {</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;<span class="comment">          Link the block into the LRU ring if it&#39;s the last submitted</span></div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;<span class="comment">          request for the block. This enables eviction for the block.</span></div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;      }</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;      {</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;        <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 1;</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;      }</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160; </div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    next_block:</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;      buff+= read_length;</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;      filepos+= read_length+offset;</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;      offset= 0;</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160; </div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;    } <span class="keywordflow">while</span> ((<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>-= read_length));</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a785ca90321c7d2501e3628677bdd2ef9">MYSQL_KEYCACHE_READ_DONE_ENABLED</a>())</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;    {</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;      <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#adf801fa7b644e4ba3f0b00327fd9395b">MYSQL_KEYCACHE_READ_DONE</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> *</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;                                        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>),</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;                               (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a> *</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;                                        keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>));</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;    }</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;    <span class="keywordflow">goto</span> end;</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;  }</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;key_cache_read&quot;</span>, (<span class="stringliteral">&quot;keycache not initialized&quot;</span>));</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160; </div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;no_key_cache:</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;  <span class="comment">/* Key cache is not used */</span></div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160; </div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>++;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>++;</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160; </div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;  <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../db/da9/my__sys_8h.html#a6d70f7239c6dfd15f74c22fd35eed350">my_pread</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) buff, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>, filepos, <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a>)))</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;    <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 1;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;  <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160; </div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;end:</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;  <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;  {</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;  }</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;exit&quot;</span>, (<span class="stringliteral">&quot;error: %d&quot;</span>, <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a> ));</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a> ? (<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) 0 : start);</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;}</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160; </div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160; </div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;<span class="comment">  Insert a block of file data from a buffer into key cache</span></div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;<span class="comment">    key_cache_insert()</span></div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;<span class="comment">    keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="comment">    file                handler for the file to insert data from</span></div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;<span class="comment">    filepos             position of the block of data in the file to insert</span></div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;<span class="comment">    level               determines the weight of the data</span></div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;<span class="comment">    buff                buffer to read data from</span></div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;<span class="comment">    length              length of the data in the buffer</span></div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;<span class="comment">  NOTES</span></div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;<span class="comment">    This is used by MyISAM to move all blocks from a index file to the key</span></div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;<span class="comment">    cache</span></div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;<span class="comment">    0 if a success, 1 - otherwise.</span></div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160; </div>
<div class="line"><a name="l02731"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#aa6743f1ab031dc202cea8b9ea346d5de"> 2731</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa6743f1ab031dc202cea8b9ea346d5de">key_cache_insert</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;                     <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> filepos, <span class="keywordtype">int</span> level,</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;                     <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *buff, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>)</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;{</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 0;</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;key_cache_insert&quot;</span>);</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>, (<span class="stringliteral">&quot;fd: %u  pos: %lu  length: %u&quot;</span>,</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;               (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>));</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160; </div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;  {</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;    <span class="comment">/* Key cache is used */</span></div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a5baef0dcbf233902f75830ce890d9ba6">reg1</a> <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> read_length;</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> offset;</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;    <span class="keywordtype">int</span> page_st;</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160; </div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;<span class="comment">      When the keycache is once initialized, we use the cache_lock to</span></div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;<span class="comment">      reliably distinguish the cases of normal operation, resizing, and</span></div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;<span class="comment">      disabled cache. We always increment and decrement</span></div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;<span class="comment">      &#39;cnt_for_resize_op&#39; so that a resizer can wait for pending I/O.</span></div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;<span class="comment">      We do not load index data into a disabled cache nor into an</span></div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;<span class="comment">      ongoing resize.</span></div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a> || keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;    <span class="keywordflow">goto</span> no_key_cache;</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;    <span class="comment">/* Register the pseudo I/O for the next resize. */</span></div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;    locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;    <span class="comment">/* Loaded data may not always be aligned to cache blocks. */</span></div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;    offset= (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) (filepos % keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <span class="comment">/* Load data in key_cache_block_size increments. */</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;    {</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;      <span class="comment">/* Cache could be disabled or resizing in a later iteration. */</span></div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;      <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a> || keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a>)</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;    <span class="keywordflow">goto</span> no_key_cache;</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;      <span class="comment">/* Start loading at the beginning of the cache block. */</span></div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;      filepos-= offset;</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;      <span class="comment">/* Do not load beyond the end of the cache block. */</span></div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;      read_length= <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>;</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#aadeec961a0e84bb1fa3cded11703cf2f">set_if_smaller</a>(read_length, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>-offset);</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(read_length &gt; 0);</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160; </div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;      <span class="comment">/* The block has been read by the caller already. */</span></div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>++;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;      <span class="comment">/* Request the cache block that matches file/pos. */</span></div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>++;</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293">find_key_block</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, filepos, level, 0, &amp;page_st);</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;      {</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;<span class="comment">          This happens only for requests submitted during key cache</span></div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;<span class="comment">          resize. The block is not in the cache and shall not go in.</span></div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;<span class="comment">          Stop loading index data.</span></div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;        <span class="keywordflow">goto</span> no_key_cache;</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;      }</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;      {</div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;        <span class="keywordflow">if</span> ((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>) ||</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;            ((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>) &amp;&amp;</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;             (offset || (read_length &lt; keycache-&gt;key_cache_block_size))))</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;        {</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;<span class="comment">            Either</span></div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;<span class="comment">            this is a secondary request for a block to be read into the</span></div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;<span class="comment">            cache. The block is in eviction. It is not yet assigned to</span></div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;<span class="comment">            the requested file block (It does not point to the right</span></div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;<span class="comment">            hash_link). So we cannot call remove_reader() on the block.</span></div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;<span class="comment">            And we cannot access the hash_link directly here. We need to</span></div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;<span class="comment">            wait until the assignment is complete. read_block() executes</span></div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;<span class="comment">            the correct wait when called with primary == FALSE.</span></div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;<span class="comment">            Or</span></div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;<span class="comment">            this is a primary request for a block to be read into the</span></div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;<span class="comment">            cache and the supplied data does not fill the whole block.</span></div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;<span class="comment">            This function is called on behalf of a LOAD INDEX INTO CACHE</span></div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="comment">            statement, which is a read-only task and allows other</span></div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="comment">            readers. It is possible that a parallel running reader tries</span></div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;<span class="comment">            to access this block. If it needs more data than has been</span></div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;<span class="comment">            supplied here, it would report an error. To be sure that we</span></div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;<span class="comment">            have all data in the block that is available in the file, we</span></div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;<span class="comment">            read the block ourselves.</span></div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;<span class="comment">            Though reading again what the caller did read already is an</span></div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;<span class="comment">            expensive operation, we need to do this for correctness.</span></div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50">read_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>,</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;                     read_length + offset, (page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>));</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;<span class="comment">            A secondary request must now have the block assigned to the</span></div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;<span class="comment">            requested file block. It does not hurt to check it for</span></div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;<span class="comment">            primary requests too.</span></div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>);</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos);</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;        }</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>)</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;        {</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;<span class="comment">            This is a new block in the cache. If we come here, we have</span></div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;<span class="comment">            data for the whole block.</span></div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;requests);</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>) ||</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;                      (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>));</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160; </div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;<span class="comment">            Here other threads may step in and register as secondary readers.</span></div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;<span class="comment">            They will register in block-&gt;wqueue[COND_FOR_REQUESTED].</span></div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160; </div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;          <span class="comment">/* Copy data from buff */</span></div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;          <a class="code" href="../../d6/dda/m__string_8h.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer+offset, buff, (<span class="keywordtype">size_t</span>) read_length);</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160; </div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>) ||</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;                      (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>));</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;<span class="comment">            After the data is in the buffer, we can declare the block</span></div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;<span class="comment">            valid. Now other threads do not need to register as</span></div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;<span class="comment">            secondary readers any more. They can immediately access the</span></div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;<span class="comment">            block.</span></div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>;</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;          <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length= read_length+offset;</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;<span class="comment">            Do not set block-&gt;offset here. If this block is marked</span></div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;<span class="comment">            BLOCK_CHANGED later, we want to flush only the modified part. So</span></div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;<span class="comment">            only a writer may set block-&gt;offset down from</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;<span class="comment">            keycache-&gt;key_cache_block_size.</span></div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;key_cache_insert&quot;</span>,</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;                              (<span class="stringliteral">&quot;primary request: new page in cache&quot;</span>));</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;          <span class="comment">/* Signal all pending requests. */</span></div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>]);</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;        }</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        {</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;<span class="comment">            page_st == PAGE_READ. The block is in the buffer. All data</span></div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment">            must already be present. Blocks are always read with all</span></div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;<span class="comment">            data available on file. Assert that the block does not have</span></div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;<span class="comment">            less contents than the preloader supplies. If the caller has</span></div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;<span class="comment">            data beyond block-&gt;length, it means that a file write has</span></div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;<span class="comment">            been done while this block was in cache and not extended</span></div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;<span class="comment">            with the new data. If the condition is met, we can simply</span></div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;<span class="comment">            ignore the block.</span></div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a>) &amp;&amp;</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;                      (read_length + offset &lt;= block-&gt;<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>));</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;        }</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160; </div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;<span class="comment">          A secondary request must now have the block assigned to the</span></div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;<span class="comment">          requested file block. It does not hurt to check it for primary</span></div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;<span class="comment">          requests too.</span></div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos);</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;      } <span class="comment">/* end of if (!(block-&gt;status &amp; BLOCK_ERROR)) */</span></div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160; </div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160; </div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;      <span class="comment">/* Error injection for coverage testing. */</span></div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#a1f2d1168faa35ce15f1b058a5fe9c630">DBUG_EXECUTE_IF</a>(<span class="stringliteral">&quot;key_cache_insert_block_error&quot;</span>,</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;                      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>; <a class="code" href="../../db/da9/my__sys_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>=EIO;);</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160; </div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;      <span class="comment">/* Do not link erroneous blocks into the LRU ring, but free them. */</span></div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;      {</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;<span class="comment">          Link the block into the LRU ring if it&#39;s the last submitted</span></div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;<span class="comment">          request for the block. This enables eviction for the block.</span></div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;      }</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;      {</div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;        <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 1;</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;      }</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160; </div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;      buff+= read_length;</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;      filepos+= read_length+offset;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;      offset= 0;</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160; </div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    } <span class="keywordflow">while</span> ((<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>-= read_length));</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160; </div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;  no_key_cache:</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;  }</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>);</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;}</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160; </div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160; </div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;<span class="comment">  Write a buffer into a cached file.</span></div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;<span class="comment">    key_cache_write()</span></div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;<span class="comment">      file                handler for the file to write data to</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;<span class="comment">      filepos             position in the file to write data to</span></div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;<span class="comment">      level               determines the weight of the data</span></div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;<span class="comment">      buff                buffer with the data</span></div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;<span class="comment">      length              length of the buffer</span></div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;<span class="comment">      dont_write          if is 0 then all dirty pages involved in writing</span></div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;<span class="comment">                          should have been flushed from key cache</span></div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;<span class="comment">  RETURN VALUE</span></div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;<span class="comment">    0 if a success, 1 - otherwise.</span></div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;<span class="comment">  NOTES.</span></div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;<span class="comment">    The function copies the data of size length from buff into buffers</span></div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;<span class="comment">    for key cache blocks that are  assigned to contain the portion of</span></div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;<span class="comment">    the file starting with position filepos.</span></div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;<span class="comment">    It ensures that this data is flushed to the file if dont_write is FALSE.</span></div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;<span class="comment">    Filepos must be a multiple of &#39;block_length&#39;, but it doesn&#39;t</span></div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;<span class="comment">    have to be a multiple of key_cache_block_size;</span></div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;<span class="comment">    dont_write is always TRUE in the server (info-&gt;lock_type is never F_UNLCK).</span></div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160; </div>
<div class="line"><a name="l02978"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aff88812c695a85ae531437535463868e"> 2978</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aff88812c695a85ae531437535463868e">key_cache_write</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;                    <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> filepos, <span class="keywordtype">int</span> level,</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;                    <a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *buff, <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>,</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;                    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> block_length  <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)),</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;                    <span class="keywordtype">int</span> dont_write)</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;{</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>=0;</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;key_cache_write&quot;</span>);</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>,</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;             (<span class="stringliteral">&quot;fd: %u  pos: %lu  length: %u  block_length: %u&quot;</span></div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;              <span class="stringliteral">&quot;  key_block_length: %u&quot;</span>,</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;              (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) filepos, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>, block_length,</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;              keycache ? keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a> : 0));</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160; </div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;  <span class="keywordflow">if</span> (!dont_write)</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;  {</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;    <span class="comment">/* purecov: begin inspected */</span></div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;    <span class="comment">/* Not used in the server. */</span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;    <span class="comment">/* Force writing from buff into disk. */</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>++;</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>++;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, buff, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>, filepos, <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a> | <a class="code" href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a>)))</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;      <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(1);</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;    <span class="comment">/* purecov: end */</span></div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;  }</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160; </div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF) &amp;&amp; defined(EXTRA_DEBUG)</span></div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;check_keycache&quot;</span>,</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;start of key_cache_write&quot;</span>, 1););</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160; </div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;  {</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;    <span class="comment">/* Key cache is used */</span></div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a5baef0dcbf233902f75830ce890d9ba6">reg1</a> <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> read_length;</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> offset;</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;    <span class="keywordtype">int</span> page_st;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160; </div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#ad3a27b275c6310be01ae86dde53863b1">MYSQL_KEYCACHE_WRITE_START_ENABLED</a>())</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;    {</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;      <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#a7cc0738eef0dd642e0f14d6e2564efa7">MYSQL_KEYCACHE_WRITE_START</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a8d3ef6a3b12a1c6958836b08df7ebeab">my_filename</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>), <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>,</div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;                                 (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> *</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;                                          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>),</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;                                 (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a> *</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;                                          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>));</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;    }</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160; </div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;<span class="comment">      When the key cache is once initialized, we use the cache_lock to</span></div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;<span class="comment">      reliably distinguish the cases of normal operation, resizing, and</span></div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;<span class="comment">      disabled cache. We always increment and decrement</span></div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;<span class="comment">      &#39;cnt_for_resize_op&#39; so that a resizer can wait for pending I/O.</span></div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;<span class="comment">      Cache resizing has two phases: Flushing and re-initializing. In</span></div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;<span class="comment">      the flush phase write requests can modify dirty blocks that are</span></div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;<span class="comment">      not yet in flush. Otherwise they are allowed to bypass the cache.</span></div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;<span class="comment">      find_key_block() returns NULL in both cases (clean blocks and</span></div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;<span class="comment">      non-cached blocks).</span></div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;<span class="comment">      After the flush phase new I/O requests must wait until the</span></div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;<span class="comment">      re-initialization is done. The re-initialization can be done only</span></div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;<span class="comment">      if no I/O request is in progress. The reason is that</span></div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;<span class="comment">      key_cache_block_size can change. With enabled cache I/O is done in</span></div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;<span class="comment">      chunks of key_cache_block_size. Every chunk tries to use a cache</span></div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;<span class="comment">      block first. If the block size changes in the middle, a block</span></div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;<span class="comment">      could be missed and data could be written below a cached block.</span></div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    <span class="keywordflow">while</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">in_resize</a> &amp;&amp; !keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">resize_in_flush</a>)</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">resize_queue</a>, &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;    <span class="comment">/* Register the I/O for the next resize. */</span></div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;    locked_and_incremented= <a class="code" href="../../d8/dec/mpq-internal_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;    <span class="comment">/* Requested data may not always be aligned to cache blocks. */</span></div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;    offset= (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) (filepos % keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    <span class="comment">/* Write data in key_cache_block_size increments. */</span></div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;    {</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;      <span class="comment">/* Cache could be disabled in a later iteration. */</span></div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;      <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>)</div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    <span class="keywordflow">goto</span> no_key_cache;</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160; </div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;      <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#ad59f03a8981ab708fa61c1feea43ed79">MYSQL_KEYCACHE_WRITE_BLOCK</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>);</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;      <span class="comment">/* Start writing at the beginning of the cache block. */</span></div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;      filepos-= offset;</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;      <span class="comment">/* Do not write beyond the end of the cache block. */</span></div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;      read_length= <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>;</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#aadeec961a0e84bb1fa3cded11703cf2f">set_if_smaller</a>(read_length, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>-offset);</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(read_length &gt; 0);</div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160; </div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;      <span class="comment">/* Request the cache block that matches file/pos. */</span></div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>++;</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293">find_key_block</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, filepos, level, 1, &amp;page_st);</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;      {</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;<span class="comment">          This happens only for requests submitted during key cache</span></div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;<span class="comment">          resize. The block is not in the cache and shall not go in.</span></div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;<span class="comment">          Write directly to file.</span></div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        <span class="keywordflow">if</span> (dont_write)</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;        {</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;          <span class="comment">/* Used in the server. */</span></div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;          keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>++;</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) buff, read_length, filepos + offset,</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;                        <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a> | <a class="code" href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a>)))</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;            <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>=1;</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;        }</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;        <span class="keywordflow">goto</span> next_block;</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;      }</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;<span class="comment">        Prevent block from flushing and from being selected for to be</span></div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;<span class="comment">        freed. This must be set when we release the cache_lock.</span></div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;<span class="comment">        However, we must not set the status of the block before it is</span></div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;<span class="comment">        assigned to this file/pos.</span></div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;      <span class="keywordflow">if</span> (page_st != <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>)</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>;</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;<span class="comment">        We must read the file block first if it is not yet in the cache</span></div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;<span class="comment">        and we do not replace all of its contents.</span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;<span class="comment">        In cases where the cache block is big enough to contain (parts</span></div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;<span class="comment">        of) index blocks of different indexes, our request can be</span></div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;<span class="comment">        secondary (PAGE_WAIT_TO_BE_READ). In this case another thread is</span></div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;<span class="comment">        reading the file block. If the read completes after us, it</span></div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;<span class="comment">        overwrites our new contents with the old contents. So we have to</span></div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;<span class="comment">        wait for the other thread to complete the read of this block.</span></div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;<span class="comment">        read_block() takes care for the wait.</span></div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>) &amp;&amp;</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;          ((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a> &amp;&amp;</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;            (offset || read_length &lt; keycache-&gt;key_cache_block_size)) ||</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;           (page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a>)))</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;      {</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50">read_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>,</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;                   offset + read_length &gt;= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>?</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;                   offset : keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>,</div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;                   offset, (page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>));</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>);</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;<span class="comment">          Prevent block from flushing and from being selected for to be</span></div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;<span class="comment">          freed. This must be set when we release the cache_lock.</span></div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;<span class="comment">          Here we set it in case we could not set it above.</span></div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>;</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;      }</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;<span class="comment">        The block should always be assigned to the requested file block</span></div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;<span class="comment">        here. It need not be BLOCK_READ when overwriting the whole block.</span></div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos == filepos);</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>);</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((page_st == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a>) || (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>));</div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;<span class="comment">        The block to be written must not be marked BLOCK_REASSIGNED.</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;<span class="comment">        Otherwise it could be freed in dirty state or reused without</span></div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;<span class="comment">        another flush during eviction. It must also not be in flush.</span></div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;<span class="comment">        Otherwise the old contens may have been flushed already and</span></div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;<span class="comment">        the flusher could clear BLOCK_CHANGED without flushing the</span></div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;<span class="comment">        new changes again.</span></div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>));</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160; </div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;      <span class="keywordflow">while</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a>)</div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;      {</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;<span class="comment">          Another thread is flushing the block. It was dirty already.</span></div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;<span class="comment">          Wait until the block is flushed to file. Otherwise we could</span></div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;<span class="comment">          modify the buffer contents just while it is written to file.</span></div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;<span class="comment">          An unpredictable file block contents would be the result.</span></div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;<span class="comment">          While we wait, several things can happen to the block,</span></div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;<span class="comment">          including another flush. But the block cannot be reassigned to</span></div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;<span class="comment">          another hash_link until we release our request on it.</span></div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>], &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">can_be_used</a>);</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;        <span class="comment">/* Still must not be marked for free. */</span></div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>));</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;      }</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160; </div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;<span class="comment">        We could perhaps release the cache_lock during access of the</span></div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;<span class="comment">        data like in the other functions. Locks outside of the key cache</span></div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;<span class="comment">        assure that readers and a writer do not access the same range of</span></div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;<span class="comment">        data. Parallel accesses should happen only if the cache block</span></div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;<span class="comment">        contains multiple index block(fragment)s. So different parts of</span></div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;<span class="comment">        the buffer would be read/written. An attempt to flush during</span></div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;<span class="comment">        memcpy() is prevented with BLOCK_FOR_UPDATE.</span></div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;      {</div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;        <a class="code" href="../../d6/dda/m__string_8h.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer+offset, buff, (<span class="keywordtype">size_t</span>) read_length);</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160; </div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;<span class="preprocessor">#if !defined(SERIALIZED_READ_FROM_CACHE)</span></div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;      }</div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160; </div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;      <span class="keywordflow">if</span> (!dont_write)</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;      {</div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;        <span class="comment">/* Not used in the server. buff has been written to disk at start. */</span></div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;        <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>) &amp;&amp;</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;            (!offset &amp;&amp; read_length &gt;= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>))</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;             <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file, 1);</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;      }</div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>))</div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae31bae037244419366e24306ddaf78d5">link_to_changed_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|=<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a>;</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="comment">        Allow block to be selected for to be freed. Since it is marked</span></div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;<span class="comment">        BLOCK_CHANGED too, it won&#39;t be selected for to be freed without</span></div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="comment">        a flush.</span></div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>;</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#aadeec961a0e84bb1fa3cded11703cf2f">set_if_smaller</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset, offset);</div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#adefd9f16236d64d1f92020396d6a07a3">set_if_bigger</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length, read_length+offset);</div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160; </div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;      <span class="comment">/* Threads may be waiting for the changes to be complete. */</span></div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>]);</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160; </div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;<span class="comment">        If only a part of the cache block is to be replaced, and the</span></div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;<span class="comment">        rest has been read from file, then the cache lock has been</span></div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;<span class="comment">        released for I/O and it could be possible that another thread</span></div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;<span class="comment">        wants to evict or free the block and waits for it to be</span></div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;<span class="comment">        released. So we must not just decrement hash_link-&gt;requests, but</span></div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;<span class="comment">        also wake a waiting thread.</span></div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160; </div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;      <span class="comment">/* Error injection for coverage testing. */</span></div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#a1f2d1168faa35ce15f1b058a5fe9c630">DBUG_EXECUTE_IF</a>(<span class="stringliteral">&quot;key_cache_write_block_error&quot;</span>,</div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;                      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>;);</div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160; </div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;      <span class="comment">/* Do not link erroneous blocks into the LRU ring, but free them. */</span></div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;      <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;      {</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;<span class="comment">          Link the block into the LRU ring if it&#39;s the last submitted</span></div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;<span class="comment">          request for the block. This enables eviction for the block.</span></div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;      }</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;      {</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        <span class="comment">/* Pretend a &quot;clean&quot; block to avoid complications. */</span></div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~(<a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>);</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;        <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 1;</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;      }</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160; </div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;    next_block:</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;      buff+= read_length;</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;      filepos+= read_length+offset;</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;      offset= 0;</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160; </div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;    } <span class="keywordflow">while</span> ((<a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>-= read_length));</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;    <span class="keywordflow">goto</span> end;</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;  }</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160; </div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;no_key_cache:</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;  <span class="comment">/* Key cache is not used */</span></div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;  <span class="keywordflow">if</span> (dont_write)</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;  {</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;    <span class="comment">/* Used in the server. */</span></div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>++;</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>++;</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;    <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) buff, <a class="code" href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">length</a>, filepos,</div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;          <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a> | <a class="code" href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a>)))</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;      <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>=1;</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;    <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;  }</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160; </div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;end:</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;  <span class="keywordflow">if</span> (locked_and_incremented)</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;  {</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;  }</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;  </div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#ac2d67e32eb211dd4f8b11b99802ae038">MYSQL_KEYCACHE_WRITE_DONE_ENABLED</a>())</div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;  {</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;    <a class="code" href="../../db/dbc/probes__mysql__nodtrace_8h.html#abb77412e8b158b87ec27276a738a0083">MYSQL_KEYCACHE_WRITE_DONE</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> *</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;                                       keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>),</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;                              (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a> *</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;                                       keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>));</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;  }</div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;  </div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF) &amp;&amp; defined(EXTRA_DEBUG)</span></div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;exec&quot;</span>,</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;end of key_cache_write&quot;</span>, 1););</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>);</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;}</div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160; </div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160; </div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;<span class="comment">  Free block.</span></div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;<span class="comment">    free_block()</span></div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;<span class="comment">      keycache          Pointer to a key cache data structure</span></div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;<span class="comment">      block             Pointer to the block to free</span></div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;<span class="comment">  DESCRIPTION</span></div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;<span class="comment">    Remove reference to block from hash table.</span></div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;<span class="comment">    Remove block from the chain of clean blocks.</span></div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;<span class="comment">    Add block to the free list.</span></div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;<span class="comment">  NOTE</span></div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;<span class="comment">    Block must not be free (status == 0).</span></div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;<span class="comment">    Block must not be in free_block_list.</span></div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;<span class="comment">    Block must not be in the LRU ring.</span></div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;<span class="comment">    Block must not be in eviction (BLOCK_IN_EVICTION | BLOCK_IN_SWITCH).</span></div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;<span class="comment">    Block must not be in free (BLOCK_REASSIGNED).</span></div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;<span class="comment">    Block must not be in flush (BLOCK_IN_FLUSH).</span></div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;<span class="comment">    Block must not be dirty (BLOCK_CHANGED).</span></div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;<span class="comment">    Block must not be in changed_blocks (dirty) hash.</span></div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;<span class="comment">    Block must be in file_blocks (clean) hash.</span></div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;<span class="comment">    Block must refer to a hash_link.</span></div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;<span class="comment">    Block must have a request registered on it.</span></div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160; </div>
<div class="line"><a name="l03318"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887"> 3318</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;{</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;free block&quot;</span>);</div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;free_block&quot;</span>,</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;                      (<span class="stringliteral">&quot;block %u to be freed, hash_link %p  status: %u&quot;</span>,</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;                       <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>), <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link,</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;                       <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status));</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;<span class="comment">    Assert that the block is not free already. And that it is in a clean</span></div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;<span class="comment">    state. Note that the block might just be assigned to a hash_link and</span></div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;<span class="comment">    not yet read (BLOCK_READ may not be set here). In this case a reader</span></div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;<span class="comment">    is registered in the hash_link and free_block() will wait for it</span></div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;<span class="comment">    below.</span></div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>) &amp;&amp;</div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;              !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;                                 <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> |</div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;                                 <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)));</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;  <span class="comment">/* Assert that the block is in a file_blocks chain. */</span></div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;  <span class="comment">/* Assert that the block is not in the LRU ring. */</span></div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used &amp;&amp; !<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;<span class="comment">    IMHO the below condition (if()) makes no sense. I can&#39;t see how it</span></div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;<span class="comment">    could be possible that free_block() is entered with a NULL hash_link</span></div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;<span class="comment">    pointer. The only place where it can become NULL is in free_block()</span></div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;<span class="comment">    (or before its first use ever, but for those blocks free_block() is</span></div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;<span class="comment">    not called). I don&#39;t remove the conditional as it cannot harm, but</span></div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;<span class="comment">    place an DBUG_ASSERT to confirm my hypothesis. Eventually the</span></div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;<span class="comment">    condition (if()) can be removed.</span></div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link)</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;  {</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;<span class="comment">      While waiting for readers to finish, new readers might request the</span></div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;<span class="comment">      block. But since we set block-&gt;status|= BLOCK_REASSIGNED, they</span></div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;<span class="comment">      will wait on block-&gt;wqueue[COND_FOR_SAVED]. They must be signalled</span></div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;<span class="comment">      later.</span></div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a36c6785bea71fce1b852570282a32897">wait_for_readers</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;<span class="comment">      The block must not have been freed by another thread. Repeat some</span></div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="comment">      checks. An additional requirement is that it must be read now</span></div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;<span class="comment">      (BLOCK_READ).</span></div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a> |</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;                                  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>)) &amp;&amp;</div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;                !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;                                   <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> |</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;                                   <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)));</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed &amp;&amp; *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;<span class="comment">      Unset BLOCK_REASSIGNED again. If we hand the block to an evicting</span></div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;<span class="comment">      thread (through unreg_request() below), other threads must not see</span></div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;<span class="comment">      this flag. They could become confused.</span></div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>;</div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;<span class="comment">      Do not release the hash_link until the block is off all lists.</span></div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;<span class="comment">      At least not if we hand it over for eviction in unreg_request().</span></div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;  }</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160; </div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;<span class="comment">    Unregister the block request and link the block into the LRU ring.</span></div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;<span class="comment">    This enables eviction for the block. If the LRU ring was empty and</span></div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;<span class="comment">    threads are waiting for a block, then the block wil be handed over</span></div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;<span class="comment">    for eviction immediately. Otherwise we will unlink it from the LRU</span></div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;<span class="comment">    ring again, without releasing the lock in between. So decrementing</span></div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;<span class="comment">    the request counter and updating statistics are the only relevant</span></div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;<span class="comment">    operation in this case. Assert that there are no other requests</span></div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;<span class="comment">    registered.</span></div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests == 1);</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 0);</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;<span class="comment">    Note that even without releasing the cache lock it is possible that</span></div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;<span class="comment">    the block is immediately selected for eviction by link_block() and</span></div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;<span class="comment">    thus not added to the LRU ring. In this case we must not touch the</span></div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;<span class="comment">    block any more.</span></div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>)</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160; </div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;  <span class="comment">/* Error blocks are not put into the LRU ring. */</span></div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;  <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>))</div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;  {</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;    <span class="comment">/* Here the block must be in the LRU ring. Unlink it again. */</span></div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used &amp;&amp; <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used &amp;&amp;</div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;                *<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;  }</div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature == <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a>)</div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;    keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">warm_blocks</a>--;</div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550">BLOCK_COLD</a>;</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160; </div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;  <span class="comment">/* Remove from file_blocks hash. */</span></div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160; </div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;  <span class="comment">/* Remove reference to block from hash table. */</span></div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc">unlink_hash</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160; </div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status= 0;</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length= 0;</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">key_cache_block_size</a>;</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;free block&quot;</span>);</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;free_block&quot;</span>, (<span class="stringliteral">&quot;block is freed&quot;</span>));</div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160; </div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;  <span class="comment">/* Enforced by unlink_changed(), but just to be sure. */</span></div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed &amp;&amp; !<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed);</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;  <span class="comment">/* Enforced by unlink_block(): not in LRU ring nor in free_block_list. */</span></div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;  <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used &amp;&amp; !<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;  <span class="comment">/* Insert the free block in the free list. */</span></div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>;</div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">free_block_list</a>= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;  <span class="comment">/* Keep track of the number of currently unused blocks. */</span></div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;  keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">blocks_unused</a>++;</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160; </div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;  <span class="comment">/* All pending requests for this page must be resubmitted. */</span></div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>]);</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;}</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160; </div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160; </div>
<div class="line"><a name="l03446"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a032c611ae0a4a7b599a8507d44f3b68b"> 3446</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a032c611ae0a4a7b599a8507d44f3b68b">cmp_sec_link</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **<a class="code" href="../../d4/d71/namespacempq.html#ae78cc6206276c5d8a54a7b181bcd4f8d">a</a>, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **<a class="code" href="../../df/d31/prof_8c.html#a3fca4d23183335e3d46f507d28e94e8b">b</a>)</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;{</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;  <span class="keywordflow">return</span> (((*a)-&gt;hash_link-&gt;diskpos &lt; (*b)-&gt;hash_link-&gt;diskpos) ? -1 :</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;      ((*a)-&gt;hash_link-&gt;diskpos &gt; (*b)-&gt;hash_link-&gt;diskpos) ? 1 : 0);</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;}</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160; </div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160; </div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;<span class="comment">  Flush a portion of changed blocks to disk,</span></div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;<span class="comment">  free used blocks if requested</span></div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160; </div>
<div class="line"><a name="l03458"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a52cb7c1e487c6dc5bfaa36f9883df371"> 3458</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a52cb7c1e487c6dc5bfaa36f9883df371">flush_cached_blocks</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;                               <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **cache,</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;                               <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **end,</div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;                               <span class="keyword">enum</span> <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085">flush_type</a> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>)</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;{</div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>;</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;  <span class="keywordtype">int</span> last_errno= 0;</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>= (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) (end-cache);</div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160; </div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;  <span class="comment">/* Don&#39;t lock the cache during the flush */</span></div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;<span class="comment">     As all blocks referred in &#39;cache&#39; are marked by BLOCK_IN_FLUSH</span></div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;<span class="comment">     we are guarunteed no thread will change them</span></div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;  <a class="code" href="../../db/da9/my__sys_8h.html#a5bd7d62eddacdc1536566cf3f210ab42">my_qsort</a>((<a class="code" href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) cache, <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>, <span class="keyword">sizeof</span>(*cache), (<a class="code" href="../../d9/df6/my__global_8h.html#a789723eaf2299d841eb477a8f1d6b1b1">qsort_cmp</a>) <a class="code" href="../../d3/d26/mf__keycache_8c.html#a032c611ae0a4a7b599a8507d44f3b68b">cmp_sec_link</a>);</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160; </div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;<span class="comment">    Note: Do not break the loop. We have registered a request on every</span></div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;<span class="comment">    block in &#39;cache&#39;. These must be unregistered by free_block() or</span></div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;<span class="comment">    unreg_request().</span></div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;  <span class="keywordflow">for</span> ( ; cache != end ; cache++)</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;  {</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>= *cache;</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160; </div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a>(<span class="stringliteral">&quot;flush_cached_blocks&quot;</span>,</div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;                        (<span class="stringliteral">&quot;block %u to be flushed&quot;</span>, <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>)));</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;<span class="comment">      If the block contents is going to be changed, we abandon the flush</span></div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;<span class="comment">      for this block. flush_key_blocks_int() will restart its search and</span></div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;<span class="comment">      handle the block properly.</span></div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>))</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;    {</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;      <span class="comment">/* Blocks coming here must have a certain status. */</span></div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>) ==</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;                  (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a>;</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;      <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= <a class="code" href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;buffer+<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;                       <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length - <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;                       <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;diskpos+ <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset,</div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;                       <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(<a class="code" href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a> | <a class="code" href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a>));</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;      keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>++;</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>)</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;      {</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;        <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a>;</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;        <span class="keywordflow">if</span> (!last_errno)</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;          last_errno= <a class="code" href="../../db/da9/my__sys_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> ? <a class="code" href="../../db/da9/my__sys_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> : -1;</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;      }</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a>;</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;      <span class="comment">/* Block must not have changed status except BLOCK_FOR_UPDATE. */</span></div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;block == <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>);</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;      <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; ~(<a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a>)) ==</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;                  (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a>));</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;<span class="comment">        Set correct status and link in right queue for free or later use.</span></div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;<span class="comment">        free_block() must not see BLOCK_CHANGED and it may need to wait</span></div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;<span class="comment">        for readers of the block. These should not see the block in the</span></div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;<span class="comment">        wrong hash. If not freeing the block, we need to have it in the</span></div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;<span class="comment">        right queue anyway.</span></div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, 1);</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;    }</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status&amp;= ~<a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>;</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;<span class="comment">      Let to proceed for possible waiting requests to write to the block page.</span></div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;<span class="comment">      It might happen only during an operation to resize the key cache.</span></div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a>(&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>]);</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;    <span class="comment">/* type will never be FLUSH_IGNORE_CHANGED here */</span></div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;    <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a> || <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a371968d6faccf6bb3c78f25f97bf15b5">FLUSH_FORCE_WRITE</a>) &amp;&amp;</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;        !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;                           <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)))</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;    {</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;<span class="comment">        Note that a request has been registered against the block in</span></div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;<span class="comment">        flush_key_blocks_int().</span></div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;    }</div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;    {</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;<span class="comment">        Link the block into the LRU ring if it&#39;s the last submitted</span></div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;<span class="comment">        request for the block. This enables eviction for the block.</span></div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;<span class="comment">        Note that a request has been registered against the block in</span></div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;<span class="comment">        flush_key_blocks_int().</span></div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;    }</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160; </div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;  } <span class="comment">/* end of for ( ; cache != end ; cache++) */</span></div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;  <span class="keywordflow">return</span> last_errno;</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;}</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160; </div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160; </div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;<span class="comment">  Flush all key blocks for a file to disk, but don&#39;t do any mutex locks.</span></div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;<span class="comment">    flush_key_blocks_int()</span></div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;<span class="comment">      file                handler for the file to flush to</span></div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;<span class="comment">      flush_type          type of the flush</span></div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;<span class="comment">  NOTES</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;<span class="comment">    This function doesn&#39;t do any mutex locks because it needs to be called both</span></div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;<span class="comment">    from flush_key_blocks and flush_all_key_blocks (the later one does the</span></div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;<span class="comment">    mutex lock in the resize_key_cache() function).</span></div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;<span class="comment">    We do only care about changed blocks that exist when the function is</span></div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;<span class="comment">    entered. We do not guarantee that all changed blocks of the file are</span></div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;<span class="comment">    flushed if more blocks change while this function is running.</span></div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;<span class="comment">    0   ok</span></div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;<span class="comment">    1  error</span></div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160; </div>
<div class="line"><a name="l03586"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807"> 3586</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807">flush_key_blocks_int</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;                <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <span class="keyword">enum</span> <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085">flush_type</a> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>)</div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;{</div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *cache_buff[<a class="code" href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">FLUSH_CACHE</a>],**cache;</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;  <span class="keywordtype">int</span> last_errno= 0;</div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;  <span class="keywordtype">int</span> last_errcnt= 0;</div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;flush_key_blocks_int&quot;</span>);</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>,(<span class="stringliteral">&quot;file: %d  blocks_used: %lu  blocks_changed: %lu&quot;</span>,</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;              <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">blocks_changed</a>));</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160; </div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF) &amp;&amp; defined(EXTRA_DEBUG)</span></div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;check_keycache&quot;</span>,</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;start of flush_key_blocks&quot;</span>, 0););</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160; </div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;  cache= cache_buff;</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &gt; 0 &amp;&amp;</div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;      (!<a class="code" href="../../db/da9/my__sys_8h.html#a893b39b108e444df21a123d6a8dcf9ed">my_disable_flush_key_blocks</a> || <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a>))</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;  {</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;    <span class="comment">/* Key cache exists and flush is not disabled */</span></div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= 0;</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">FLUSH_CACHE</a>;</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> **<a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a>,**end;</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *first_in_switch= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *last_in_flush;</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *last_for_update;</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>, *<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>;</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;    <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> cnt=0;</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160; </div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085ae7f30296faaf4f2833932412ecd03026">FLUSH_IGNORE_CHANGED</a>)</div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;    {</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;<span class="comment">         Count how many key blocks we have to cache to be able</span></div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;<span class="comment">         to flush all dirty pages with minimum seek moves</span></div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;      <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>= 0;</div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;      <span class="keywordflow">for</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)] ;</div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;           <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a> ;</div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;           <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed)</div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;      {</div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;        <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>) &amp;&amp;</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;            !(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>))</div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;        {</div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;          <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>++;</div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;          <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(count&lt;= keycache-&gt;blocks_used);</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;        }</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;      }</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;<span class="comment">        Allocate a new buffer only if its bigger than the one we have.</span></div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;<span class="comment">        Assure that we always have some entries for the case that new</span></div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;<span class="comment">        changed blocks appear while we need to wait for something.</span></div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a> &gt; <a class="code" href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">FLUSH_CACHE</a>) &amp;&amp;</div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;          !(cache= (<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>**) <a class="code" href="../../db/da9/my__sys_8h.html#a8f7b30ff5d0e10610637aa30c3e0048b">my_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>*)*<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>,</div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;                                            <a class="code" href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a>(0))))</div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;        cache= cache_buff;</div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;<span class="comment">        After a restart there could be more changed blocks than now.</span></div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;<span class="comment">        So we should not let count become smaller than the fixed buffer.</span></div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;      <span class="keywordflow">if</span> (cache == cache_buff)</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;        <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">FLUSH_CACHE</a>;</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;    }</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160; </div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;    <span class="comment">/* Retrieve the blocks and write them to a buffer to be flushed */</span></div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;restart:</div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;    last_in_flush= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;    last_for_update= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;    end= (<a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a>= cache)+<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>;</div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)] ;</div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;         <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a> ;</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;         <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>)</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;    {</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;      cnt++;</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(cnt &lt;= keycache-&gt;blocks_used);</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;      <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed;</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;      {</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;        <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)))</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;        {</div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;<span class="comment">            Note: The special handling of BLOCK_IN_SWITCH is obsolete</span></div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;<span class="comment">            since we set BLOCK_IN_FLUSH if the eviction includes a</span></div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;<span class="comment">            flush. It can be removed in a later version.</span></div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;          <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>))</div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;          {</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;<span class="comment">              We care only for the blocks for which flushing was not</span></div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;<span class="comment">              initiated by another thread and which are not in eviction.</span></div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;<span class="comment">              Registering a request on the block unlinks it from the LRU</span></div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;<span class="comment">              ring and protects against eviction.</span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085ae7f30296faaf4f2833932412ecd03026">FLUSH_IGNORE_CHANGED</a>)</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;            {</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;              <span class="comment">/* It&#39;s not a temporary file */</span></div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a> == end)</div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;              {</div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;<span class="comment">                  This should happen relatively seldom. Remove the</span></div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;<span class="comment">                  request because we won&#39;t do anything with the block</span></div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;<span class="comment">                  but restart and pick it again in the next iteration.</span></div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;<span class="comment">                */</span></div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 0);</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;<span class="comment">                  This happens only if there is not enough</span></div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;<span class="comment">                  memory for the big block</span></div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;<span class="comment">                */</span></div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;                <span class="keywordflow">if</span> ((<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a52cb7c1e487c6dc5bfaa36f9883df371">flush_cached_blocks</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, cache,</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;                                                end,<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>)))</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;                {</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;                  <span class="comment">/* Do not loop infinitely trying to flush in vain. */</span></div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;                  <span class="keywordflow">if</span> ((last_errno == <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>) &amp;&amp; (++last_errcnt &gt; 5))</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;                    <span class="keywordflow">goto</span> err;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;                  last_errno= <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>;</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;                }</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;<span class="comment">                  Restart the scan as some other thread might have changed</span></div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;<span class="comment">                  the changed blocks chain: the blocks that were in switch</span></div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;<span class="comment">                  state before the flush started have to be excluded</span></div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;<span class="comment">                */</span></div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;                <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;              }</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;<span class="comment">                Mark the block with BLOCK_IN_FLUSH in order not to let</span></div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;<span class="comment">                other threads to use it for new pages and interfere with</span></div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;<span class="comment">                our sequence of flushing dirty file pages. We must not</span></div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;<span class="comment">                set this flag before actually putting the block on the</span></div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;<span class="comment">                write burst array called &#39;cache&#39;.</span></div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;              <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status|= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>;</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;              <span class="comment">/* Add block to the array for a write burst. */</span></div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;              *<a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a>++= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;            }</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;            {</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;              <span class="comment">/* It&#39;s a temporary file */</span></div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;              <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>));</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;<span class="comment">                free_block() must not be called with BLOCK_CHANGED. Note</span></div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;<span class="comment">                that we must not change the BLOCK_CHANGED flag outside of</span></div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;<span class="comment">                link_to_file_list() so that it is always in the correct</span></div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;<span class="comment">                queue and the *blocks_changed counters are correct.</span></div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, 1);</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;              <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a>)))</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;              {</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;                <span class="comment">/* A request has been registered against the block above. */</span></div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;              }</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;              {</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;<span class="comment">                  Link the block into the LRU ring if it&#39;s the last</span></div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;<span class="comment">                  submitted request for the block. This enables eviction</span></div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;<span class="comment">                  for the block. A request has been registered against</span></div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;<span class="comment">                  the block above.</span></div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;<span class="comment">                */</span></div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;                <a class="code" href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;              }</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;            }</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;          }</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;          {</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;<span class="comment">              Link the block into a list of blocks &#39;in switch&#39;.</span></div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;<span class="comment">              WARNING: Here we introduce a place where a changed block</span></div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;<span class="comment">              is not in the changed_blocks hash! This is acceptable for</span></div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;<span class="comment">              a BLOCK_IN_SWITCH. Never try this for another situation.</span></div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;<span class="comment">              Other parts of the key cache code rely on changed blocks</span></div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;<span class="comment">              being in the changed_blocks hash.</span></div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;            <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">link_changed</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>, &amp;first_in_switch);</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;          }</div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;        }</div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a>)</div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;        {</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;<span class="comment">            During the normal flush at end of statement (FLUSH_KEEP) we</span></div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;<span class="comment">            do not need to ensure that blocks in flush or update by</span></div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;<span class="comment">            other threads are flushed. They will be flushed by them</span></div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;<span class="comment">            later. In all other cases we must assure that we do not have</span></div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;<span class="comment">            any changed block of this file in the cache when this</span></div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;<span class="comment">            function returns.</span></div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>)</div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;          {</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;            <span class="comment">/* Remember the last block found to be in flush. */</span></div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;            last_in_flush= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;          }</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;          {</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;            <span class="comment">/* Remember the last block found to be selected for update. */</span></div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;            last_for_update= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;          }</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;        }</div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;      }</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;    }</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a> != cache)</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;    {</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a52cb7c1e487c6dc5bfaa36f9883df371">flush_cached_blocks</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, cache, <a class="code" href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a>, <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>)))</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;      {</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;        <span class="comment">/* Do not loop inifnitely trying to flush in vain. */</span></div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;        <span class="keywordflow">if</span> ((last_errno == <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>) &amp;&amp; (++last_errcnt &gt; 5))</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;          <span class="keywordflow">goto</span> err;</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;        last_errno= <a class="code" href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a>;</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;      }</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;<span class="comment">        Do not restart here during the normal flush at end of statement</span></div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;<span class="comment">        (FLUSH_KEEP). We have now flushed at least all blocks that were</span></div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;<span class="comment">        changed when entering this function. In all other cases we must</span></div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;<span class="comment">        assure that we do not have any changed block of this file in the</span></div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;<span class="comment">        cache when this function returns.</span></div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a>)</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;        <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;    }</div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;    <span class="keywordflow">if</span> (last_in_flush)</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;    {</div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;<span class="comment">        There are no blocks to be flushed by this thread, but blocks in</span></div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;<span class="comment">        flush by other threads. Wait until one of the blocks is flushed.</span></div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;<span class="comment">        Re-check the condition for last_in_flush. We may have unlocked</span></div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;<span class="comment">        the cache_lock in flush_cached_blocks(). The state of the block</span></div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;<span class="comment">        could have changed.</span></div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;      <span class="keywordflow">if</span> (last_in_flush-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">status</a> &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a>)</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;last_in_flush-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>],</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;                      &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;      <span class="comment">/* Be sure not to lose a block. They may be flushed in random order. */</span></div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;      <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;    }</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;    <span class="keywordflow">if</span> (last_for_update)</div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;    {</div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;<span class="comment">        There are no blocks to be flushed by this thread, but blocks for</span></div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;<span class="comment">        update by other threads. Wait until one of the blocks is updated.</span></div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;<span class="comment">        Re-check the condition for last_for_update. We may have unlocked</span></div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;<span class="comment">        the cache_lock in flush_cached_blocks(). The state of the block</span></div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;<span class="comment">        could have changed.</span></div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;      <span class="keywordflow">if</span> (last_for_update-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">status</a> &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;last_for_update-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>],</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;                      &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;      <span class="comment">/* The block is now changed. Flush it. */</span></div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;      <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;    }</div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160; </div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;<span class="comment">      Wait until the list of blocks in switch is empty. The threads that</span></div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;<span class="comment">      are switching these blocks will relink them to clean file chains</span></div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;<span class="comment">      while we wait and thus empty the &#39;first_in_switch&#39; chain.</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;    <span class="keywordflow">while</span> (first_in_switch)</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;    {</div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;      cnt= 0;</div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;first_in_switch-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>],</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;                    &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;      cnt++;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(cnt &lt;= keycache-&gt;blocks_used);</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;<span class="comment">        Do not restart here. We have flushed all blocks that were</span></div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;<span class="comment">        changed when entering this function and were not marked for</span></div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;<span class="comment">        eviction. Other threads have now flushed all remaining blocks in</span></div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;<span class="comment">        the course of their eviction.</span></div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;    }</div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160; </div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;    <span class="keywordflow">if</span> (! (<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a> || <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a371968d6faccf6bb3c78f25f97bf15b5">FLUSH_FORCE_WRITE</a>))</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;    {</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;      <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *last_for_update= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;      <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *last_in_switch= <a class="code" href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a>;</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> total_found= 0;</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;      <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> found;</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160; </div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;<span class="comment">        Finally free all clean blocks for this file.</span></div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;<span class="comment">        During resize this may be run by two threads in parallel.</span></div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;      <span class="keywordflow">do</span></div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;      {</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;        found= 0;</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)] ;</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;             <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a> ;</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;             <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>)</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;        {</div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;          <span class="comment">/* Remember the next block. After freeing we cannot get at it. */</span></div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;          <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed;</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160; </div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;          <span class="comment">/* Changed blocks cannot appear in the file_blocks hash. */</span></div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;          <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a>));</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file == <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)</div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;          {</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;            <span class="comment">/* We must skip blocks that will be changed. */</span></div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>)</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;            {</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;              last_for_update= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;              <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;            }</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160; </div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;<span class="comment">              We must not free blocks in eviction (BLOCK_IN_EVICTION |</span></div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;<span class="comment">              BLOCK_IN_SWITCH) or blocks intended to be freed</span></div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;<span class="comment">              (BLOCK_REASSIGNED).</span></div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;            <span class="keywordflow">if</span> (!(<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> | <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;                                   <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>)))</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;            {</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;              <span class="keyword">struct </span><a class="code" href="../../df/d23/structst__hash__link.html">st_hash_link</a> *<a class="code" href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a>(next_hash_link);</div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;              <a class="code" href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a> <a class="code" href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a>(next_diskpos);</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;              <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a>(next_file);</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;              <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a>(next_status);</div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;              <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a>(hash_requests);</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160; </div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;              total_found++;</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;              found++;</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(found &lt;= keycache-&gt;blocks_used);</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160; </div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;<span class="comment">                Register a request. This unlinks the block from the LRU</span></div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;<span class="comment">                ring and protects it against eviction. This is required</span></div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;<span class="comment">                by free_block().</span></div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>, 1);</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160; </div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;<span class="comment">                free_block() may need to wait for readers of the block.</span></div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;<span class="comment">                This is the moment where the other thread can move the</span></div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;<span class="comment">                &#39;next&#39; block from the chain. free_block() needs to wait</span></div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;<span class="comment">                if there are requests for the block pending.</span></div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a> &amp;&amp; (hash_requests= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;requests))</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;              {</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;                <span class="comment">/* Copy values from the &#39;next&#39; block and its hash_link. */</span></div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;                next_status=    <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>-&gt;status;</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;                next_hash_link= <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>-&gt;hash_link;</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;                next_diskpos=   next_hash_link-&gt;diskpos;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;                next_file=      next_hash_link-&gt;file;</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;                <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a> == next_hash_link-&gt;block);</div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;              }</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160; </div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;              <span class="comment">/*</span></div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;<span class="comment">                If we had to wait and the state of the &#39;next&#39; block</span></div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;<span class="comment">                changed, break the inner loop. &#39;next&#39; may no longer be</span></div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;<span class="comment">                part of the current chain.</span></div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;<span class="comment">                We do not want to break the loop after every free_block(),</span></div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;<span class="comment">                not even only after waits. The chain might be quite long</span></div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;<span class="comment">                and contain blocks for many files. Traversing it again and</span></div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;<span class="comment">                again to find more blocks for this file could become quite</span></div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;<span class="comment">                inefficient.</span></div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;<span class="comment">              */</span></div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a> &amp;&amp; hash_requests &amp;&amp;</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;                  ((next_status    != <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>-&gt;status) ||</div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;                   (next_hash_link != <a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>-&gt;hash_link) ||</div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;                   (next_file      != next_hash_link-&gt;file) ||</div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;                   (next_diskpos   != next_hash_link-&gt;diskpos) ||</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;                   (<a class="code" href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a>           != next_hash_link-&gt;block)))</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;            }</div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;            {</div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;              last_in_switch= <a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;            }</div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;          }</div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;        } <span class="comment">/* end for block in file_blocks */</span></div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;      } <span class="keywordflow">while</span> (found);</div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160; </div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;<span class="comment">        If any clean block has been found, we may have waited for it to</span></div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;<span class="comment">        become free. In this case it could be possible that another clean</span></div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;<span class="comment">        block became dirty. This is possible if the write request existed</span></div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;<span class="comment">        before the flush started (BLOCK_FOR_UPDATE). Re-check the hashes.</span></div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;      <span class="keywordflow">if</span> (total_found)</div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;        <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160; </div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;<span class="comment">        To avoid an infinite loop, wait until one of the blocks marked</span></div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;<span class="comment">        for update is updated.</span></div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;      <span class="keywordflow">if</span> (last_for_update)</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;      {</div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;        <span class="comment">/* We did not wait. Block must not have changed status. */</span></div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(last_for_update-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">status</a> &amp; <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a>);</div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;last_for_update-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a>],</div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;                      &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;        <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;      }</div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160; </div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;      <span class="comment">/*</span></div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;<span class="comment">        To avoid an infinite loop wait until one of the blocks marked</span></div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;<span class="comment">        for eviction is switched.</span></div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;<span class="comment">      */</span></div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;      <span class="keywordflow">if</span> (last_in_switch)</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;      {</div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;        <span class="comment">/* We did not wait. Block must not have changed status. */</span></div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;        <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(last_in_switch-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">status</a> &amp; (<a class="code" href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a> |</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;                                              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a> |</div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;                                              <a class="code" href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a>));</div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;        <a class="code" href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a>(&amp;last_in_switch-&gt;<a class="code" href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">wqueue</a>[<a class="code" href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a>],</div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;                      &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;        <span class="keywordflow">goto</span> restart;</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;      }</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160; </div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;    } <span class="comment">/* if (! (type == FLUSH_KEEP || type == FLUSH_FORCE_WRITE)) */</span></div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160; </div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;  } <span class="comment">/* if (keycache-&gt;disk_blocks &gt; 0 */</span></div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160; </div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;<span class="preprocessor">#ifndef DBUG_OFF</span></div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a>(<span class="stringliteral">&quot;check_keycache&quot;</span>,</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;               <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(keycache, <span class="stringliteral">&quot;end of flush_key_blocks&quot;</span>, 0););</div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;err:</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;  <span class="keywordflow">if</span> (cache != cache_buff)</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;    <a class="code" href="../../db/da9/my__sys_8h.html#a3a3ddffcaadb60b7715c9889f8c56afb">my_free</a>(cache);</div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;  <span class="keywordflow">if</span> (last_errno)</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;    <a class="code" href="../../db/da9/my__sys_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>=last_errno;                <span class="comment">/* Return first error */</span></div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(last_errno != 0);</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;}</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160; </div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160; </div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;<span class="comment">  Flush all blocks for a file to disk</span></div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;<span class="comment">    flush_key_blocks()</span></div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;<span class="comment">      keycache            pointer to a key cache data structure</span></div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;<span class="comment">      file                handler for the file to flush to</span></div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;<span class="comment">      flush_type          type of the flush</span></div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;<span class="comment">    0   ok</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;<span class="comment">    1  error</span></div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160; </div>
<div class="line"><a name="l04035"></a><span class="lineno"><a class="line" href="../../de/dc2/keycache_8h.html#ab6a625aa0f0d33a125d42f8520db4ce9"> 4035</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ad4d6c001c818692b83d4303532f17dba">flush_key_blocks</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache,</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;                     <a class="code" href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <span class="keyword">enum</span> <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085">flush_type</a> <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>)</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;{</div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;  <span class="keywordtype">int</span> res= 0;</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;flush_key_blocks&quot;</span>);</div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;enter&quot;</span>, (<span class="stringliteral">&quot;keycache: 0x%lx&quot;</span>, (<span class="keywordtype">long</span>) keycache));</div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160; </div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;  <span class="keywordflow">if</span> (!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160; </div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;  <span class="comment">/* While waiting for lock, keycache could have been ended. */</span></div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &gt; 0)</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;  {</div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;    res= <a class="code" href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807">flush_key_blocks_int</a>(keycache, <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a>);</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;    <a class="code" href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a>(keycache);</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;  }</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(res);</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;}</div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160; </div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160; </div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;<span class="comment">  Flush all blocks in the key cache to disk.</span></div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;<span class="comment">    flush_all_key_blocks()</span></div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;<span class="comment">      keycache                  pointer to key cache root structure</span></div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;<span class="comment">  DESCRIPTION</span></div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;<span class="comment">    Flushing of the whole key cache is done in two phases.</span></div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;<span class="comment">    1. Flush all changed blocks, waiting for them if necessary. Loop</span></div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;<span class="comment">    until there is no changed block left in the cache.</span></div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;<span class="comment">    2. Free all clean blocks. Normally this means free all blocks. The</span></div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;<span class="comment">    changed blocks were flushed in phase 1 and became clean. However we</span></div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;<span class="comment">    may need to wait for blocks that are read by other threads. While we</span></div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;<span class="comment">    wait, a clean block could become changed if that operation started</span></div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;<span class="comment">    before the resize operation started. To be safe we must restart at</span></div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;<span class="comment">    phase 1.</span></div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;<span class="comment">    When we can run through the changed_blocks and file_blocks hashes</span></div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;<span class="comment">    without finding a block any more, then we are done.</span></div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;<span class="comment">    Note that we hold keycache-&gt;cache_lock all the time unless we need</span></div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;<span class="comment">    to wait for something.</span></div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;<span class="comment">    0           OK</span></div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;<span class="comment">    != 0        Error</span></div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160; </div>
<div class="line"><a name="l04090"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a5e9e1708936ac404c45527d26958ae16"> 4090</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5e9e1708936ac404c45527d26958ae16">flush_all_key_blocks</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache)</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;{</div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a>    *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>          total_found;</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>          found;</div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>          <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>;</div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;flush_all_key_blocks&quot;</span>);</div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160; </div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;  {</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;    <a class="code" href="../../de/d55/group___thread__instrumentation.html#gaccf61aa4a9e6108ac938a184d7b8efd7">mysql_mutex_assert_owner</a>(&amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">cache_lock</a>);</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;    total_found= 0;</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160; </div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;<span class="comment">      Phase1: Flush all changed blocks, waiting for them if necessary.</span></div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;<span class="comment">      Loop until there is no changed block left in the cache.</span></div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;    {</div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;      found= 0;</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;      <span class="comment">/* Step over the whole changed_blocks hash array. */</span></div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;      <span class="keywordflow">for</span> (<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>= 0; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a> &lt; <a class="code" href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a>; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>++)</div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;      {</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;<span class="comment">          If an array element is non-empty, use the first block from its</span></div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;<span class="comment">          chain to find a file for flush. All changed blocks for this</span></div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;<span class="comment">          file are flushed. So the same block will not appear at this</span></div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;<span class="comment">          place again with the next iteration. New writes for blocks are</span></div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;<span class="comment">          not accepted during the flush. If multiple files share the</span></div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;<span class="comment">          same hash bucket, one of them will be flushed per iteration</span></div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;<span class="comment">          of the outer loop of phase 1.</span></div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;        <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>]))</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;        {</div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;          found++;</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;          <span class="comment">/*</span></div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;<span class="comment">            Flush dirty blocks but do not free them yet. They can be used</span></div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;<span class="comment">            for reading until all other blocks are flushed too.</span></div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;<span class="comment">          */</span></div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807">flush_key_blocks_int</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file,</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;                                   <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a371968d6faccf6bb3c78f25f97bf15b5">FLUSH_FORCE_WRITE</a>))</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;            <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(1);</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;        }</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;      }</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160; </div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;    } <span class="keywordflow">while</span> (found);</div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160; </div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;<span class="comment">      Phase 2: Free all clean blocks. Normally this means free all</span></div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;<span class="comment">      blocks. The changed blocks were flushed in phase 1 and became</span></div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;<span class="comment">      clean. However we may need to wait for blocks that are read by</span></div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;<span class="comment">      other threads. While we wait, a clean block could become changed</span></div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;<span class="comment">      if that operation started before the resize operation started. To</span></div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;<span class="comment">      be safe we must restart at phase 1.</span></div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;    {</div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;      found= 0;</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;      <span class="comment">/* Step over the whole file_blocks hash array. */</span></div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;      <span class="keywordflow">for</span> (<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>= 0; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a> &lt; <a class="code" href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a>; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>++)</div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;      {</div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;<span class="comment">          If an array element is non-empty, use the first block from its</span></div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;<span class="comment">          chain to find a file for flush. All blocks for this file are</span></div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;<span class="comment">          freed. So the same block will not appear at this place again</span></div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;<span class="comment">          with the next iteration. If multiple files share the</span></div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;<span class="comment">          same hash bucket, one of them will be flushed per iteration</span></div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;<span class="comment">          of the outer loop of phase 2.</span></div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;        <span class="keywordflow">if</span> ((<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>[<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>]))</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;        {</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;          total_found++;</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;          found++;</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807">flush_key_blocks_int</a>(keycache, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link-&gt;file,</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;                                   <a class="code" href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a33df826353611ec2c130ed9dddb83820">FLUSH_RELEASE</a>))</div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;            <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(1);</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;        }</div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;      }</div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160; </div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;    } <span class="keywordflow">while</span> (found);</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160; </div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;<span class="comment">      If any clean block has been found, we may have waited for it to</span></div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;<span class="comment">      become free. In this case it could be possible that another clean</span></div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;<span class="comment">      block became dirty. This is possible if the write request existed</span></div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;<span class="comment">      before the resize started (BLOCK_FOR_UPDATE). Re-check the hashes.</span></div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;  } <span class="keywordflow">while</span> (total_found);</div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160; </div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;<span class="preprocessor">#ifndef DBUG_OFF</span></div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;  <span class="comment">/* Now there should not exist any block any more. */</span></div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;  <span class="keywordflow">for</span> (<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>= 0; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a> &lt; <a class="code" href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a>; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>++)</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;  {</div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">changed_blocks</a>[<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>]);</div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;    <a class="code" href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a>(!keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">file_blocks</a>[<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>]);</div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;  }</div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160; </div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;}</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160; </div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160; </div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;<span class="comment">  Reset the counters of a key cache.</span></div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;<span class="comment">  SYNOPSIS</span></div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;<span class="comment">    reset_key_cache_counters()</span></div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;<span class="comment">    name       the name of a key cache</span></div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;<span class="comment">    key_cache  pointer to the key kache to be reset</span></div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;<span class="comment">  DESCRIPTION</span></div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;<span class="comment">   This procedure is used by process_key_caches() to reset the counters of all</span></div>
<div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;<span class="comment">   currently used key caches, both the default one and the named ones.</span></div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;<span class="comment">  RETURN</span></div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;<span class="comment">    0 on success (always because it can&#39;t fail)</span></div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160; </div>
<div class="line"><a name="l04208"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1e2a758165a0facc9cae15407a294eff"> 4208</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1e2a758165a0facc9cae15407a294eff">reset_key_cache_counters</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">name</a> <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)),</div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;                             <a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *key_cache)</div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;{</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a>(<span class="stringliteral">&quot;reset_key_cache_counters&quot;</span>);</div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;  <span class="keywordflow">if</span> (!key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">key_cache_inited</a>)</div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;  {</div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;info&quot;</span>, (<span class="stringliteral">&quot;Key cache %s not initialized.&quot;</span>, <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">name</a>));</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;    <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;  }</div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a>(<span class="stringliteral">&quot;info&quot;</span>, (<span class="stringliteral">&quot;Resetting counters for key cache %s.&quot;</span>, <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">name</a>));</div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160; </div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;  key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">global_blocks_changed</a>= 0;   <span class="comment">/* Key_blocks_not_flushed */</span></div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;  key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">global_cache_r_requests</a>= 0; <span class="comment">/* Key_read_requests */</span></div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;  key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">global_cache_read</a>= 0;       <span class="comment">/* Key_reads */</span></div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;  key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">global_cache_w_requests</a>= 0; <span class="comment">/* Key_write_requests */</span></div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;  key_cache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">global_cache_write</a>= 0;      <span class="comment">/* Key_writes */</span></div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;  <a class="code" href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a>(0);</div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;}</div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160; </div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160; </div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;<span class="preprocessor">#ifndef DBUG_OFF</span></div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;<span class="comment">  Test if disk-cache is ok</span></div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l04232"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ac6ab2c1f00596c26a9c0e51809a72389"> 4232</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)),</div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;                           <span class="keyword">const</span> <span class="keywordtype">char</span> *where <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)),</div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;                           <a class="code" href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a> lock <a class="code" href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a>((unused)))</div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;{</div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;  <span class="comment">/* TODO */</span></div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;}</div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160; </div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_TIMEOUT)</span></div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160; </div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;<span class="preprocessor">#define KEYCACHE_DUMP_FILE  &quot;keycache_dump.txt&quot;</span></div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;<span class="preprocessor">#define MAX_QUEUE_LEN  100</span></div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160; </div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160; </div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> keycache_dump(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache)</div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;{</div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;  FILE *keycache_dump_file=fopen(KEYCACHE_DUMP_FILE, <span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *last;</div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;  <span class="keyword">struct </span><a class="code" href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a> *thread;</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;  <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a>;</div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;  <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link;</div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;  <a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *page;</div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;  <a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i;</div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160; </div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;  <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;thread:%u\n&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>);</div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160; </div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;  i=0;</div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;  thread=last=waiting_for_hash_link.last_thread;</div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;  <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;queue of threads waiting for hash link\n&quot;</span>);</div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;  <span class="keywordflow">if</span> (thread)</div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;    {</div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;      thread=thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;      page= (<a class="code" href="../../d1/d62/structst__keycache__page.html">KEYCACHE_PAGE</a> *) thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>;</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file,</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;              <span class="stringliteral">&quot;thread:%u, (file,filepos)=(%u,%lu)\n&quot;</span>,</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;              thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">file</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) page-&gt;<a class="code" href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">filepos</a>);</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;      <span class="keywordflow">if</span> (++i == MAX_QUEUE_LEN)</div>
<div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;    }</div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;    <span class="keywordflow">while</span> (thread != last);</div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160; </div>
<div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;  i=0;</div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;  thread=last=waiting_for_block.last_thread;</div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;  <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;queue of threads waiting for block\n&quot;</span>);</div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;  <span class="keywordflow">if</span> (thread)</div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;    {</div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;      thread=thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;      hash_link= (<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *) thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">opt_info</a>;</div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file,</div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;        <span class="stringliteral">&quot;thread:%u hash_link:%u (file,filepos)=(%u,%lu)\n&quot;</span>,</div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;        thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>, (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ac6a20acf7c4e32dd0daa72a96d4381">HASH_LINK_NUMBER</a>(hash_link),</div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;        (<a class="code" href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>,(<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>);</div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;      <span class="keywordflow">if</span> (++i == MAX_QUEUE_LEN)</div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;    }</div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;    <span class="keywordflow">while</span> (thread != last);</div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160; </div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;  <span class="keywordflow">for</span> (i=0 ; i&lt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a> ; i++)</div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;  {</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;    <span class="keywordtype">int</span> j;</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;    <a class="code" href="../../de/d36/structblock__.html">block</a>= &amp;keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a>[i];</div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;    hash_link= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link;</div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file,</div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;            <span class="stringliteral">&quot;block:%u hash_link:%d status:%x #requests=%u waiting_for_readers:%d\n&quot;</span>,</div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;            i, (<span class="keywordtype">int</span>) (hash_link ? <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9ac6a20acf7c4e32dd0daa72a96d4381">HASH_LINK_NUMBER</a>(hash_link) : -1),</div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;            <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;condvar ? 1 : 0);</div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;    <span class="keywordflow">for</span> (j=0 ; j &lt; 2; j++)</div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;    {</div>
<div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;      <a class="code" href="../../d6/d3e/structst__keycache__wqueue.html">KEYCACHE_WQUEUE</a> *wqueue=&amp;<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;wqueue[j];</div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;      thread= last= wqueue-&gt;<a class="code" href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">last_thread</a>;</div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;queue #%d\n&quot;</span>, j);</div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;      <span class="keywordflow">if</span> (thread)</div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;      {</div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;        <span class="keywordflow">do</span></div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;        {</div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;          thread=thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">next</a>;</div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;          <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file,</div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;                  <span class="stringliteral">&quot;thread:%u\n&quot;</span>, thread-&gt;<a class="code" href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">id</a>);</div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;          <span class="keywordflow">if</span> (++i == MAX_QUEUE_LEN)</div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;        }</div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;        <span class="keywordflow">while</span> (thread != last);</div>
<div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;      }</div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;    }</div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;  }</div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;  <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;LRU chain:&quot;</span>);</div>
<div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;  <a class="code" href="../../de/d36/structblock__.html">block</a>= keycache= used_last;</div>
<div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;  {</div>
<div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;    {</div>
<div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;      <a class="code" href="../../de/d36/structblock__.html">block</a>= <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used;</div>
<div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file,</div>
<div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;              <span class="stringliteral">&quot;block:%u, &quot;</span>, <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>));</div>
<div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;    }</div>
<div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="../../de/d36/structblock__.html">block</a> != keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">used_last</a>);</div>
<div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;  }</div>
<div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;  <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_dump_file, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160; </div>
<div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;  fclose(keycache_dump_file);</div>
<div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;}</div>
<div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160; </div>
<div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_TIMEOUT) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160; </div>
<div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_TIMEOUT) &amp;&amp; !defined(__WIN__)</span></div>
<div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160; </div>
<div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160; </div>
<div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(<a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> *cond,</div>
<div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;                                      <a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *<a class="code" href="../../de/d9e/structst__my__thread__var.html#aa65ed44b8f48d67dd074ff4139ea1ee2">mutex</a>)</div>
<div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;{</div>
<div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;  <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;  <span class="keyword">struct </span>timeval  now;            <span class="comment">/* time when we started waiting        */</span></div>
<div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;  <span class="keyword">struct </span>timespec timeout;        <span class="comment">/* timeout value for the wait function */</span></div>
<div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;  <span class="keyword">struct </span>timezone tz;</div>
<div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;  <span class="keywordtype">int</span> cnt=0;</div>
<div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160; </div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;  <span class="comment">/* Get current time */</span></div>
<div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;  gettimeofday(&amp;now, &amp;tz);</div>
<div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;  <span class="comment">/* Prepare timeout value */</span></div>
<div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;  timeout.tv_sec= now.tv_sec + KEYCACHE_TIMEOUT;</div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160; <span class="comment">/*</span></div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;<span class="comment">   timeval uses microseconds.</span></div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;<span class="comment">   timespec uses nanoseconds.</span></div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;<span class="comment">   1 nanosecond = 1000 micro seconds</span></div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;  timeout.tv_nsec= now.tv_usec * 1000;</div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5be6b9a8727840f3707d846228fbe51f">KEYCACHE_THREAD_TRACE_END</a>(<span class="stringliteral">&quot;started waiting&quot;</span>);</div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;  cnt++;</div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;  <span class="keywordflow">if</span> (cnt % 100 == 0)</div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_debug_log, <span class="stringliteral">&quot;waiting...\n&quot;</span>);</div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;    fflush(keycache_debug_log);</div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;  rc= <a class="code" href="../../de/d55/group___thread__instrumentation.html#ga835e97f258f7c4c78e24ffff723f0bea">mysql_cond_timedwait</a>(cond, mutex, &amp;timeout);</div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b494c4988b087161e4073fbd4b595aa">KEYCACHE_THREAD_TRACE_BEGIN</a>(<span class="stringliteral">&quot;finished waiting&quot;</span>);</div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;  <span class="keywordflow">if</span> (rc == ETIMEDOUT || rc == <a class="code" href="../../da/da8/my__pthread_8h.html#ab59cf3c65eaf836d5c647fa2a24ca649">ETIME</a>)</div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;  {</div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(keycache_debug_log,<span class="stringliteral">&quot;aborted by keycache timeout\n&quot;</span>);</div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;    fclose(keycache_debug_log);</div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;    abort();</div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;    keycache_dump();</div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;  }</div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160; </div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a>(rc != ETIMEDOUT);</div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;  <a class="code" href="../../dd/d7f/emitter_8h.html#a7f6f984a70f2a669b89e3f10c795932f">assert</a>(rc != ETIMEDOUT);</div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;  <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;}</div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a>(<a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> *cond,</div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;                                      <a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex)</div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;{</div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;  <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5be6b9a8727840f3707d846228fbe51f">KEYCACHE_THREAD_TRACE_END</a>(<span class="stringliteral">&quot;started waiting&quot;</span>);</div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;  rc= <a class="code" href="../../de/d55/group___thread__instrumentation.html#ga0094737fa36967b77033c500fd25d0ff">mysql_cond_wait</a>(cond, mutex);</div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b494c4988b087161e4073fbd4b595aa">KEYCACHE_THREAD_TRACE_BEGIN</a>(<span class="stringliteral">&quot;finished waiting&quot;</span>);</div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;  <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;}</div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_TIMEOUT) &amp;&amp; !defined(__WIN__) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160; </div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG)</span></div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160; </div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160; </div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a>(<a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex)</div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;{</div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;  <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;  rc= <a class="code" href="../../de/d55/group___thread__instrumentation.html#ga340bf8f49d0cbaa994eaf5fb1fc7a22f">mysql_mutex_lock</a>(mutex);</div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a9b494c4988b087161e4073fbd4b595aa">KEYCACHE_THREAD_TRACE_BEGIN</a>(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;  <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;}</div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160; </div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160; </div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a>(<a class="code" href="../../d0/d93/structst__mysql__mutex.html">mysql_mutex_t</a> *mutex)</div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;{</div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a5be6b9a8727840f3707d846228fbe51f">KEYCACHE_THREAD_TRACE_END</a>(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;  <a class="code" href="../../de/d55/group___thread__instrumentation.html#ga5c748d3c7862702885acb90576754a2c">mysql_mutex_unlock</a>(mutex);</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;}</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160; </div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160; </div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a>(<a class="code" href="../../d9/d27/structst__mysql__cond.html">mysql_cond_t</a> *cond)</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;{</div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;  <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a>(<span class="stringliteral">&quot;signal&quot;</span>);</div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;  rc= <a class="code" href="../../de/d55/group___thread__instrumentation.html#gae34d5c956bc219ef45fbece509d3cf40">mysql_cond_signal</a>(cond);</div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;  <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;}</div>
<div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160; </div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160; </div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG_LOG)</span></div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160; </div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160; </div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> keycache_debug_print(<span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="../../d4/d7a/fmt_8cc.html#a7fb945a0739ee85a6cb82424f6043d27">fmt</a>,...)</div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;{</div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;  va_list args;</div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;  va_start(args,<a class="code" href="../../d4/d7a/fmt_8cc.html#a7fb945a0739ee85a6cb82424f6043d27">fmt</a>);</div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;  <span class="keywordflow">if</span> (keycache_debug_log)</div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;  {</div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;    (void) <a class="code" href="../../d3/d6b/printf_8h.html#a147f28e064ae3a469961c07d553bb31e">vfprintf</a>(keycache_debug_log, <a class="code" href="../../d4/d7a/fmt_8cc.html#a7fb945a0739ee85a6cb82424f6043d27">fmt</a>, args);</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;    (void) fputc(<span class="charliteral">&#39;\n&#39;</span>,keycache_debug_log);</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;  }</div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;  va_end(args);</div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;}</div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG_LOG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160; </div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;<span class="preprocessor">#if defined(KEYCACHE_DEBUG_LOG)</span></div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160; </div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160; </div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;<span class="keywordtype">void</span> keycache_debug_log_close(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;{</div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;  <span class="keywordflow">if</span> (keycache_debug_log)</div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;    fclose(keycache_debug_log);</div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;}</div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG_LOG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160; </div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* defined(KEYCACHE_DEBUG) */</span><span class="preprocessor"></span></div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160; </div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;<span class="preprocessor">#if !defined(DBUG_OFF)</span></div>
<div class="line"><a name="l04459"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506"> 4459</a></span>&#160;<span class="preprocessor">#define F_B_PRT(_f_, _v_) DBUG_PRINT(&quot;assert_fail&quot;</span>, (_f_, _v_))</div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160; </div>
<div class="line"><a name="l04461"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62"> 4461</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>)</div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;{</div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;next_used:    %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_used);</div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;prev_used:    %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_used);</div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;next_changed: %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;next_changed);</div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;prev_changed: %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;prev_changed);</div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;hash_link:    %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link);</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;status:       %u\n&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status);</div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;length:       %u\n&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;length);</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;offset:       %u\n&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;offset);</div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;requests:     %u\n&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests);</div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;block-&gt;temperature:  %u\n&quot;</span>, <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;temperature);</div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;  <span class="keywordflow">return</span> 0; <span class="comment">/* Let the assert fail. */</span></div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;}</div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160; </div>
<div class="line"><a name="l04476"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#aea0bccc76a000e75ef1905fd76dd640b"> 4476</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#aea0bccc76a000e75ef1905fd76dd640b">fail_hlink</a>(<a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hlink)</div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;{</div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;hlink-&gt;next:    %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hlink-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">next</a>);</div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;hlink-&gt;prev:    %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hlink-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">prev</a>);</div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;hlink-&gt;block:   %lx\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hlink-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>);</div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;hlink-&gt;diskpos: %lu\n&quot;</span>, (<a class="code" href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a>) hlink-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">diskpos</a>);</div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;  <a class="code" href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a>(<span class="stringliteral">&quot;hlink-&gt;file:    %d\n&quot;</span>, hlink-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">file</a>);</div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;  <span class="keywordflow">return</span> 0; <span class="comment">/* Let the assert fail. */</span></div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;}</div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160; </div>
<div class="line"><a name="l04486"></a><span class="lineno"><a class="line" href="../../d3/d26/mf__keycache_8c.html#ae2a0dda2a2b90dff2a89dd93c15149d2"> 4486</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/mf__keycache_8c.html#ae2a0dda2a2b90dff2a89dd93c15149d2">cache_empty</a>(<a class="code" href="../../d7/dcc/structst__key__cache.html">KEY_CACHE</a> *keycache)</div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;{</div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;  <span class="keywordtype">int</span> errcnt= 0;</div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>;</div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;  <span class="keywordflow">if</span> (keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a> &lt;= 0)</div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;  <span class="keywordflow">for</span> (<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>= 0; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a> &lt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>++)</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;  {</div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;    <a class="code" href="../../df/d94/structst__block__link.html">BLOCK_LINK</a> *<a class="code" href="../../de/d36/structblock__.html">block</a>= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">block_root</a> + <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>;</div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;status || <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;requests || <a class="code" href="../../de/d36/structblock__.html">block</a>-&gt;hash_link)</div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;    {</div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(stderr, <span class="stringliteral">&quot;block index: %u\n&quot;</span>, <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>);</div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a>(<a class="code" href="../../de/d36/structblock__.html">block</a>);</div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;      errcnt++;</div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;    }</div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;  }</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;  <span class="keywordflow">for</span> (<a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>= 0; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a> &lt; keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a>; <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>++)</div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;  {</div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;    <a class="code" href="../../df/d23/structst__hash__link.html">HASH_LINK</a> *hash_link= keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">hash_link_root</a> + <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>;</div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;    <span class="keywordflow">if</span> (hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">requests</a> || hash_link-&gt;<a class="code" href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">block</a>)</div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;    {</div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;      <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(stderr, <span class="stringliteral">&quot;hash_link index: %u\n&quot;</span>, <a class="code" href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a>);</div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;      <a class="code" href="../../d3/d26/mf__keycache_8c.html#aea0bccc76a000e75ef1905fd76dd640b">fail_hlink</a>(hash_link);</div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;      errcnt++;</div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;    }</div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;  }</div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;  <span class="keywordflow">if</span> (errcnt)</div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;  {</div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(stderr, <span class="stringliteral">&quot;blocks: %d  used: %lu\n&quot;</span>,</div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;            keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">disk_blocks</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">blocks_used</a>);</div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(stderr, <span class="stringliteral">&quot;hash_links: %d  used: %d\n&quot;</span>,</div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;            keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">hash_links</a>, keycache-&gt;<a class="code" href="../../d7/dcc/structst__key__cache.html#a01c4fedeb76ae5e06f29f7d1eeba7583">hash_links_used</a>);</div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;    <a class="code" href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a>(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;  }</div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;  <span class="keywordflow">return</span> !errcnt;</div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;}</div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160; </div>
<div class="ttc" id="a_c_make_lists_8txt_html_a0b5da418382bdd0db6dff439e2863979"><div class="ttname"><a href="../../dd/d68/_c_make_lists_8txt.html#a0b5da418382bdd0db6dff439e2863979">if</a></div><div class="ttdeci">NAME if(&quot;;${DISABLED_AC_MODULES};&quot; MATCHES &quot;;${MODULENAME};&quot;) continue() endif() if(EXISTS &quot;$</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d68/_c_make_lists_8txt_source.html#l00068">CMakeLists.txt:68</a></div></div>
<div class="ttc" id="a_define_8h_html_a22f78cc9780bf32aff91ae17c3101c8d"><div class="ttname"><a href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a></div><div class="ttdeci">std::uint32_t uint32</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d35/_define_8h_source.html#l00114">Define.h:114</a></div></div>
<div class="ttc" id="a_recast_contour_8cpp_html_af019d68006e1f2d7b24c8f09051424cc"><div class="ttname"><a href="../../de/d0e/_recast_contour_8cpp.html#af019d68006e1f2d7b24c8f09051424cc">next</a></div><div class="ttdeci">int next(int i, int n)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d0e/_recast_contour_8cpp_source.html#l00469">RecastContour.cpp:469</a></div></div>
<div class="ttc" id="aargon2_2argon2_2core_8h_html_a3bc85c944ae1cc783105da0f15ee6adc"><div class="ttname"><a href="../../d4/d21/argon2_2argon2_2core_8h.html#a3bc85c944ae1cc783105da0f15ee6adc">block</a></div><div class="ttdeci">struct block_ block</div></div>
<div class="ttc" id="abase64_8c_html_a5e75484d7880fa39b31f27c3d7058936"><div class="ttname"><a href="../../db/d36/base64_8c.html#a5e75484d7880fa39b31f27c3d7058936">pos</a></div><div class="ttdeci">static uint pos(unsigned char c)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d36/base64_8c_source.html#l00104">base64.c:104</a></div></div>
<div class="ttc" id="aclassvalue_html"><div class="ttname"><a href="../../d7/d71/classvalue.html">value</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01120">core.h:1120</a></div></div>
<div class="ttc" id="adbug__long_8h_html_a2d990f1c0bd095fcbac9c6596274be55"><div class="ttname"><a href="../../d1/d35/dbug__long_8h.html#a2d990f1c0bd095fcbac9c6596274be55">DBUG_VOID_RETURN</a></div><div class="ttdeci">#define DBUG_VOID_RETURN</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d35/dbug__long_8h_source.html#l00140">dbug_long.h:140</a></div></div>
<div class="ttc" id="adbug__long_8h_html_a3770d2ff545ed3e4b714d20014e663df"><div class="ttname"><a href="../../d1/d35/dbug__long_8h.html#a3770d2ff545ed3e4b714d20014e663df">DBUG_PRINT</a></div><div class="ttdeci">#define DBUG_PRINT(keyword, arglist)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d35/dbug__long_8h_source.html#l00143">dbug_long.h:143</a></div></div>
<div class="ttc" id="adbug__long_8h_html_a56a51e0edb39d13c83021fd4e7bdc9e9"><div class="ttname"><a href="../../d1/d35/dbug__long_8h.html#a56a51e0edb39d13c83021fd4e7bdc9e9">DBUG_ENTER</a></div><div class="ttdeci">#define DBUG_ENTER(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d35/dbug__long_8h_source.html#l00131">dbug_long.h:131</a></div></div>
<div class="ttc" id="adbug__long_8h_html_aed05b1b6230491c0e3c7d22413edb628"><div class="ttname"><a href="../../d1/d35/dbug__long_8h.html#aed05b1b6230491c0e3c7d22413edb628">DBUG_EXECUTE</a></div><div class="ttdeci">#define DBUG_EXECUTE(keyword, a1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d35/dbug__long_8h_source.html#l00141">dbug_long.h:141</a></div></div>
<div class="ttc" id="adbug__long_8h_html_af63d1bddf8957387d14fe70b8db22b96"><div class="ttname"><a href="../../d1/d35/dbug__long_8h.html#af63d1bddf8957387d14fe70b8db22b96">DBUG_RETURN</a></div><div class="ttdeci">#define DBUG_RETURN(a1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d35/dbug__long_8h_source.html#l00138">dbug_long.h:138</a></div></div>
<div class="ttc" id="aemitter_8h_html_a7f6f984a70f2a669b89e3f10c795932f"><div class="ttname"><a href="../../dd/d7f/emitter_8h.html#a7f6f984a70f2a669b89e3f10c795932f">assert</a></div><div class="ttdeci">assert(written&lt; out_size)</div></div>
<div class="ttc" id="afmt_2include_2fmt_2core_8h_html_a501bb1bb2f0cc5706178ed237958e73b"><div class="ttname"><a href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a></div><div class="ttdeci">constexpr auto count() -&gt; size_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01039">core.h:1039</a></div></div>
<div class="ttc" id="afmt_2include_2fmt_2core_8h_html_a7aead736a07eaf25623ad7bfa1f0ee2d"><div class="ttname"><a href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7aead736a07eaf25623ad7bfa1f0ee2d">type</a></div><div class="ttdeci">type</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01048">core.h:1048</a></div></div>
<div class="ttc" id="afmt_2include_2fmt_2core_8h_html_a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297"><div class="ttname"><a href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">arg_id_kind::name</a></div><div class="ttdeci">@ name</div></div>
<div class="ttc" id="afmt_8cc_html_a7fb945a0739ee85a6cb82424f6043d27"><div class="ttname"><a href="../../d4/d7a/fmt_8cc.html#a7fb945a0739ee85a6cb82424f6043d27">fmt</a></div><div class="ttdeci">export module fmt</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d7a/fmt_8cc_source.html#l00071">fmt.cc:71</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_ga0094737fa36967b77033c500fd25d0ff"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#ga0094737fa36967b77033c500fd25d0ff">mysql_cond_wait</a></div><div class="ttdeci">#define mysql_cond_wait(C, M)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00481">mysql_thread.h:481</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_ga340bf8f49d0cbaa994eaf5fb1fc7a22f"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#ga340bf8f49d0cbaa994eaf5fb1fc7a22f">mysql_mutex_lock</a></div><div class="ttdeci">#define mysql_mutex_lock(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00276">mysql_thread.h:276</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_ga37298c942ab1882a74ed52b787605132"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#ga37298c942ab1882a74ed52b787605132">mysql_mutex_destroy</a></div><div class="ttdeci">#define mysql_mutex_destroy(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00261">mysql_thread.h:261</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_ga5c748d3c7862702885acb90576754a2c"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#ga5c748d3c7862702885acb90576754a2c">mysql_mutex_unlock</a></div><div class="ttdeci">#define mysql_mutex_unlock(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00304">mysql_thread.h:304</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_ga835e97f258f7c4c78e24ffff723f0bea"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#ga835e97f258f7c4c78e24ffff723f0bea">mysql_cond_timedwait</a></div><div class="ttdeci">#define mysql_cond_timedwait(C, M, W)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00495">mysql_thread.h:495</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_gaccf61aa4a9e6108ac938a184d7b8efd7"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#gaccf61aa4a9e6108ac938a184d7b8efd7">mysql_mutex_assert_owner</a></div><div class="ttdeci">#define mysql_mutex_assert_owner(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00204">mysql_thread.h:204</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_gae34d5c956bc219ef45fbece509d3cf40"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#gae34d5c956bc219ef45fbece509d3cf40">mysql_cond_signal</a></div><div class="ttdeci">#define mysql_cond_signal(C)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00504">mysql_thread.h:504</a></div></div>
<div class="ttc" id="agroup___thread__instrumentation_html_gaf4fc58e68eb34057e9954944a34824c1"><div class="ttname"><a href="../../de/d55/group___thread__instrumentation.html#gaf4fc58e68eb34057e9954944a34824c1">mysql_mutex_init</a></div><div class="ttdeci">#define mysql_mutex_init(K, M, A)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00246">mysql_thread.h:246</a></div></div>
<div class="ttc" id="ajemalloc__internal_8h_html_ae89ee89f41328ac0ade1e3e26c103570"><div class="ttname"><a href="../../d9/d33/jemalloc__internal_8h.html#ae89ee89f41328ac0ade1e3e26c103570">NULL</a></div><div class="ttdeci">arena_t NULL</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d33/jemalloc__internal_8h_source.html#l00624">jemalloc_internal.h:624</a></div></div>
<div class="ttc" id="akeycache_8h_html"><div class="ttname"><a href="../../de/dc2/keycache_8h.html">keycache.h</a></div></div>
<div class="ttc" id="akeycache_8h_html_a966117cd6dafc9d365a76aa1b3ee9a16"><div class="ttname"><a href="../../de/dc2/keycache_8h.html#a966117cd6dafc9d365a76aa1b3ee9a16">CHANGED_BLOCKS_HASH</a></div><div class="ttdeci">#define CHANGED_BLOCKS_HASH</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00040">keycache.h:40</a></div></div>
<div class="ttc" id="alf_8h_html_a359b2d783027136786cee9f243efcbde"><div class="ttname"><a href="../../de/d17/lf_8h.html#a359b2d783027136786cee9f243efcbde">idx</a></div><div class="ttdeci">void LF_DYNARRAY uint idx</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d17/lf_8h_source.html#l00086">lf.h:86</a></div></div>
<div class="ttc" id="alf_8h_html_ada1f7cc38a0951ca7a4f263a30d43984"><div class="ttname"><a href="../../de/d17/lf_8h.html#ada1f7cc38a0951ca7a4f263a30d43984">pins</a></div><div class="ttdeci">LF_PINS * pins</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d17/lf_8h_source.html#l00173">lf.h:173</a></div></div>
<div class="ttc" id="am__string_8h_html"><div class="ttname"><a href="../../d6/dda/m__string_8h.html">m_string.h</a></div></div>
<div class="ttc" id="am__string_8h_html_ab3be5dcbbf1244672c14662b20f88b61"><div class="ttname"><a href="../../d6/dda/m__string_8h.html#ab3be5dcbbf1244672c14662b20f88b61">bzero</a></div><div class="ttdeci">#define bzero(A, B)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dda/m__string_8h_source.html#l00063">m_string.h:63</a></div></div>
<div class="ttc" id="am__string_8h_html_aed653b4838032a2c5ce8960421c8cfd7"><div class="ttname"><a href="../../d6/dda/m__string_8h.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a></div><div class="ttdeci">#define memcpy(d, s, n)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dda/m__string_8h_source.html#l00050">m_string.h:50</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a032c611ae0a4a7b599a8507d44f3b68b"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a032c611ae0a4a7b599a8507d44f3b68b">cmp_sec_link</a></div><div class="ttdeci">static int cmp_sec_link(BLOCK_LINK **a, BLOCK_LINK **b)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l03446">mf_keycache.c:3446</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a073eebc4dcb3344c70fcc1d4b77da470"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a073eebc4dcb3344c70fcc1d4b77da470">keycache_pthread_cond_wait</a></div><div class="ttdeci">#define keycache_pthread_cond_wait(C, M)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00312">mf_keycache.c:312</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a0ba239caffe5972f2aaffa36f1bf1d9e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a0ba239caffe5972f2aaffa36f1bf1d9e">keycache_pthread_mutex_lock</a></div><div class="ttdeci">#define keycache_pthread_mutex_lock(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00320">mf_keycache.c:320</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a0da33d569f769182ccfc8ba365a7c506"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a0da33d569f769182ccfc8ba365a7c506">F_B_PRT</a></div><div class="ttdeci">#define F_B_PRT(_f_, _v_)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04459">mf_keycache.c:4459</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a103e79c49cd1de817225fcfc1cf54af5"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a103e79c49cd1de817225fcfc1cf54af5">link_into_queue</a></div><div class="ttdeci">static void link_into_queue(KEYCACHE_WQUEUE *wqueue, struct st_my_thread_var *thread)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00788">mf_keycache.c:788</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a108f066be8ee492a53e3e6cca587fd28"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a108f066be8ee492a53e3e6cca587fd28">change_key_cache_param</a></div><div class="ttdeci">void change_key_cache_param(KEY_CACHE *keycache, uint division_limit, uint age_threshold)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00695">mf_keycache.c:695</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a15355029fead2872a757e1d854f8f0d8"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a15355029fead2872a757e1d854f8f0d8">keycache_thread_id</a></div><div class="ttdeci">static long keycache_thread_id</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00286">mf_keycache.c:286</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a16798e4c3e8d146c06308973cc94621c"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a16798e4c3e8d146c06308973cc94621c">reg_requests</a></div><div class="ttdeci">static void reg_requests(KEY_CACHE *keycache, BLOCK_LINK *block, int count)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01285">mf_keycache.c:1285</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1a66086923e04e603ccf3acba85513d1"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1a66086923e04e603ccf3acba85513d1">BLOCK_CHANGED</a></div><div class="ttdeci">#define BLOCK_CHANGED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00188">mf_keycache.c:188</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1b6b46b336b85c603a64b173b6cd1b62"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1b6b46b336b85c603a64b173b6cd1b62">fail_block</a></div><div class="ttdeci">static int fail_block(BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04461">mf_keycache.c:4461</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1d4c7082211af7b0a0d2e1594785aa3e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1d4c7082211af7b0a0d2e1594785aa3e">KEYCACHE_DEBUG_OPEN</a></div><div class="ttdeci">#define KEYCACHE_DEBUG_OPEN</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00267">mf_keycache.c:267</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1d4f5389d94d0c723e58f2fd18b471f4"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1d4f5389d94d0c723e58f2fd18b471f4">BLOCK_NUMBER</a></div><div class="ttdeci">#define BLOCK_NUMBER(b)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00303">mf_keycache.c:303</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1e21f226bb2d12a017992f880983e66a"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1e21f226bb2d12a017992f880983e66a">link_to_file_list</a></div><div class="ttdeci">static void link_to_file_list(KEY_CACHE *keycache, BLOCK_LINK *block, int file, my_bool unlink_block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01013">mf_keycache.c:1013</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a1e2a758165a0facc9cae15407a294eff"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a1e2a758165a0facc9cae15407a294eff">reset_key_cache_counters</a></div><div class="ttdeci">int reset_key_cache_counters(const char *name __attribute__((unused)), KEY_CACHE *key_cache)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04208">mf_keycache.c:4208</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a201eb06374e27d8a1f76f1af79813571"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a201eb06374e27d8a1f76f1af79813571">STRUCT_PTR</a></div><div class="ttdeci">#define STRUCT_PTR(TYPE, MEMBER, a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00155">mf_keycache.c:155</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a23218b51de2f748d10cd8a6db98d8eb5"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a23218b51de2f748d10cd8a6db98d8eb5">PAGE_READ</a></div><div class="ttdeci">#define PAGE_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00195">mf_keycache.c:195</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a2582062ee1df91c979a85804340b5293"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a2582062ee1df91c979a85804340b5293">find_key_block</a></div><div class="ttdeci">static BLOCK_LINK * find_key_block(KEY_CACHE *keycache, File file, my_off_t filepos, int init_hits_left, int wrmode, int *page_st)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01629">mf_keycache.c:1629</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a267ec136ad3cba2c6901459d19e9c16e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a267ec136ad3cba2c6901459d19e9c16e">key_cache_read</a></div><div class="ttdeci">uchar * key_cache_read(KEY_CACHE *keycache, File file, my_off_t filepos, int level, uchar *buff, uint length, uint block_length __attribute__((unused)), int return_buffer __attribute__((unused)))</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l02497">mf_keycache.c:2497</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a27848979817f779cd73b4a58b6fcccaf"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a27848979817f779cd73b4a58b6fcccaf">next_power</a></div><div class="ttdeci">static uint next_power(uint value)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00335">mf_keycache.c:335</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a292380370cb05785c4627636ea8e68e9"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a292380370cb05785c4627636ea8e68e9">BLOCK_IN_FLUSH</a></div><div class="ttdeci">#define BLOCK_IN_FLUSH</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00187">mf_keycache.c:187</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a2b9e9e39f7a59991a92a06c5b4d33807"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a2b9e9e39f7a59991a92a06c5b4d33807">flush_key_blocks_int</a></div><div class="ttdeci">static int flush_key_blocks_int(KEY_CACHE *keycache, File file, enum flush_type type)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l03586">mf_keycache.c:3586</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a36c6785bea71fce1b852570282a32897"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a36c6785bea71fce1b852570282a32897">wait_for_readers</a></div><div class="ttdeci">static void wait_for_readers(KEY_CACHE *keycache, BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01414">mf_keycache.c:1414</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a455c6a5e2f480b8d8b67392ba9f61d67"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a455c6a5e2f480b8d8b67392ba9f61d67">wait_on_queue</a></div><div class="ttdeci">static void wait_on_queue(KEYCACHE_WQUEUE *wqueue, mysql_mutex_t *mutex)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00875">mf_keycache.c:875</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a459e57d1695b31814a33224b5dd81b2e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a459e57d1695b31814a33224b5dd81b2e">KEYCACHE_CONDVAR</a></div><div class="ttdeci">mysql_cond_t KEYCACHE_CONDVAR</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00163">mf_keycache.c:163</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4925246d4bedfd67705101098707da52"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4925246d4bedfd67705101098707da52">link_changed</a></div><div class="ttdeci">static void link_changed(BLOCK_LINK *block, BLOCK_LINK **phead)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00977">mf_keycache.c:977</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4a0b57a0812f6ad19b2174667119f4ad"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ad">BLOCK_TEMPERATURE</a></div><div class="ttdeci">BLOCK_TEMPERATURE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00200">mf_keycache.c:200</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada651bb47ace9f7a2cf7ec03c0fec2c550">BLOCK_COLD</a></div><div class="ttdeci">@ BLOCK_COLD</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00200">mf_keycache.c:200</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4a0b57a0812f6ad19b2174667119f4ada9b0e5b737da218510a23b0d69cd4ccf0"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4ada9b0e5b737da218510a23b0d69cd4ccf0">BLOCK_HOT</a></div><div class="ttdeci">@ BLOCK_HOT</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00200">mf_keycache.c:200</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4a0b57a0812f6ad19b2174667119f4adac2c570d3a0a8181ed88cbdbe2450daea">BLOCK_WARM</a></div><div class="ttdeci">@ BLOCK_WARM</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00200">mf_keycache.c:200</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4a36947154eb0a2556081ccea28df060"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4a36947154eb0a2556081ccea28df060">KEYCACHE_THREAD_TRACE</a></div><div class="ttdeci">#define KEYCACHE_THREAD_TRACE(l)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00287">mf_keycache.c:287</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4b51acba27048b5d3242f8ff0bb76a50"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4b51acba27048b5d3242f8ff0bb76a50">read_block</a></div><div class="ttdeci">static void read_block(KEY_CACHE *keycache, BLOCK_LINK *block, uint read_length, uint min_length, my_bool primary)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l02382">mf_keycache.c:2382</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4d1a6ff619e0c008f6fb923dbd0760d8"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4d1a6ff619e0c008f6fb923dbd0760d8">link_block</a></div><div class="ttdeci">static void link_block(KEY_CACHE *keycache, BLOCK_LINK *block, my_bool hot, my_bool at_end)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01109">mf_keycache.c:1109</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a4fc715bfb4b31e5ea371b4613f246d42"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a4fc715bfb4b31e5ea371b4613f246d42">dflt_key_cache_var</a></div><div class="ttdeci">KEY_CACHE dflt_key_cache_var</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00222">mf_keycache.c:222</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a52cb7c1e487c6dc5bfaa36f9883df371"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a52cb7c1e487c6dc5bfaa36f9883df371">flush_cached_blocks</a></div><div class="ttdeci">static int flush_cached_blocks(KEY_CACHE *keycache, File file, BLOCK_LINK **cache, BLOCK_LINK **end, enum flush_type type)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l03458">mf_keycache.c:3458</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a576532f3cff936c77a937b546ae03acc"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a576532f3cff936c77a937b546ae03acc">unlink_hash</a></div><div class="ttdeci">static void unlink_hash(KEY_CACHE *keycache, HASH_LINK *hash_link)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01459">mf_keycache.c:1459</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a5be6b9a8727840f3707d846228fbe51f"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a5be6b9a8727840f3707d846228fbe51f">KEYCACHE_THREAD_TRACE_END</a></div><div class="ttdeci">#define KEYCACHE_THREAD_TRACE_END(l)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00295">mf_keycache.c:295</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a5caec46b7508fa71623331f57a65ca94"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a5caec46b7508fa71623331f57a65ca94">link_hash</a></div><div class="ttdeci">static void link_hash(HASH_LINK **start, HASH_LINK *hash_link)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01445">mf_keycache.c:1445</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a5e18faaba6916c5591566101544fda8d"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a5e18faaba6916c5591566101544fda8d">COND_FOR_REQUESTED</a></div><div class="ttdeci">#define COND_FOR_REQUESTED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00159">mf_keycache.c:159</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a5e79984cb49ca8181cd2b7f508974398"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a5e79984cb49ca8181cd2b7f508974398">PAGE_TO_BE_READ</a></div><div class="ttdeci">#define PAGE_TO_BE_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00196">mf_keycache.c:196</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a5e9e1708936ac404c45527d26958ae16"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a5e9e1708936ac404c45527d26958ae16">flush_all_key_blocks</a></div><div class="ttdeci">static int flush_all_key_blocks(KEY_CACHE *keycache)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04090">mf_keycache.c:4090</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a7e3c4109fa9594257d855d6bcaeb896c"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a7e3c4109fa9594257d855d6bcaeb896c">COND_FOR_SAVED</a></div><div class="ttdeci">#define COND_FOR_SAVED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00160">mf_keycache.c:160</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a82b33b3835be70136009b7c88d4ecad4"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a82b33b3835be70136009b7c88d4ecad4">test_key_cache</a></div><div class="ttdeci">static void test_key_cache(KEY_CACHE *keycache, const char *where, my_bool lock)</div></div>
<div class="ttc" id="amf__keycache_8c_html_a863339f26989157ca7f3bb1728b02270"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a863339f26989157ca7f3bb1728b02270">PAGE_WAIT_TO_BE_READ</a></div><div class="ttdeci">#define PAGE_WAIT_TO_BE_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00197">mf_keycache.c:197</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a86be03ac31d3436059c39ee7447d220a"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a86be03ac31d3436059c39ee7447d220a">dec_counter_for_resize_op</a></div><div class="ttdeci">static void dec_counter_for_resize_op(KEY_CACHE *keycache)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00671">mf_keycache.c:671</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a8d1962faf8bcd8d3bf01d56cedfc744b"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a8d1962faf8bcd8d3bf01d56cedfc744b">release_whole_queue</a></div><div class="ttdeci">static void release_whole_queue(KEYCACHE_WQUEUE *wqueue)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00922">mf_keycache.c:922</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a8d33bb44cb3ad1c04d8a3fac879e4ec2"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a8d33bb44cb3ad1c04d8a3fac879e4ec2">BLOCK_IN_SWITCH</a></div><div class="ttdeci">#define BLOCK_IN_SWITCH</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00185">mf_keycache.c:185</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a8d6892bc7cb4a979cbc23e89a22b386e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a8d6892bc7cb4a979cbc23e89a22b386e">resize_key_cache</a></div><div class="ttdeci">int resize_key_cache(KEY_CACHE *keycache, uint key_cache_block_size, size_t use_mem, uint division_limit, uint age_threshold)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00559">mf_keycache.c:559</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a8ee571cefdea70da535b27a8d27f4885"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a8ee571cefdea70da535b27a8d27f4885">KEYCACHE_DEBUG_CLOSE</a></div><div class="ttdeci">#define KEYCACHE_DEBUG_CLOSE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00268">mf_keycache.c:268</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a8ee68b09652c680c421c3caa4c02a476"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a8ee68b09652c680c421c3caa4c02a476">end_key_cache</a></div><div class="ttdeci">void end_key_cache(KEY_CACHE *keycache, my_bool cleanup)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00724">mf_keycache.c:724</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9136bb4caea5054f49fee78aad69f3b2"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9136bb4caea5054f49fee78aad69f3b2">get_hash_link</a></div><div class="ttdeci">static HASH_LINK * get_hash_link(KEY_CACHE *keycache, int file, my_off_t filepos)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01512">mf_keycache.c:1512</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a94cdc3c884e8122823b31ae04fecc887"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a94cdc3c884e8122823b31ae04fecc887">free_block</a></div><div class="ttdeci">static void free_block(KEY_CACHE *keycache, BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l03318">mf_keycache.c:3318</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9946bb8e6c38ce22571c368f611ca6e8"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9946bb8e6c38ce22571c368f611ca6e8">unlink_block</a></div><div class="ttdeci">static void unlink_block(KEY_CACHE *keycache, BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01227">mf_keycache.c:1227</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a99fba7d185b271ecf5ec5ddead8a3c98"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a99fba7d185b271ecf5ec5ddead8a3c98">BLOCK_REASSIGNED</a></div><div class="ttdeci">#define BLOCK_REASSIGNED</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00186">mf_keycache.c:186</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9ab99a418a31634c3db3e0276cb0cd4b"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9ab99a418a31634c3db3e0276cb0cd4b">BLOCK_IN_USE</a></div><div class="ttdeci">#define BLOCK_IN_USE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00189">mf_keycache.c:189</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9ac6a20acf7c4e32dd0daa72a96d4381"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9ac6a20acf7c4e32dd0daa72a96d4381">HASH_LINK_NUMBER</a></div><div class="ttdeci">#define HASH_LINK_NUMBER(h)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00305">mf_keycache.c:305</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9b1fc8e4187cc45b931126ed0716db49"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9b1fc8e4187cc45b931126ed0716db49">unlink_changed</a></div><div class="ttdeci">static void unlink_changed(BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00955">mf_keycache.c:955</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_a9b494c4988b087161e4073fbd4b595aa"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#a9b494c4988b087161e4073fbd4b595aa">KEYCACHE_THREAD_TRACE_BEGIN</a></div><div class="ttdeci">#define KEYCACHE_THREAD_TRACE_BEGIN(l)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00290">mf_keycache.c:290</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aa06cb301b5a09875ec53ec4ec60b2902"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aa06cb301b5a09875ec53ec4ec60b2902">KEYCACHE_DBUG_PRINT</a></div><div class="ttdeci">#define KEYCACHE_DBUG_PRINT(l, m)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00280">mf_keycache.c:280</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aa6743f1ab031dc202cea8b9ea346d5de"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aa6743f1ab031dc202cea8b9ea346d5de">key_cache_insert</a></div><div class="ttdeci">int key_cache_insert(KEY_CACHE *keycache, File file, my_off_t filepos, int level, uchar *buff, uint length)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l02731">mf_keycache.c:2731</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aacb004d165a9f0075595fa689016ebc7"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aacb004d165a9f0075595fa689016ebc7">unlink_from_queue</a></div><div class="ttdeci">static void unlink_from_queue(KEYCACHE_WQUEUE *wqueue, struct st_my_thread_var *thread)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00825">mf_keycache.c:825</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aadac5591a24970ff1439836bb50c193a"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aadac5591a24970ff1439836bb50c193a">BLOCK_IN_EVICTION</a></div><div class="ttdeci">#define BLOCK_IN_EVICTION</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00190">mf_keycache.c:190</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ab3c0621f463bcc6d86b359ae9ee4cec8"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ab3c0621f463bcc6d86b359ae9ee4cec8">keycache_pthread_cond_signal</a></div><div class="ttdeci">#define keycache_pthread_cond_signal(C)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00322">mf_keycache.c:322</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ab5df7ef66275032e4044ced15b374d69"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ab5df7ef66275032e4044ced15b374d69">BLOCK_FOR_UPDATE</a></div><div class="ttdeci">#define BLOCK_FOR_UPDATE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00192">mf_keycache.c:192</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ab800abece46f16337a8575f6f94fa5bb"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ab800abece46f16337a8575f6f94fa5bb">dflt_key_cache</a></div><div class="ttdeci">KEY_CACHE * dflt_key_cache</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00223">mf_keycache.c:223</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ab89f1b5417f528525c7b997a99dd8979"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ab89f1b5417f528525c7b997a99dd8979">remove_reader</a></div><div class="ttdeci">static void remove_reader(BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01395">mf_keycache.c:1395</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aba302488a09b899c3966444d921c3c66"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aba302488a09b899c3966444d921c3c66">BLOCK_READ</a></div><div class="ttdeci">#define BLOCK_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00184">mf_keycache.c:184</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_acd56e6b19c20a65a346c334bcb03f380"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#acd56e6b19c20a65a346c334bcb03f380">BLOCK_IN_FLUSHWRITE</a></div><div class="ttdeci">#define BLOCK_IN_FLUSHWRITE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00191">mf_keycache.c:191</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_acf93030008a45e54fad4650439a746a1"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#acf93030008a45e54fad4650439a746a1">BLOCK_ERROR</a></div><div class="ttdeci">#define BLOCK_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00183">mf_keycache.c:183</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ad0fc8526a7a2b14f31b9df818414a224"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ad0fc8526a7a2b14f31b9df818414a224">init_key_cache</a></div><div class="ttdeci">int init_key_cache(KEY_CACHE *keycache, uint key_cache_block_size, size_t use_mem, uint division_limit, uint age_threshold)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00366">mf_keycache.c:366</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ad4d6c001c818692b83d4303532f17dba"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ad4d6c001c818692b83d4303532f17dba">flush_key_blocks</a></div><div class="ttdeci">int flush_key_blocks(KEY_CACHE *keycache, File file, enum flush_type type)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04035">mf_keycache.c:4035</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ae2a0dda2a2b90dff2a89dd93c15149d2"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ae2a0dda2a2b90dff2a89dd93c15149d2">cache_empty</a></div><div class="ttdeci">static int cache_empty(KEY_CACHE *keycache)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04486">mf_keycache.c:4486</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ae2fe42ec9fb99b1865627988e1f5ee84"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ae2fe42ec9fb99b1865627988e1f5ee84">FILE_HASH</a></div><div class="ttdeci">#define FILE_HASH(f)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00242">mf_keycache.c:242</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ae31bae037244419366e24306ddaf78d5"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ae31bae037244419366e24306ddaf78d5">link_to_changed_list</a></div><div class="ttdeci">static void link_to_changed_list(KEY_CACHE *keycache, BLOCK_LINK *block)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01054">mf_keycache.c:1054</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_ae4716d2ef9f38b2e33369931c83a1c27"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#ae4716d2ef9f38b2e33369931c83a1c27">keycache_pthread_mutex_unlock</a></div><div class="ttdeci">#define keycache_pthread_mutex_unlock(M)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00321">mf_keycache.c:321</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aea0bccc76a000e75ef1905fd76dd640b"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aea0bccc76a000e75ef1905fd76dd640b">fail_hlink</a></div><div class="ttdeci">static int fail_hlink(HASH_LINK *hlink)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l04476">mf_keycache.c:4476</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aeb81aa221bac3bdf5a164716c193acb8"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aeb81aa221bac3bdf5a164716c193acb8">inc_counter_for_resize_op</a></div><div class="ttdeci">static void inc_counter_for_resize_op(KEY_CACHE *keycache)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00661">mf_keycache.c:661</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_af6fe690814baaa77dfb7aeeb38db1514"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#af6fe690814baaa77dfb7aeeb38db1514">KEYCACHE_DBUG_ASSERT</a></div><div class="ttdeci">#define KEYCACHE_DBUG_ASSERT(a)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00281">mf_keycache.c:281</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_afc7c473a02292b7b5c4a1ddce0f373a9"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#afc7c473a02292b7b5c4a1ddce0f373a9">unreg_request</a></div><div class="ttdeci">static void unreg_request(KEY_CACHE *keycache, BLOCK_LINK *block, int at_end)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l01328">mf_keycache.c:1328</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_afced45e5c89364d6703389c01e68f55f"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#afced45e5c89364d6703389c01e68f55f">KEYCACHE_HASH</a></div><div class="ttdeci">#define KEYCACHE_HASH(f, pos)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00239">mf_keycache.c:239</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_afdbfdb5d1220da05d243bfc2c17634d4"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#afdbfdb5d1220da05d243bfc2c17634d4">FLUSH_CACHE</a></div><div class="ttdeci">#define FLUSH_CACHE</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00225">mf_keycache.c:225</a></div></div>
<div class="ttc" id="amf__keycache_8c_html_aff88812c695a85ae531437535463868e"><div class="ttname"><a href="../../d3/d26/mf__keycache_8c.html#aff88812c695a85ae531437535463868e">key_cache_write</a></div><div class="ttdeci">int key_cache_write(KEY_CACHE *keycache, File file, my_off_t filepos, int level, uchar *buff, uint length, uint block_length __attribute__((unused)), int dont_write)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l02978">mf_keycache.c:2978</a></div></div>
<div class="ttc" id="aminigzip_8c_html_aee763da2c1c9da197307bad1d009513d"><div class="ttname"><a href="../../d3/dc6/minigzip_8c.html#aee763da2c1c9da197307bad1d009513d">error</a></div><div class="ttdeci">void error(char *msg) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dc6/minigzip_8c_source.html#l00156">minigzip.c:156</a></div></div>
<div class="ttc" id="ampq-internal_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="../../d8/dec/mpq-internal_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dec/mpq-internal_8h_source.html#l00062">mpq-internal.h:62</a></div></div>
<div class="ttc" id="ampq-internal_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="../../d8/dec/mpq-internal_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dec/mpq-internal_8h_source.html#l00059">mpq-internal.h:59</a></div></div>
<div class="ttc" id="amy__attribute_8h_html_a4fb2431b46656ad0908c4e0195540182"><div class="ttname"><a href="../../d4/d72/my__attribute_8h.html#a4fb2431b46656ad0908c4e0195540182">__attribute__</a></div><div class="ttdeci">#define __attribute__(A)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d72/my__attribute_8h_source.html#l00038">my_attribute.h:38</a></div></div>
<div class="ttc" id="amy__bit_8h_html"><div class="ttname"><a href="../../de/dec/my__bit_8h.html">my_bit.h</a></div></div>
<div class="ttc" id="amy__bit_8h_html_a0cb6c7080d6e67aba03a79591bdbbb8d"><div class="ttname"><a href="../../de/dec/my__bit_8h.html#a0cb6c7080d6e67aba03a79591bdbbb8d">my_round_up_to_next_power</a></div><div class="ttdeci">static uint32 my_round_up_to_next_power(uint32 v)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dec/my__bit_8h_source.html#l00072">my_bit.h:72</a></div></div>
<div class="ttc" id="amy__dbug_8h_html_a1f2d1168faa35ce15f1b058a5fe9c630"><div class="ttname"><a href="../../d0/d74/my__dbug_8h.html#a1f2d1168faa35ce15f1b058a5fe9c630">DBUG_EXECUTE_IF</a></div><div class="ttdeci">#define DBUG_EXECUTE_IF(keyword, a1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d74/my__dbug_8h_source.html#l00076">my_dbug.h:76</a></div></div>
<div class="ttc" id="amy__dbug_8h_html_af5d75f213550ec27715b65d9bdfa45ec"><div class="ttname"><a href="../../d0/d74/my__dbug_8h.html#af5d75f213550ec27715b65d9bdfa45ec">DBUG_ASSERT</a></div><div class="ttdeci">#define DBUG_ASSERT(A)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d74/my__dbug_8h_source.html#l00096">my_dbug.h:96</a></div></div>
<div class="ttc" id="amy__global_8h_html_a4765fea979c5ff199c51806810fe18a4"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a4765fea979c5ff199c51806810fe18a4">ALIGN_SIZE</a></div><div class="ttdeci">#define ALIGN_SIZE(A)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00839">my_global.h:839</a></div></div>
<div class="ttc" id="amy__global_8h_html_a5baef0dcbf233902f75830ce890d9ba6"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a5baef0dcbf233902f75830ce890d9ba6">reg1</a></div><div class="ttdeci">#define reg1</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l01018">my_global.h:1018</a></div></div>
<div class="ttc" id="amy__global_8h_html_a633e1ce2fa5c05eb1b11004dd8f8d42a"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a633e1ce2fa5c05eb1b11004dd8f8d42a">ADD_TO_PTR</a></div><div class="ttdeci">#define ADD_TO_PTR(ptr, size, type)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00841">my_global.h:841</a></div></div>
<div class="ttc" id="amy__global_8h_html_a65f85814a8290f9797005d3b28e7e5fc"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a></div><div class="ttdeci">unsigned char uchar</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00874">my_global.h:874</a></div></div>
<div class="ttc" id="amy__global_8h_html_a718b4eb2652c286f4d42dc18a8e71a1a"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a718b4eb2652c286f4d42dc18a8e71a1a">ulong</a></div><div class="ttdeci">unsigned long ulong</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00908">my_global.h:908</a></div></div>
<div class="ttc" id="amy__global_8h_html_a74cd599039dcf29c6e6d342cf4efd0a8"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a74cd599039dcf29c6e6d342cf4efd0a8">my_bool</a></div><div class="ttdeci">char my_bool</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00992">my_global.h:992</a></div></div>
<div class="ttc" id="amy__global_8h_html_a789723eaf2299d841eb477a8f1d6b1b1"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a789723eaf2299d841eb477a8f1d6b1b1">qsort_cmp</a></div><div class="ttdeci">C_MODE_START typedef int(* qsort_cmp)(const void *, const void *)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00546">my_global.h:546</a></div></div>
<div class="ttc" id="amy__global_8h_html_a91ad9478d81a7aaf2593e8d9c3d06a14"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a></div><div class="ttdeci">unsigned int uint</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00475">my_global.h:475</a></div></div>
<div class="ttc" id="amy__global_8h_html_aadeec961a0e84bb1fa3cded11703cf2f"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#aadeec961a0e84bb1fa3cded11703cf2f">set_if_smaller</a></div><div class="ttdeci">#define set_if_smaller(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00482">my_global.h:482</a></div></div>
<div class="ttc" id="amy__global_8h_html_aae0dcf447aac67c9902b0ab7f3835e79"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#aae0dcf447aac67c9902b0ab7f3835e79">UNINIT_VAR</a></div><div class="ttdeci">#define UNINIT_VAR(x)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00466">my_global.h:466</a></div></div>
<div class="ttc" id="amy__global_8h_html_ab3b3804e3bf2734c0f4f1c72f30df1bd"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#ab3b3804e3bf2734c0f4f1c72f30df1bd">MYF</a></div><div class="ttdeci">#define MYF(v)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00995">my_global.h:995</a></div></div>
<div class="ttc" id="amy__global_8h_html_acc0910d1e534654a09fa48ac0f37b610"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#acc0910d1e534654a09fa48ac0f37b610">my_off_t</a></div><div class="ttdeci">unsigned long my_off_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00959">my_global.h:959</a></div></div>
<div class="ttc" id="amy__global_8h_html_ad34d82818831a94a892fcc41a95aa286"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#ad34d82818831a94a892fcc41a95aa286">File</a></div><div class="ttdeci">int File</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00520">my_global.h:520</a></div></div>
<div class="ttc" id="amy__global_8h_html_adefd9f16236d64d1f92020396d6a07a3"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#adefd9f16236d64d1f92020396d6a07a3">set_if_bigger</a></div><div class="ttdeci">#define set_if_bigger(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00481">my_global.h:481</a></div></div>
<div class="ttc" id="amy__global_8h_html_ae7c11be50f0b11d048979398c5fdcfa5"><div class="ttname"><a href="../../d9/df6/my__global_8h.html#ae7c11be50f0b11d048979398c5fdcfa5">ulonglong</a></div><div class="ttdeci">unsigned long ulonglong</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df6/my__global_8h_source.html#l00920">my_global.h:920</a></div></div>
<div class="ttc" id="amy__pthread_8h_html_a7ac1faca6820fee0cb790ee7a7e68fea"><div class="ttname"><a href="../../da/da8/my__pthread_8h.html#a7ac1faca6820fee0cb790ee7a7e68fea">MY_MUTEX_INIT_FAST</a></div><div class="ttdeci">#define MY_MUTEX_INIT_FAST</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00792">my_pthread.h:792</a></div></div>
<div class="ttc" id="amy__pthread_8h_html_ab59cf3c65eaf836d5c647fa2a24ca649"><div class="ttname"><a href="../../da/da8/my__pthread_8h.html#ab59cf3c65eaf836d5c647fa2a24ca649">ETIME</a></div><div class="ttdeci">#define ETIME</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00024">my_pthread.h:24</a></div></div>
<div class="ttc" id="amy__pthread_8h_html_ab607b8ccc65b942b3d56aa2aa2e507eb"><div class="ttname"><a href="../../da/da8/my__pthread_8h.html#ab607b8ccc65b942b3d56aa2aa2e507eb">my_errno</a></div><div class="ttdeci">#define my_errno</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00862">my_pthread.h:862</a></div></div>
<div class="ttc" id="amy__pthread_8h_html_aedb9ab16eaff86bd85b54605777d83ea"><div class="ttname"><a href="../../da/da8/my__pthread_8h.html#aedb9ab16eaff86bd85b54605777d83ea">my_thread_var</a></div><div class="ttdeci">#define my_thread_var</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00861">my_pthread.h:861</a></div></div>
<div class="ttc" id="amy__static_8h_html"><div class="ttname"><a href="../../d1/dda/my__static_8h.html">my_static.h</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a0ae37e0bc0a33fa211d5f4c699e6391a"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a0ae37e0bc0a33fa211d5f4c699e6391a">MY_WAIT_IF_FULL</a></div><div class="ttdeci">#define MY_WAIT_IF_FULL</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00074">my_sys.h:74</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a19ebf963aef6b242322e15e01811972e"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a19ebf963aef6b242322e15e01811972e">my_error</a></div><div class="ttdeci">void my_error(int nr, myf MyFlags,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dc6/my__error_8c_source.html#l00071">my_error.c:71</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a3a3ddffcaadb60b7715c9889f8c56afb"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a3a3ddffcaadb60b7715c9889f8c56afb">my_free</a></div><div class="ttdeci">void my_free(void *ptr)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d7c/my__malloc_8c_source.html#l00124">my_malloc.c:124</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a5a12d6616a8e57ee98b1024fa4ef98fc"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a5a12d6616a8e57ee98b1024fa4ef98fc">MY_NABP</a></div><div class="ttdeci">#define MY_NABP</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00071">my_sys.h:71</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a5bd7d62eddacdc1536566cf3f210ab42"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a5bd7d62eddacdc1536566cf3f210ab42">my_qsort</a></div><div class="ttdeci">qsort_t my_qsort(void *base_ptr, size_t total_elems, size_t size, qsort_cmp cmp)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d89/mf__qsort_8c_source.html#l00097">mf_qsort.c:97</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a6d70f7239c6dfd15f74c22fd35eed350"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a6d70f7239c6dfd15f74c22fd35eed350">my_pread</a></div><div class="ttdeci">size_t my_pread(File Filedes, uchar *Buffer, size_t Count, my_off_t offset, myf MyFlags)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d18/my__pread_8c_source.html#l00048">my_pread.c:48</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a893b39b108e444df21a123d6a8dcf9ed"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a893b39b108e444df21a123d6a8dcf9ed">my_disable_flush_key_blocks</a></div><div class="ttdeci">my_bool my_disable_flush_key_blocks</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00251">my_sys.h:251</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a8d3ef6a3b12a1c6958836b08df7ebeab"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a8d3ef6a3b12a1c6958836b08df7ebeab">my_filename</a></div><div class="ttdeci">char * my_filename(File fd)</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d49/my__div_8c_source.html#l00026">my_div.c:26</a></div></div>
<div class="ttc" id="amy__sys_8h_html_a8f7b30ff5d0e10610637aa30c3e0048b"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#a8f7b30ff5d0e10610637aa30c3e0048b">my_malloc</a></div><div class="ttdeci">void * my_malloc(size_t Size, myf MyFlags)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d7c/my__malloc_8c_source.html#l00028">my_malloc.c:28</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aba32e671624503b488323bcbd0454bef"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aba32e671624503b488323bcbd0454bef">my_large_free</a></div><div class="ttdeci">#define my_large_free(A)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00179">my_sys.h:179</a></div></div>
<div class="ttc" id="amy__sys_8h_html_ad65a8842cc674e3ddf69355898c0ecbf"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a></div><div class="ttdeci">int errno</div></div>
<div class="ttc" id="amy__sys_8h_html_aeddd90998bb0136c794fc7ba7e54adb5"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aeddd90998bb0136c794fc7ba7e54adb5">my_large_malloc</a></div><div class="ttdeci">#define my_large_malloc(A, B)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00178">my_sys.h:178</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aeeed91744344e50c4a88e0cb02944de4"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aeeed91744344e50c4a88e0cb02944de4">my_pwrite</a></div><div class="ttdeci">size_t my_pwrite(File Filedes, const uchar *Buffer, size_t Count, my_off_t offset, myf MyFlags)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d18/my__pread_8c_source.html#l00136">my_pread.c:136</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aff94a40cf049a7ffa8c8fdc46b757085"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085">flush_type</a></div><div class="ttdeci">flush_type</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00273">my_sys.h:274</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a042b8d8d5e9eebd1a01558aa273463c9">FLUSH_KEEP</a></div><div class="ttdeci">@ FLUSH_KEEP</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00275">my_sys.h:275</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aff94a40cf049a7ffa8c8fdc46b757085a33df826353611ec2c130ed9dddb83820"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a33df826353611ec2c130ed9dddb83820">FLUSH_RELEASE</a></div><div class="ttdeci">@ FLUSH_RELEASE</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00276">my_sys.h:276</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aff94a40cf049a7ffa8c8fdc46b757085a371968d6faccf6bb3c78f25f97bf15b5"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085a371968d6faccf6bb3c78f25f97bf15b5">FLUSH_FORCE_WRITE</a></div><div class="ttdeci">@ FLUSH_FORCE_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00283">my_sys.h:282</a></div></div>
<div class="ttc" id="amy__sys_8h_html_aff94a40cf049a7ffa8c8fdc46b757085ae7f30296faaf4f2833932412ecd03026"><div class="ttname"><a href="../../db/da9/my__sys_8h.html#aff94a40cf049a7ffa8c8fdc46b757085ae7f30296faaf4f2833932412ecd03026">FLUSH_IGNORE_CHANGED</a></div><div class="ttdeci">@ FLUSH_IGNORE_CHANGED</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da9/my__sys_8h_source.html#l00277">my_sys.h:277</a></div></div>
<div class="ttc" id="amysys__err_8h_html"><div class="ttname"><a href="../../d3/dcf/mysys__err_8h.html">mysys_err.h</a></div></div>
<div class="ttc" id="amysys__err_8h_html_ac6ce260c4e07352e8294c636515fb5a1"><div class="ttname"><a href="../../d3/dcf/mysys__err_8h.html#ac6ce260c4e07352e8294c636515fb5a1">EE_OUTOFMEMORY</a></div><div class="ttdeci">#define EE_OUTOFMEMORY</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dcf/mysys__err_8h_source.html#l00041">mysys_err.h:41</a></div></div>
<div class="ttc" id="amysys__priv_8h_html"><div class="ttname"><a href="../../d2/d34/mysys__priv_8h.html">mysys_priv.h</a></div></div>
<div class="ttc" id="anamespace_g3_d_html_a69a355f92fa3aab4f301667be00cd3eb"><div class="ttname"><a href="../../df/de2/namespace_g3_d.html#a69a355f92fa3aab4f301667be00cd3eb">G3D::length</a></div><div class="ttdeci">float length(float v)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d0b/vector_math_8h_source.html#l00208">vectorMath.h:208</a></div></div>
<div class="ttc" id="anamespacempq_html_a4d9e28a606ab362cda8f825daad0fb49"><div class="ttname"><a href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">mpq.file</a></div><div class="ttdeci">file</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3e/mpq_8py_source.html#l00283">mpq.py:283</a></div></div>
<div class="ttc" id="anamespacempq_html_ae78cc6206276c5d8a54a7b181bcd4f8d"><div class="ttname"><a href="../../d4/d71/namespacempq.html#ae78cc6206276c5d8a54a7b181bcd4f8d">mpq.a</a></div><div class="ttdeci">a</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3e/mpq_8py_source.html#l00290">mpq.py:290</a></div></div>
<div class="ttc" id="aprintf_8h_html_a147f28e064ae3a469961c07d553bb31e"><div class="ttname"><a href="../../d3/d6b/printf_8h.html#a147f28e064ae3a469961c07d553bb31e">vfprintf</a></div><div class="ttdeci">auto vfprintf(std::FILE *f, const S &amp;fmt, basic_format_args&lt; basic_printf_context_t&lt; type_identity_t&lt; Char &gt;&gt;&gt; args) -&gt; int</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d6b/printf_8h_source.html#l00580">printf.h:580</a></div></div>
<div class="ttc" id="aprintf_8h_html_a9f315126362cae9675de1642105e631e"><div class="ttname"><a href="../../d3/d6b/printf_8h.html#a9f315126362cae9675de1642105e631e">fprintf</a></div><div class="ttdeci">auto fprintf(std::FILE *f, const S &amp;fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d6b/printf_8h_source.html#l00602">printf.h:602</a></div></div>
<div class="ttc" id="aprobes__mysql_8h_html"><div class="ttname"><a href="../../db/dd4/probes__mysql_8h.html">probes_mysql.h</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a3d5514fca1d1fb3b0a472aa246131317"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a3d5514fca1d1fb3b0a472aa246131317">MYSQL_KEYCACHE_READ_HIT</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_HIT()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00112">probes_mysql_nodtrace.h:112</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a46615f7f9e2623345e76b6485dd79f25"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a46615f7f9e2623345e76b6485dd79f25">MYSQL_KEYCACHE_READ_START</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_START(arg0, arg1, arg2, arg3)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00108">probes_mysql_nodtrace.h:108</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a65f00a50395efc0d7e5dda17b0fc9ea3"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a65f00a50395efc0d7e5dda17b0fc9ea3">MYSQL_KEYCACHE_READ_START_ENABLED</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_START_ENABLED()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00109">probes_mysql_nodtrace.h:109</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a785ca90321c7d2501e3628677bdd2ef9"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a785ca90321c7d2501e3628677bdd2ef9">MYSQL_KEYCACHE_READ_DONE_ENABLED</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_DONE_ENABLED()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00117">probes_mysql_nodtrace.h:117</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a7cc0738eef0dd642e0f14d6e2564efa7"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a7cc0738eef0dd642e0f14d6e2564efa7">MYSQL_KEYCACHE_WRITE_START</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_WRITE_START(arg0, arg1, arg2, arg3)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00118">probes_mysql_nodtrace.h:118</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a7cc90d6c8a0998aa1ddfce204e65ed77"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a7cc90d6c8a0998aa1ddfce204e65ed77">MYSQL_KEYCACHE_READ_MISS</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_MISS()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00114">probes_mysql_nodtrace.h:114</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_a897e7297f5fb5a9c78fd42b00bca35e0"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#a897e7297f5fb5a9c78fd42b00bca35e0">MYSQL_KEYCACHE_READ_BLOCK</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_BLOCK(arg0)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00110">probes_mysql_nodtrace.h:110</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_abb77412e8b158b87ec27276a738a0083"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#abb77412e8b158b87ec27276a738a0083">MYSQL_KEYCACHE_WRITE_DONE</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_WRITE_DONE(arg0, arg1)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00122">probes_mysql_nodtrace.h:122</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_ac2d67e32eb211dd4f8b11b99802ae038"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#ac2d67e32eb211dd4f8b11b99802ae038">MYSQL_KEYCACHE_WRITE_DONE_ENABLED</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_WRITE_DONE_ENABLED()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00123">probes_mysql_nodtrace.h:123</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_ad3a27b275c6310be01ae86dde53863b1"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#ad3a27b275c6310be01ae86dde53863b1">MYSQL_KEYCACHE_WRITE_START_ENABLED</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_WRITE_START_ENABLED()</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00119">probes_mysql_nodtrace.h:119</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_ad59f03a8981ab708fa61c1feea43ed79"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#ad59f03a8981ab708fa61c1feea43ed79">MYSQL_KEYCACHE_WRITE_BLOCK</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_WRITE_BLOCK(arg0)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00120">probes_mysql_nodtrace.h:120</a></div></div>
<div class="ttc" id="aprobes__mysql__nodtrace_8h_html_adf801fa7b644e4ba3f0b00327fd9395b"><div class="ttname"><a href="../../db/dbc/probes__mysql__nodtrace_8h.html#adf801fa7b644e4ba3f0b00327fd9395b">MYSQL_KEYCACHE_READ_DONE</a></div><div class="ttdeci">#define MYSQL_KEYCACHE_READ_DONE(arg0, arg1)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dbc/probes__mysql__nodtrace_8h_source.html#l00116">probes_mysql_nodtrace.h:116</a></div></div>
<div class="ttc" id="aprof_8c_html_a3fca4d23183335e3d46f507d28e94e8b"><div class="ttname"><a href="../../df/d31/prof_8c.html#a3fca4d23183335e3d46f507d28e94e8b">b</a></div><div class="ttdeci">const prof_gctx_t * b</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d31/prof_8c_source.html#l00277">prof.c:277</a></div></div>
<div class="ttc" id="astructblock___html"><div class="ttname"><a href="../../de/d36/structblock__.html">block_</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d21/argon2_2argon2_2core_8h_source.html#l00052">core.h:52</a></div></div>
<div class="ttc" id="astructst__block__link_html"><div class="ttname"><a href="../../df/d94/structst__block__link.html">st_block_link</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00203">mf_keycache.c:204</a></div></div>
<div class="ttc" id="astructst__block__link_html_a0c8c850da8a98c38513e6300e9bf73ca"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a0c8c850da8a98c38513e6300e9bf73ca">st_block_link::prev_changed</a></div><div class="ttdeci">struct st_block_link ** prev_changed</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00208">mf_keycache.c:208</a></div></div>
<div class="ttc" id="astructst__block__link_html_a0d784e15066be2b2a0b1334838595843"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a0d784e15066be2b2a0b1334838595843">st_block_link::temperature</a></div><div class="ttdeci">enum BLOCK_TEMPERATURE temperature</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00215">mf_keycache.c:216</a></div></div>
<div class="ttc" id="astructst__block__link_html_a11541c03ef485eebc6e178f138954599"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a11541c03ef485eebc6e178f138954599">st_block_link::offset</a></div><div class="ttdeci">uint offset</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00213">mf_keycache.c:213</a></div></div>
<div class="ttc" id="astructst__block__link_html_a278733a568c53aa510f3de746b5154b4"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a278733a568c53aa510f3de746b5154b4">st_block_link::next_used</a></div><div class="ttdeci">struct st_block_link * next_used</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00206">mf_keycache.c:205</a></div></div>
<div class="ttc" id="astructst__block__link_html_a2861454c5ee71acb232f1dc5eb61b109"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a2861454c5ee71acb232f1dc5eb61b109">st_block_link::requests</a></div><div class="ttdeci">uint requests</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00211">mf_keycache.c:211</a></div></div>
<div class="ttc" id="astructst__block__link_html_a2957e0cd022418bbc39c5e44d3e747ed"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a2957e0cd022418bbc39c5e44d3e747ed">st_block_link::length</a></div><div class="ttdeci">uint length</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00214">mf_keycache.c:214</a></div></div>
<div class="ttc" id="astructst__block__link_html_a3569839d38938a759f68f71c9b9175a1"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a3569839d38938a759f68f71c9b9175a1">st_block_link::condvar</a></div><div class="ttdeci">KEYCACHE_CONDVAR * condvar</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00219">mf_keycache.c:219</a></div></div>
<div class="ttc" id="astructst__block__link_html_a3d1bc098496cfc29270c12fbc7293e19"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a3d1bc098496cfc29270c12fbc7293e19">st_block_link::wqueue</a></div><div class="ttdeci">KEYCACHE_WQUEUE wqueue[2]</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00210">mf_keycache.c:210</a></div></div>
<div class="ttc" id="astructst__block__link_html_a5bf01661b0dc4a264f37442956620986"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a5bf01661b0dc4a264f37442956620986">st_block_link::status</a></div><div class="ttdeci">uint status</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00215">mf_keycache.c:215</a></div></div>
<div class="ttc" id="astructst__block__link_html_a6b4b3c3f8bef2b254407348a80f3e055"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a6b4b3c3f8bef2b254407348a80f3e055">st_block_link::last_hit_time</a></div><div class="ttdeci">ulonglong last_hit_time</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00218">mf_keycache.c:218</a></div></div>
<div class="ttc" id="astructst__block__link_html_a77125bee1c76f943553d6d0a4c06f16b"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a77125bee1c76f943553d6d0a4c06f16b">st_block_link::prev_used</a></div><div class="ttdeci">struct st_block_link ** prev_used</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00206">mf_keycache.c:206</a></div></div>
<div class="ttc" id="astructst__block__link_html_a96d770defa3d3cbd10a4ba16854d3152"><div class="ttname"><a href="../../df/d94/structst__block__link.html#a96d770defa3d3cbd10a4ba16854d3152">st_block_link::next_changed</a></div><div class="ttdeci">struct st_block_link * next_changed</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00208">mf_keycache.c:207</a></div></div>
<div class="ttc" id="astructst__block__link_html_ad38f5e1b5c350f96a1d78c97a896fbc2"><div class="ttname"><a href="../../df/d94/structst__block__link.html#ad38f5e1b5c350f96a1d78c97a896fbc2">st_block_link::hash_link</a></div><div class="ttdeci">struct st_hash_link * hash_link</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00209">mf_keycache.c:209</a></div></div>
<div class="ttc" id="astructst__block__link_html_af763a5b12221b1b6d045cc3d99eb3e53"><div class="ttname"><a href="../../df/d94/structst__block__link.html#af763a5b12221b1b6d045cc3d99eb3e53">st_block_link::buffer</a></div><div class="ttdeci">uchar * buffer</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00212">mf_keycache.c:212</a></div></div>
<div class="ttc" id="astructst__block__link_html_afc4d5c506ed49d7d462293085f8bf04c"><div class="ttname"><a href="../../df/d94/structst__block__link.html#afc4d5c506ed49d7d462293085f8bf04c">st_block_link::hits_left</a></div><div class="ttdeci">uint hits_left</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00217">mf_keycache.c:217</a></div></div>
<div class="ttc" id="astructst__hash__link_html"><div class="ttname"><a href="../../df/d23/structst__hash__link.html">st_hash_link</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00173">mf_keycache.c:174</a></div></div>
<div class="ttc" id="astructst__hash__link_html_a84f450ce1bba67403e29a7c39b64c3ba"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#a84f450ce1bba67403e29a7c39b64c3ba">st_hash_link::next</a></div><div class="ttdeci">struct st_hash_link * next</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00175">mf_keycache.c:175</a></div></div>
<div class="ttc" id="astructst__hash__link_html_a86d9ebfe747371bce3d4f10ca53a305b"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#a86d9ebfe747371bce3d4f10ca53a305b">st_hash_link::file</a></div><div class="ttdeci">File file</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00177">mf_keycache.c:177</a></div></div>
<div class="ttc" id="astructst__hash__link_html_ab9a175dc61b90066e8ffa07be0acab07"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#ab9a175dc61b90066e8ffa07be0acab07">st_hash_link::prev</a></div><div class="ttdeci">struct st_hash_link ** prev</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00175">mf_keycache.c:175</a></div></div>
<div class="ttc" id="astructst__hash__link_html_abad37b5c2d2e833857dec14ef1a89584"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#abad37b5c2d2e833857dec14ef1a89584">st_hash_link::requests</a></div><div class="ttdeci">uint requests</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00179">mf_keycache.c:179</a></div></div>
<div class="ttc" id="astructst__hash__link_html_af969ca62a1ea1b37ec47811e55683da8"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#af969ca62a1ea1b37ec47811e55683da8">st_hash_link::block</a></div><div class="ttdeci">struct st_block_link * block</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00176">mf_keycache.c:176</a></div></div>
<div class="ttc" id="astructst__hash__link_html_afdbbbac9502ff0e37dabb0a79889c665"><div class="ttname"><a href="../../df/d23/structst__hash__link.html#afdbbbac9502ff0e37dabb0a79889c665">st_hash_link::diskpos</a></div><div class="ttdeci">my_off_t diskpos</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00178">mf_keycache.c:178</a></div></div>
<div class="ttc" id="astructst__key__cache_html"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html">st_key_cache</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00047">keycache.h:48</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a01c4fedeb76ae5e06f29f7d1eeba7583"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a01c4fedeb76ae5e06f29f7d1eeba7583">st_key_cache::hash_links_used</a></div><div class="ttdeci">int hash_links_used</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00060">keycache.h:60</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a03be2b9cb9f4d32f9f7e051561f44f6e"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a03be2b9cb9f4d32f9f7e051561f44f6e">st_key_cache::blocks_available</a></div><div class="ttdeci">long blocks_available</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00067">keycache.h:67</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a0aba6e5828e9f03609870adee8d794d1"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a0aba6e5828e9f03609870adee8d794d1">st_key_cache::used_ins</a></div><div class="ttdeci">BLOCK_LINK * used_ins</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00075">keycache.h:75</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a0fd6f4a7b37644e6593ec2109ae6a6d1"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a0fd6f4a7b37644e6593ec2109ae6a6d1">st_key_cache::used_last</a></div><div class="ttdeci">BLOCK_LINK * used_last</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00074">keycache.h:74</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a10204e4188193d675167a80995d1a32b"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a10204e4188193d675167a80995d1a32b">st_key_cache::blocks_unused</a></div><div class="ttdeci">ulong blocks_unused</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00063">keycache.h:63</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a15e6b58b18f34975d9ab3887ef374d04"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a15e6b58b18f34975d9ab3887ef374d04">st_key_cache::global_cache_read</a></div><div class="ttdeci">ulonglong global_cache_read</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00103">keycache.h:103</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a195a3307538d819f13b9e91a025b4a8f"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a195a3307538d819f13b9e91a025b4a8f">st_key_cache::cnt_for_resize_op</a></div><div class="ttdeci">ulong cnt_for_resize_op</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00066">keycache.h:66</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a1f7547833bea84dfaf15a6726c49fa9f"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a1f7547833bea84dfaf15a6726c49fa9f">st_key_cache::hash_link_root</a></div><div class="ttdeci">HASH_LINK * hash_link_root</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00069">keycache.h:69</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a205ccdd3a670b3769a371b0f4b78ecd3"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a205ccdd3a670b3769a371b0f4b78ecd3">st_key_cache::disk_blocks</a></div><div class="ttdeci">int disk_blocks</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00061">keycache.h:61</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a214bb6292a1e28f1e2097529b89fcd2a"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a214bb6292a1e28f1e2097529b89fcd2a">st_key_cache::hash_root</a></div><div class="ttdeci">HASH_LINK ** hash_root</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00068">keycache.h:68</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a45604227ffc828dfcfd01f51cdf8201f"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a45604227ffc828dfcfd01f51cdf8201f">st_key_cache::in_resize</a></div><div class="ttdeci">my_bool in_resize</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00050">keycache.h:50</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a53fccf40f036616da23983f571bacb5c"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a53fccf40f036616da23983f571bacb5c">st_key_cache::blocks</a></div><div class="ttdeci">int blocks</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00105">keycache.h:105</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a5747065352c894e9888321d843039dc2"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a5747065352c894e9888321d843039dc2">st_key_cache::min_warm_blocks</a></div><div class="ttdeci">ulong min_warm_blocks</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00055">keycache.h:55</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a65a0f39109ebd8cea95c413231d9b5c8"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a65a0f39109ebd8cea95c413231d9b5c8">st_key_cache::resize_in_flush</a></div><div class="ttdeci">my_bool resize_in_flush</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00051">keycache.h:51</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a69f530a3a5ae02a0bb977610791a4ebc"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a69f530a3a5ae02a0bb977610791a4ebc">st_key_cache::hash_links</a></div><div class="ttdeci">int hash_links</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00059">keycache.h:59</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a6a006dd56ebd3b5e4ae9a485799881c5"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a6a006dd56ebd3b5e4ae9a485799881c5">st_key_cache::in_init</a></div><div class="ttdeci">my_bool in_init</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00106">keycache.h:106</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a6b08e79e1efa06fdce15f26d5a68aacf"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a6b08e79e1efa06fdce15f26d5a68aacf">st_key_cache::file_blocks</a></div><div class="ttdeci">BLOCK_LINK * file_blocks[CHANGED_BLOCKS_HASH]</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00086">keycache.h:86</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a6b4ca9496f3778ff1fec02fe943e5ce7"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a6b4ca9496f3778ff1fec02fe943e5ce7">st_key_cache::key_cache_inited</a></div><div class="ttdeci">my_bool key_cache_inited</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00049">keycache.h:49</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a6cb10b6d1a2973a85d7e12f4d5b8fc4e"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a6cb10b6d1a2973a85d7e12f4d5b8fc4e">st_key_cache::global_cache_w_requests</a></div><div class="ttdeci">ulonglong global_cache_w_requests</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00100">keycache.h:100</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a6d94ce3a7dd45735a3791f499fac1b48"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a6d94ce3a7dd45735a3791f499fac1b48">st_key_cache::keycache_time</a></div><div class="ttdeci">ulonglong keycache_time</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00057">keycache.h:57</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a70c8ed6c22a38a7cc7825d45043d7ced"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a70c8ed6c22a38a7cc7825d45043d7ced">st_key_cache::waiting_for_hash_link</a></div><div class="ttdeci">KEYCACHE_WQUEUE waiting_for_hash_link</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00083">keycache.h:83</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a73ec6aff3cdadaa94423c34117335d38"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a73ec6aff3cdadaa94423c34117335d38">st_key_cache::hash_entries</a></div><div class="ttdeci">uint hash_entries</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00058">keycache.h:58</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a7644055eb236db90a60a248f8371a80c"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a7644055eb236db90a60a248f8371a80c">st_key_cache::global_cache_r_requests</a></div><div class="ttdeci">ulonglong global_cache_r_requests</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00102">keycache.h:102</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a8a83a6143b60800f36c9e4ec01b1e0c7"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a8a83a6143b60800f36c9e4ec01b1e0c7">st_key_cache::key_cache_mem_size</a></div><div class="ttdeci">size_t key_cache_mem_size</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00053">keycache.h:53</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a8be000eb2b02c4546785eea3863852d5"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a8be000eb2b02c4546785eea3863852d5">st_key_cache::blocks_used</a></div><div class="ttdeci">ulong blocks_used</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00062">keycache.h:62</a></div></div>
<div class="ttc" id="astructst__key__cache_html_a8c3951279d9f519a03b3f5f58e287f77"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#a8c3951279d9f519a03b3f5f58e287f77">st_key_cache::free_block_list</a></div><div class="ttdeci">BLOCK_LINK * free_block_list</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00071">keycache.h:71</a></div></div>
<div class="ttc" id="astructst__key__cache_html_aa4cf975fd8c509c6fc1df2085668ce3f"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#aa4cf975fd8c509c6fc1df2085668ce3f">st_key_cache::global_blocks_changed</a></div><div class="ttdeci">ulong global_blocks_changed</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00099">keycache.h:99</a></div></div>
<div class="ttc" id="astructst__key__cache_html_aa8b767d9e296d3aba7c4adcd489e85d1"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#aa8b767d9e296d3aba7c4adcd489e85d1">st_key_cache::free_hash_list</a></div><div class="ttdeci">HASH_LINK * free_hash_list</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00070">keycache.h:70</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ab1c68aadca5cfa66a26b6a6c5f01581f"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ab1c68aadca5cfa66a26b6a6c5f01581f">st_key_cache::resize_queue</a></div><div class="ttdeci">KEYCACHE_WQUEUE resize_queue</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00077">keycache.h:77</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ab3dd090ab676f8dbffb26e6417871a26"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ab3dd090ab676f8dbffb26e6417871a26">st_key_cache::warm_blocks</a></div><div class="ttdeci">ulong warm_blocks</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00065">keycache.h:65</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ab66e725e66c8d135d522e0fc823fb074"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ab66e725e66c8d135d522e0fc823fb074">st_key_cache::global_cache_write</a></div><div class="ttdeci">ulonglong global_cache_write</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00101">keycache.h:101</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ab9fefdf1573f621eed3162c7956ae7a2"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ab9fefdf1573f621eed3162c7956ae7a2">st_key_cache::blocks_changed</a></div><div class="ttdeci">ulong blocks_changed</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00064">keycache.h:64</a></div></div>
<div class="ttc" id="astructst__key__cache_html_abfa3854a1818c0073587b2c91656d253"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#abfa3854a1818c0073587b2c91656d253">st_key_cache::block_mem</a></div><div class="ttdeci">uchar * block_mem</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00073">keycache.h:73</a></div></div>
<div class="ttc" id="astructst__key__cache_html_acdc4f979ecbe74d9625194ab8f96d596"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#acdc4f979ecbe74d9625194ab8f96d596">st_key_cache::age_threshold</a></div><div class="ttdeci">ulong age_threshold</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00056">keycache.h:56</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ad5a09f20e50aa7eb71414882ff7e5ba3"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ad5a09f20e50aa7eb71414882ff7e5ba3">st_key_cache::cache_lock</a></div><div class="ttdeci">mysql_mutex_t cache_lock</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00076">keycache.h:76</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ae3c67ed105880d4caf9f1664140a21b8"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ae3c67ed105880d4caf9f1664140a21b8">st_key_cache::waiting_for_resize_cnt</a></div><div class="ttdeci">KEYCACHE_WQUEUE waiting_for_resize_cnt</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00082">keycache.h:82</a></div></div>
<div class="ttc" id="astructst__key__cache_html_ae8a9712fee09d718d4b75e6cd3425a43"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#ae8a9712fee09d718d4b75e6cd3425a43">st_key_cache::can_be_used</a></div><div class="ttdeci">my_bool can_be_used</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00052">keycache.h:52</a></div></div>
<div class="ttc" id="astructst__key__cache_html_af799030c4672e0745d41fcd1237c0cfc"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#af799030c4672e0745d41fcd1237c0cfc">st_key_cache::key_cache_block_size</a></div><div class="ttdeci">uint key_cache_block_size</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00054">keycache.h:54</a></div></div>
<div class="ttc" id="astructst__key__cache_html_afbf35ec0d3013bd960d554a5baadbee6"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#afbf35ec0d3013bd960d554a5baadbee6">st_key_cache::block_root</a></div><div class="ttdeci">BLOCK_LINK * block_root</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00072">keycache.h:72</a></div></div>
<div class="ttc" id="astructst__key__cache_html_afc91103c4a90a69b7e37e708398b3a82"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#afc91103c4a90a69b7e37e708398b3a82">st_key_cache::changed_blocks</a></div><div class="ttdeci">BLOCK_LINK * changed_blocks[CHANGED_BLOCKS_HASH]</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00085">keycache.h:85</a></div></div>
<div class="ttc" id="astructst__key__cache_html_afdb802b84e665d8365ebb1593647e4e2"><div class="ttname"><a href="../../d7/dcc/structst__key__cache.html#afdb802b84e665d8365ebb1593647e4e2">st_key_cache::waiting_for_block</a></div><div class="ttdeci">KEYCACHE_WQUEUE waiting_for_block</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00084">keycache.h:84</a></div></div>
<div class="ttc" id="astructst__keycache__page_html"><div class="ttname"><a href="../../d1/d62/structst__keycache__page.html">st_keycache_page</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00166">mf_keycache.c:167</a></div></div>
<div class="ttc" id="astructst__keycache__page_html_a60c9c44d796bf7ea52523b85990c02e7"><div class="ttname"><a href="../../d1/d62/structst__keycache__page.html#a60c9c44d796bf7ea52523b85990c02e7">st_keycache_page::file</a></div><div class="ttdeci">int file</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00168">mf_keycache.c:168</a></div></div>
<div class="ttc" id="astructst__keycache__page_html_afc13551881e36ec1c275afa63a7bea96"><div class="ttname"><a href="../../d1/d62/structst__keycache__page.html#afc13551881e36ec1c275afa63a7bea96">st_keycache_page::filepos</a></div><div class="ttdeci">my_off_t filepos</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d26/mf__keycache_8c_source.html#l00169">mf_keycache.c:169</a></div></div>
<div class="ttc" id="astructst__keycache__wqueue_html"><div class="ttname"><a href="../../d6/d3e/structst__keycache__wqueue.html">st_keycache_wqueue</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00035">keycache.h:36</a></div></div>
<div class="ttc" id="astructst__keycache__wqueue_html_a27c0709f688c35d2d8dda33b3d5afbc5"><div class="ttname"><a href="../../d6/d3e/structst__keycache__wqueue.html#a27c0709f688c35d2d8dda33b3d5afbc5">st_keycache_wqueue::last_thread</a></div><div class="ttdeci">struct st_my_thread_var * last_thread</div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc2/keycache_8h_source.html#l00037">keycache.h:37</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html">st_my_thread_var</a></div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00837">my_pthread.h:838</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_a046a68d7a4b5d11411bdcd36f0fa0cb2"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#a046a68d7a4b5d11411bdcd36f0fa0cb2">st_my_thread_var::next</a></div><div class="ttdeci">struct st_my_thread_var * next</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00849">my_pthread.h:849</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_a14f8cf04865393cc9ec2062a99664a36"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#a14f8cf04865393cc9ec2062a99664a36">st_my_thread_var::opt_info</a></div><div class="ttdeci">void * opt_info</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00850">my_pthread.h:850</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_a75cde5f212dd947df1ca2da90eca10ef"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#a75cde5f212dd947df1ca2da90eca10ef">st_my_thread_var::id</a></div><div class="ttdeci">my_thread_id id</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00845">my_pthread.h:845</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_aa65ed44b8f48d67dd074ff4139ea1ee2"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#aa65ed44b8f48d67dd074ff4139ea1ee2">st_my_thread_var::mutex</a></div><div class="ttdeci">mysql_mutex_t mutex</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00841">my_pthread.h:841</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_ab2f151895d035f11ad7e1cd180dfe398"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#ab2f151895d035f11ad7e1cd180dfe398">st_my_thread_var::prev</a></div><div class="ttdeci">struct st_my_thread_var ** prev</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00849">my_pthread.h:849</a></div></div>
<div class="ttc" id="astructst__my__thread__var_html_ac3460024f00cf551a79e984df011505d"><div class="ttname"><a href="../../de/d9e/structst__my__thread__var.html#ac3460024f00cf551a79e984df011505d">st_my_thread_var::suspend</a></div><div class="ttdeci">mysql_cond_t suspend</div><div class="ttdef"><b>Definition:</b> <a href="../../da/da8/my__pthread_8h_source.html#l00840">my_pthread.h:840</a></div></div>
<div class="ttc" id="astructst__mysql__cond_html"><div class="ttname"><a href="../../d9/d27/structst__mysql__cond.html">st_mysql_cond</a></div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00154">mysql_thread.h:155</a></div></div>
<div class="ttc" id="astructst__mysql__mutex_html"><div class="ttname"><a href="../../d0/d93/structst__mysql__mutex.html">st_mysql_mutex</a></div><div class="ttdef"><b>Definition:</b> <a href="../../da/da5/mysql__thread_8h_source.html#l00069">mysql_thread.h:70</a></div></div>
<div class="ttc" id="athr__lock_8c_html_a8b5173357adb02a86c027316e0acdfa0"><div class="ttname"><a href="../../d1/d09/thr__lock_8c.html#a8b5173357adb02a86c027316e0acdfa0">MAX_THREADS</a></div><div class="ttdeci">#define MAX_THREADS</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d09/thr__lock_8c_source.html#l00086">thr_lock.c:86</a></div></div>
<div class="ttc" id="atools_2mmaps__generator_2_path_generator_8cpp_html_a32e7545f3a98690aeb284a4eb66f272d"><div class="ttname"><a href="../../dd/d0e/tools_2mmaps__generator_2_path_generator_8cpp.html#a32e7545f3a98690aeb284a4eb66f272d">finish</a></div><div class="ttdeci">int finish(const char *message, int returnValue)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d0e/tools_2mmaps__generator_2_path_generator_8cpp_source.html#l00234">PathGenerator.cpp:234</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
