<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Azerotcore-wotlk: src/server/database/Updater/UpdateFetcher.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Azerotcore-wotlk
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="../../dir_075bb3ff235063c77951cd176d15a741.html">server</a></li><li class="navelem"><a class="el" href="../../dir_b27e3fd3791d8d69e8eb857d9542c835.html">database</a></li><li class="navelem"><a class="el" href="../../dir_06f6fc4749db3adbadf672d0465f516d.html">Updater</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">UpdateFetcher.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d1/d40/_update_fetcher_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * This file is part of the AzerothCore Project. See AUTHORS file for Copyright information</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * This program is free software; you can redistribute it and/or modify it</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * under the terms of the GNU Affero General Public License as published by the</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Free Software Foundation; either version 3 of the License, or (at your</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * option) any later version.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful, but WITHOUT</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * more details.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License along</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; </div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/d0d/_update_fetcher_8h.html">UpdateFetcher.h</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d3/d9b/_crypto_hash_8h.html">CryptoHash.h</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dc/dca/_d_b_updater_8h.html">DBUpdater.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/_field_8h.html">Field.h</a>&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;Log.h&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../de/d66/_query_result_8h.html">QueryResult.h</a>&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/d43/_tokenize_8h.html">Tokenize.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;Util.h&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160; </div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">using namespace </span>std::filesystem;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">   31</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">UpdateFetcher::DirectoryEntry</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;{</div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#a02538aefc1b014b60957d4c67793000f">   33</a></span>&#160;    <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#a02538aefc1b014b60957d4c67793000f">DirectoryEntry</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; path_, <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cb">State</a> state_) : path(path_), state(state_) { }</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aca34dff6659f2da63f31e12bb41cf3d0">   35</a></span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span> <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aca34dff6659f2da63f31e12bb41cf3d0">path</a>;</div>
<div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aeddd31e8fbb23e54549e985f09c4ea96">   36</a></span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cb">State</a> <span class="keyword">const</span> <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aeddd31e8fbb23e54549e985f09c4ea96">state</a>;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;};</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#a3a9a202b32079b6f623de924eb64de30">   39</a></span>&#160;<a class="code" href="../../de/d9c/class_update_fetcher.html#a3a9a202b32079b6f623de924eb64de30">UpdateFetcher::UpdateFetcher</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; sourceDirectory,</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;                             std::function&lt;<span class="keywordtype">void</span>(std::string <span class="keyword">const</span>&amp;)&gt; <span class="keyword">const</span>&amp; <a class="code" href="../../de/d2e/namespace_byte_converter.html#a6177d7ac84a4ea6819c57a124345540e">apply</a>,</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;                             std::function&lt;<span class="keywordtype">void</span>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; path)&gt; <span class="keyword">const</span>&amp; applyFile,</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                             std::function&lt;<a class="code" href="../../db/d04/_database_env_fwd_8h.html#ab0c9feeec448a181290fcb39565b8253">QueryResult</a>(std::string <span class="keyword">const</span>&amp;)&gt; <span class="keyword">const</span>&amp; retrieve, std::string <span class="keyword">const</span>&amp; dbModuleName, std::vector&lt;std::string&gt; <span class="keyword">const</span>* setDirectories <span class="comment">/*= nullptr*/</span>) :</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    _sourceDirectory(<a class="code" href="../../d8/dcc/namespacestd.html">std</a>::make_unique&lt;<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a>&gt;(sourceDirectory)), _apply(<a class="code" href="../../de/d2e/namespace_byte_converter.html#a6177d7ac84a4ea6819c57a124345540e">apply</a>), _applyFile(applyFile),</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    _retrieve(retrieve), _dbModuleName(dbModuleName), _setDirectories(setDirectories)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;{</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;}</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#abd11bb24a80148b6df4d0d35c9c88c51">   48</a></span>&#160;<a class="code" href="../../de/d9c/class_update_fetcher.html#abd11bb24a80148b6df4d0d35c9c88c51">UpdateFetcher::~UpdateFetcher</a>()</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;}</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#a3c4e792ed5dc1016da8f9bb709b6d193">   52</a></span>&#160;<a class="code" href="../../de/d9c/class_update_fetcher.html#a4b3294e1e96be56b5b2b60638e9da35f">UpdateFetcher::LocaleFileStorage</a> <a class="code" href="../../de/d9c/class_update_fetcher.html#a3c4e792ed5dc1016da8f9bb709b6d193">UpdateFetcher::GetFileList</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a4b3294e1e96be56b5b2b60638e9da35f">LocaleFileStorage</a> <a class="code" href="../../d4/d4b/deps_2_s_f_m_t_2_readme_8txt.html#aac939c3bd649f24d0faa40c551bd3da7">files</a>;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#aba8b6a3e4101d39c2ce7ddd6856c7ad1">DirectoryStorage</a> directories = <a class="code" href="../../de/d9c/class_update_fetcher.html#af5faa613edb979a761f04784e8e9143f">ReceiveIncludedDirectories</a>();</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; entry : directories)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <a class="code" href="../../de/d9c/class_update_fetcher.html#ab062338b0cbf4f1cd2ce67ac3d14fba2">FillFileListRecursively</a>(entry.path, <a class="code" href="../../d4/d4b/deps_2_s_f_m_t_2_readme_8txt.html#aac939c3bd649f24d0faa40c551bd3da7">files</a>, entry.state, 1);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d4/d4b/deps_2_s_f_m_t_2_readme_8txt.html#aac939c3bd649f24d0faa40c551bd3da7">files</a>;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;}</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#ab062338b0cbf4f1cd2ce67ac3d14fba2">   62</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#ab062338b0cbf4f1cd2ce67ac3d14fba2">UpdateFetcher::FillFileListRecursively</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; path, <a class="code" href="../../de/d9c/class_update_fetcher.html#a4b3294e1e96be56b5b2b60638e9da35f">LocaleFileStorage</a>&amp; storage, <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cb">State</a> <span class="keyword">const</span> state, <a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a> <span class="keyword">const</span> depth)<span class="keyword"> const</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keyword">static</span> <a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a> <span class="keyword">const</span> MAX_DEPTH = 10;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keyword">static</span> directory_iterator <span class="keyword">const</span> end;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordflow">for</span> (directory_iterator itr(path); itr != end; ++itr)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <span class="keywordflow">if</span> (is_directory(itr-&gt;path()))</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;            <span class="keywordflow">if</span> (depth &lt; MAX_DEPTH)</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                <a class="code" href="../../de/d9c/class_update_fetcher.html#ab062338b0cbf4f1cd2ce67ac3d14fba2">FillFileListRecursively</a>(itr-&gt;path(), storage, state, depth + 1);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        }</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itr-&gt;path().extension() == <span class="stringliteral">&quot;.sql&quot;</span>)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5">LOG_TRACE</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Added locale file \&quot;%s\&quot; state &#39;%s&#39;.&quot;</span>, itr-&gt;path().filename().generic_string().c_str(), <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(state).c_str());</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <a class="code" href="../../de/d9c/class_update_fetcher.html#adb2996b906800fb0cdb5cf7ae14353d0">LocaleFileEntry</a> <span class="keyword">const</span> entry = { itr-&gt;path(), state };</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            <span class="comment">// Check for doubled filenames</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            <span class="comment">// Because elements are only compared by their filenames, this is ok</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            <span class="keywordflow">if</span> (storage.find(entry) != storage.end())</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a0e09b50c268dc6897a1c70aa46de936e">LOG_FATAL</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Duplicate filename \&quot;%s\&quot; occurred. Because updates are ordered &quot;</span> \</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                          <span class="stringliteral">&quot;by their filenames, every name needs to be unique!&quot;</span>, itr-&gt;path().generic_string().c_str());</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                <span class="keywordflow">throw</span> <a class="code" href="../../df/d9b/class_update_exception.html">UpdateException</a>(<span class="stringliteral">&quot;Updating failed, see the log for details.&quot;</span>);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            storage.insert(entry);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;}</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#af5faa613edb979a761f04784e8e9143f">   95</a></span>&#160;<a class="code" href="../../de/d9c/class_update_fetcher.html#aba8b6a3e4101d39c2ce7ddd6856c7ad1">UpdateFetcher::DirectoryStorage</a> <a class="code" href="../../de/d9c/class_update_fetcher.html#af5faa613edb979a761f04784e8e9143f">UpdateFetcher::ReceiveIncludedDirectories</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#aba8b6a3e4101d39c2ce7ddd6856c7ad1">DirectoryStorage</a> directories;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d9c/class_update_fetcher.html#a0f766525f7f9757a0cf14059952825f0">_setDirectories</a>)</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; itr : *<a class="code" href="../../de/d9c/class_update_fetcher.html#a0f766525f7f9757a0cf14059952825f0">_setDirectories</a>)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            std::string path = <a class="code" href="../../de/d9c/class_update_fetcher.html#a3a9e3d284f6bc45a155a17a7bd3284e2">_sourceDirectory</a>-&gt;generic_string() + itr;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span> p(path);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <span class="keywordflow">if</span> (!is_directory(p))</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160; </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">DirectoryEntry</a> <span class="keyword">const</span> entry = {p, <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(<span class="stringliteral">&quot;MODULE&quot;</span>)};</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            directories.push_back(entry);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5">LOG_TRACE</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Added applied extra file \&quot;%s\&quot; from remote.&quot;</span>, p.filename().generic_string().c_str());</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    }</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <a class="code" href="../../db/d04/_database_env_fwd_8h.html#ab0c9feeec448a181290fcb39565b8253">QueryResult</a> <span class="keyword">const</span> <a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a> = <a class="code" href="../../de/d9c/class_update_fetcher.html#aea00e99b87bd24fd182676bf79e68c95">_retrieve</a>(<span class="stringliteral">&quot;SELECT `path`, `state` FROM `updates_include`&quot;</span>);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>)</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keywordflow">return</span> directories;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="keywordflow">do</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        {</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <a class="code" href="../../dc/d67/class_field.html">Field</a>* fields = <a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>-&gt;Fetch();</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160; </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            std::string path  = fields[0].<a class="code" href="../../dc/d67/class_field.html#a4d8f9d6164f9d3d7a26891dbd5003fa6">GetString</a>();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            std::string state = fields[1].<a class="code" href="../../dc/d67/class_field.html#a4d8f9d6164f9d3d7a26891dbd5003fa6">GetString</a>();</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="keywordflow">if</span> (path.substr(0, 1) == <span class="stringliteral">&quot;$&quot;</span>)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                path = <a class="code" href="../../de/d9c/class_update_fetcher.html#a3a9e3d284f6bc45a155a17a7bd3284e2">_sourceDirectory</a>-&gt;generic_string() + path.substr(1);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160; </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span> p(path);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            <span class="keywordflow">if</span> (!is_directory(p))</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#adf09840a666e1d86bcd3439105db6edc">LOG_WARN</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;DBUpdater: Given update include directory \&quot;%s\&quot; does not exist, skipped!&quot;</span>, p.generic_string().c_str());</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">DirectoryEntry</a> <span class="keyword">const</span> entry = {p, <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(state)};</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            directories.push_back(entry);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5">LOG_TRACE</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Added applied file \&quot;%s\&quot; &#39;%s&#39; state from remote.&quot;</span>, p.filename().generic_string().c_str(), state.c_str());</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        } <span class="keywordflow">while</span> (<a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>-&gt;NextRow());</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        std::vector&lt;std::string&gt; moduleList;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keyword">auto</span> <span class="keyword">const</span>&amp; _modulesTokens = <a class="code" href="../../d1/d7d/namespace_acore.html#a6b121485ace4118b9006db1fb89f90f2">Acore::Tokenize</a>(AC_MODULES_LIST, <span class="charliteral">&#39;,&#39;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; itr : _modulesTokens) moduleList.emplace_back(itr);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <span class="comment">// data/sql</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; itr : moduleList)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        {</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            std::string path = <a class="code" href="../../de/d9c/class_update_fetcher.html#a3a9e3d284f6bc45a155a17a7bd3284e2">_sourceDirectory</a>-&gt;generic_string() + <span class="stringliteral">&quot;/modules/&quot;</span> + itr + <span class="stringliteral">&quot;/data/sql/&quot;</span> + <a class="code" href="../../de/d9c/class_update_fetcher.html#a2c9442584093618696273003dd090c18">_dbModuleName</a>; <span class="comment">// modules/mod-name/data/sql/db-world</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span> p(path);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="keywordflow">if</span> (!is_directory(p))</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <a class="code" href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">DirectoryEntry</a> <span class="keyword">const</span> entry = {p, <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(<span class="stringliteral">&quot;MODULE&quot;</span>)};</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            directories.push_back(entry);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160; </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5">LOG_TRACE</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Added applied modules file \&quot;%s\&quot; from remote.&quot;</span>, p.filename().generic_string().c_str());</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keywordflow">return</span> directories;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;}</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#ad8dd66f9b12ae37fd657a8983a9ea6a1">  169</a></span>&#160;<a class="code" href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">UpdateFetcher::AppliedFileStorage</a> <a class="code" href="../../de/d9c/class_update_fetcher.html#ad8dd66f9b12ae37fd657a8983a9ea6a1">UpdateFetcher::ReceiveAppliedFiles</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">AppliedFileStorage</a> map;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <a class="code" href="../../db/d04/_database_env_fwd_8h.html#ab0c9feeec448a181290fcb39565b8253">QueryResult</a> <a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a> = <a class="code" href="../../de/d9c/class_update_fetcher.html#aea00e99b87bd24fd182676bf79e68c95">_retrieve</a>(<span class="stringliteral">&quot;SELECT `name`, `hash`, `state`, UNIX_TIMESTAMP(`timestamp`) FROM `updates` ORDER BY `name` ASC&quot;</span>);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordflow">return</span> map;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <a class="code" href="../../dc/d67/class_field.html">Field</a>* fields = <a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>-&gt;Fetch();</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html">AppliedFileEntry</a> <span class="keyword">const</span> entry =</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        {</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            fields[0].<a class="code" href="../../dc/d67/class_field.html#a4d8f9d6164f9d3d7a26891dbd5003fa6">GetString</a>(), fields[1].<a class="code" href="../../dc/d67/class_field.html#a4d8f9d6164f9d3d7a26891dbd5003fa6">GetString</a>(), <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(fields[2].GetString()), fields[3].<a class="code" href="../../dc/d67/class_field.html#a757dd8cac1b769fdb82d8a529bad9d5b">GetUInt64</a>()</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        };</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        map.emplace(entry.<a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#a8fc429eae6816054b5828952a5698a4c">name</a>, entry);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    } <span class="keywordflow">while</span> (<a class="code" href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">result</a>-&gt;NextRow());</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">return</span> map;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;}</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#a8e362ef41c19586ac1b13ecf77148a6d">  192</a></span>&#160;std::string <a class="code" href="../../de/d9c/class_update_fetcher.html#a8e362ef41c19586ac1b13ecf77148a6d">UpdateFetcher::ReadSQLUpdate</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    std::ifstream in(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>.c_str());</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordflow">if</span> (!in.is_open())</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a0e09b50c268dc6897a1c70aa46de936e">LOG_FATAL</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Failed to open the sql update \&quot;%s\&quot; for reading! &quot;</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                  <span class="stringliteral">&quot;Stopping the server to keep the database integrity, &quot;</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                  <span class="stringliteral">&quot;try to identify and solve the issue or disable the database updater.&quot;</span>,</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                  <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>.generic_string().c_str());</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">throw</span> <a class="code" href="../../df/d9b/class_update_exception.html">UpdateException</a>(<span class="stringliteral">&quot;Opening the sql update failed!&quot;</span>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keyword">auto</span> update = [&amp;in]</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        std::ostringstream ss;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        ss &lt;&lt; in.rdbuf();</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">return</span> ss.str();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    }();</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    in.close();</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">return</span> update;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;}</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; </div>
<div class="line"><a name="l00216"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#aa2b76c97a4b001de538a4268dcbeb365">  216</a></span>&#160;<a class="code" href="../../d4/da6/struct_update_result.html">UpdateResult</a> <a class="code" href="../../de/d9c/class_update_fetcher.html#aa2b76c97a4b001de538a4268dcbeb365">UpdateFetcher::Update</a>(<span class="keywordtype">bool</span> <span class="keyword">const</span> redundancyChecks,</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                                   <span class="keywordtype">bool</span> <span class="keyword">const</span> allowRehash,</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                                   <span class="keywordtype">bool</span> <span class="keyword">const</span> archivedRedundancy,</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                                   <a class="code" href="../../db/d35/_define_8h.html#a0bf9964a3ce962c07ad3d8b5432bbbcd">int32</a> <span class="keyword">const</span> cleanDeadReferencesMaxCount)<span class="keyword"> const</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a4b3294e1e96be56b5b2b60638e9da35f">LocaleFileStorage</a> <span class="keyword">const</span> available = <a class="code" href="../../de/d9c/class_update_fetcher.html#a3c4e792ed5dc1016da8f9bb709b6d193">GetFileList</a>();</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d9c/class_update_fetcher.html#a0f766525f7f9757a0cf14059952825f0">_setDirectories</a> &amp;&amp; available.empty())</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../d4/da6/struct_update_result.html">UpdateResult</a>();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">AppliedFileStorage</a> applied = <a class="code" href="../../de/d9c/class_update_fetcher.html#ad8dd66f9b12ae37fd657a8983a9ea6a1">ReceiveAppliedFiles</a>();</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">size_t</span> countRecentUpdates = 0;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordtype">size_t</span> countArchivedUpdates = 0;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">// Count updates</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; entry : applied)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="keywordflow">if</span> (entry.second.state == <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbae4e3bbfa8ddc283a5eededb71917098a">RELEASED</a>)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            ++countRecentUpdates;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            ++countArchivedUpdates;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// Fill hash to name cache</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#ace16a0c67cff7fc411d470b3085d90d8">HashToFileNameStorage</a> hashToName;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> entry : applied)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        hashToName.insert(std::make_pair(entry.second.hash, entry.first));</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordtype">size_t</span> importedUpdates = 0;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keyword">auto</span> ApplyUpdateFile = [&amp;](<a class="code" href="../../de/d9c/class_update_fetcher.html#adb2996b906800fb0cdb5cf7ae14353d0">LocaleFileEntry</a> <span class="keyword">const</span>&amp; sqlFile)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keyword">auto</span> filePath = sqlFile.first;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="keyword">auto</span> fileState = sqlFile.second;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Checking update \&quot;%s\&quot;...&quot;</span>, filePath.filename().generic_string().c_str());</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        AppliedFileStorage::const_iterator iter = applied.find(filePath.filename().string());</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="keywordflow">if</span> (iter != applied.end())</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        {</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="comment">// If redundancy is disabled, skip it, because the update is already applied.</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            <span class="keywordflow">if</span> (!redundancyChecks)</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Update is already applied, skipping redundancy checks.&quot;</span>);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                applied.erase(iter);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <span class="comment">// If the update is in an archived directory and is marked as archived in our database, skip redundancy checks (archived updates never change).</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="keywordflow">if</span> (!archivedRedundancy &amp;&amp; (iter-&gt;second.state == <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbae5b766afead812f823b982c5421629a8">ARCHIVED</a>) &amp;&amp; (sqlFile.second == <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbae5b766afead812f823b982c5421629a8">ARCHIVED</a>))</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            {</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Update is archived and marked as archived in database, skipping redundancy checks.&quot;</span>);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                applied.erase(iter);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        std::string <span class="keyword">const</span> <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a> = <a class="code" href="../../d9/de9/src_2common_2_utilities_2util_8h.html#a559d532d2bfeee7ed59f0b1dbce4e86a">ByteArrayToHexStr</a>(<a class="code" href="../../dc/de8/class_acore_1_1_impl_1_1_generic_hash.html#aeff80fe722abc16c9307d6ae50f22425">Acore::Crypto::SHA1::GetDigestOf</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a8e362ef41c19586ac1b13ecf77148a6d">ReadSQLUpdate</a>(filePath)));</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5c">UpdateMode</a> mode = <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5ca8aca24718213eedb0d7a10d636a9323d">MODE_APPLY</a>;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">// Update is not in our applied list</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keywordflow">if</span> (iter == applied.end())</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="comment">// Catch renames (different filename, but same hash)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            HashToFileNameStorage::const_iterator <span class="keyword">const</span> hashIter = hashToName.find(<a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            <span class="keywordflow">if</span> (hashIter != hashToName.end())</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="comment">// Check if the original file was removed. If not, we&#39;ve got a problem.</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                LocaleFileStorage::const_iterator localeIter;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="comment">// Push localeIter forward</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                <span class="keywordflow">for</span> (localeIter = available.begin(); (localeIter != available.end()) &amp;&amp;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                        (localeIter-&gt;first.filename().string() != hashIter-&gt;second); ++localeIter);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160; </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                <span class="comment">// Conflict!</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                <span class="keywordflow">if</span> (localeIter != available.end())</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                    <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#adf09840a666e1d86bcd3439105db6edc">LOG_WARN</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; It seems like the update \&quot;%s\&quot; \&#39;%s\&#39; was renamed, but the old file is still there! &quot;</span> \</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                             <span class="stringliteral">&quot;Treating it as a new file! (It is probably an unmodified copy of the file \&quot;%s\&quot;)&quot;</span>,</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                             filePath.filename().string().c_str(), <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str(),</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                             localeIter-&gt;first.filename().string().c_str());</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                }</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                <span class="keywordflow">else</span> <span class="comment">// It is safe to treat the file as renamed here</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                {</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                    <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Renaming update \&quot;%s\&quot; to \&quot;%s\&quot; \&#39;%s\&#39;.&quot;</span>,</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                             hashIter-&gt;second.c_str(), filePath.filename().string().c_str(), <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str());</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                    <a class="code" href="../../de/d9c/class_update_fetcher.html#acd434dd3fa7a7b5dc0af64926d07dfcd">RenameEntry</a>(hashIter-&gt;second, filePath.filename().string());</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    applied.erase(hashIter-&gt;second);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            <span class="comment">// Apply the update if it was never seen before.</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Applying update \&quot;%s\&quot; \&#39;%s\&#39;...&quot;</span>,</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    filePath.filename().string().c_str(), <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str());</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="comment">// Rehash the update entry if it exists in our database with an empty hash.</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (allowRehash &amp;&amp; iter-&gt;second.hash.empty())</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        {</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            mode = <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5caafa5bf4aecde3d595d1119d51bb2f930">MODE_REHASH</a>;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Re-hashing update \&quot;%s\&quot; \&#39;%s\&#39;...&quot;</span>, filePath.filename().string().c_str(),</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str());</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            <span class="comment">// If the hash of the files differs from the one stored in our database, reapply the update (because it changed).</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            <span class="keywordflow">if</span> (iter-&gt;second.hash != <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>)</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            {</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Reapplying update \&quot;%s\&quot; \&#39;%s\&#39; -&gt; \&#39;%s\&#39; (it changed)...&quot;</span>, filePath.filename().string().c_str(),</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                    iter-&gt;second.hash.substr(0, 7).c_str(), <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str());</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            }</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="comment">// If the file wasn&#39;t changed and just moved, update its state (if necessary).</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                <span class="keywordflow">if</span> (iter-&gt;second.state != fileState)</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                    <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Updating the state of \&quot;%s\&quot; to \&#39;%s\&#39;...&quot;</span>,</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                              filePath.filename().string().c_str(), <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(fileState).c_str());</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                    <a class="code" href="../../de/d9c/class_update_fetcher.html#a3f2c0b3f92c460124562e8d8a15d9498">UpdateState</a>(filePath.filename().string(), fileState);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; Update is already applied and matches the hash \&#39;%s\&#39;.&quot;</span>, <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>.substr(0, 7).c_str());</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160; </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                applied.erase(iter);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160; </div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a> speed = 0;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html">AppliedFileEntry</a> <span class="keyword">const</span> <a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a> = { filePath.filename().string(), <a class="code" href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a>, fileState, 0 };</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160; </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">switch</span> (mode)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5ca8aca24718213eedb0d7a10d636a9323d">MODE_APPLY</a>:</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                speed = <a class="code" href="../../de/d9c/class_update_fetcher.html#a24699e8cc9d32551c24be563904bfdec">Apply</a>(filePath);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            <span class="comment">/* fallthrough */</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5caafa5bf4aecde3d595d1119d51bb2f930">MODE_REHASH</a>:</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                <a class="code" href="../../de/d9c/class_update_fetcher.html#aa3e942e715d8e205307e2f73fe5b6903">UpdateEntry</a>(<a class="code" href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">file</a>, speed);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        }</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160; </div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="keywordflow">if</span> (iter != applied.end())</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            applied.erase(iter);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="keywordflow">if</span> (mode == <a class="code" href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5ca8aca24718213eedb0d7a10d636a9323d">MODE_APPLY</a>)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            ++importedUpdates;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    };</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160; </div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">// Apply default updates</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; availableQuery : available)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">if</span> (availableQuery.second != <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbab25140471fb922c632f3d126d2a3e5b4">CUSTOM</a> &amp;&amp; availableQuery.second != <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbaf24fbaf4f357560007067272d5d238f4">MODULE</a>)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            ApplyUpdateFile(availableQuery);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">// Apply only custom/module updates</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; availableQuery : available)</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="keywordflow">if</span> (availableQuery.second == <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbab25140471fb922c632f3d126d2a3e5b4">CUSTOM</a> || availableQuery.second == <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbaf24fbaf4f357560007067272d5d238f4">MODULE</a>)</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            ApplyUpdateFile(availableQuery);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    }</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160; </div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="comment">// Cleanup up orphaned entries (if enabled)</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordflow">if</span> (!applied.empty() &amp;&amp; !<a class="code" href="../../de/d9c/class_update_fetcher.html#a0f766525f7f9757a0cf14059952825f0">_setDirectories</a>)</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        <span class="keywordtype">bool</span> <span class="keyword">const</span> doCleanup = (cleanDeadReferencesMaxCount &lt; 0) || (applied.size() &lt;= <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(cleanDeadReferencesMaxCount));</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160; </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <a class="code" href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">AppliedFileStorage</a> toCleanup;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; entry : applied)</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            <span class="keywordflow">if</span> (entry.second.state != <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbaf24fbaf4f357560007067272d5d238f4">MODULE</a>)</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            {</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#adf09840a666e1d86bcd3439105db6edc">LOG_WARN</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>,</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                         <span class="stringliteral">&quot;&gt;&gt; The file \&#39;%s\&#39; was applied to the database, but is missing in&quot;</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                         <span class="stringliteral">&quot; your update directory now!&quot;</span>,</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                         entry.first.c_str());</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160; </div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                <span class="keywordflow">if</span> (doCleanup)</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                    <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>, <span class="stringliteral">&quot;Deleting orphaned entry \&#39;%s\&#39;...&quot;</span>, entry.first.c_str());</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                    toCleanup.insert(entry);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                }</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160; </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">if</span> (!toCleanup.empty())</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        {</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">if</span> (doCleanup)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                <a class="code" href="../../de/d9c/class_update_fetcher.html#adace6180bb32614655fb1f99bbf4c1ef">CleanUp</a>(toCleanup);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            {</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <a class="code" href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a43832e3fa8508deb4ce43e520005fcd9">LOG_ERROR</a>(<span class="stringliteral">&quot;sql.updates&quot;</span>,</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                          <span class="stringliteral">&quot;Cleanup is disabled! There were &quot;</span> <a class="code" href="../../db/d35/_define_8h.html#ae21bf3255b0d48ac2e9a7cfec6b9210c">SZFMTD</a> <span class="stringliteral">&quot; dirty files applied to your database, &quot;</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                          <span class="stringliteral">&quot;but they are now missing in your source directory!&quot;</span>,</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                          toCleanup.size());</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        }</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    }</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d4/da6/struct_update_result.html">UpdateResult</a>(importedUpdates, countRecentUpdates, countArchivedUpdates);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;}</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160; </div>
<div class="line"><a name="l00424"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#a24699e8cc9d32551c24be563904bfdec">  424</a></span>&#160;<a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a> <a class="code" href="../../de/d9c/class_update_fetcher.html#a24699e8cc9d32551c24be563904bfdec">UpdateFetcher::Apply</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">Path</a> <span class="keyword">const</span>&amp; path)<span class="keyword"> const</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keyword">using</span> Time = std::chrono::high_resolution_clock;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160; </div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">// Benchmark query speed</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keyword">auto</span> <span class="keyword">const</span> begin = Time::now();</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160; </div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="comment">// Update database</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a94a1b6879c9277f6c03be9ab0334901b">_applyFile</a>(path);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160; </div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">// Return the time it took the query to apply</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/de2/namespace_g3_d.html#ae911b90657d7162d47997c702af655a8">uint32</a>(std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(Time::now() - begin).<a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a>());</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160; </div>
<div class="line"><a name="l00438"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#aa3e942e715d8e205307e2f73fe5b6903">  438</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#aa3e942e715d8e205307e2f73fe5b6903">UpdateFetcher::UpdateEntry</a>(<a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html">AppliedFileEntry</a> <span class="keyword">const</span>&amp; entry, <a class="code" href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a> <span class="keyword">const</span> speed)<span class="keyword"> const</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    std::string <span class="keyword">const</span> update = <span class="stringliteral">&quot;REPLACE INTO `updates` (`name`, `hash`, `state`, `speed`) VALUES (\&quot;&quot;</span> +</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                               entry.<a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#a8fc429eae6816054b5828952a5698a4c">name</a> + <span class="stringliteral">&quot;\&quot;, \&quot;&quot;</span> + entry.<a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#af39f798a10c2675e870d4d62f1d0a10c">hash</a> + <span class="stringliteral">&quot;\&quot;, \&#39;&quot;</span> + entry.<a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#a803f0ee67f0d3944b0933cf97723b5d3">GetStateAsString</a>() + <span class="stringliteral">&quot;\&#39;, &quot;</span> + <a class="code" href="../../d0/ddf/fmt_2include_2fmt_2format_8h.html#aa1899efcee92a5f5ca77b11423b256c5">std::to_string</a>(speed) + <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="comment">// Update database</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">_apply</a>(update);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;}</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160; </div>
<div class="line"><a name="l00447"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#acd434dd3fa7a7b5dc0af64926d07dfcd">  447</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#acd434dd3fa7a7b5dc0af64926d07dfcd">UpdateFetcher::RenameEntry</a>(std::string <span class="keyword">const</span>&amp; from, std::string <span class="keyword">const</span>&amp; to)<span class="keyword"> const</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="comment">// Delete the target if it exists</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    {</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        std::string <span class="keyword">const</span> update = <span class="stringliteral">&quot;DELETE FROM `updates` WHERE `name`=\&quot;&quot;</span> + to + <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="comment">// Update database</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <a class="code" href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">_apply</a>(update);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    }</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160; </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="comment">// Rename</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        std::string <span class="keyword">const</span> update = <span class="stringliteral">&quot;UPDATE `updates` SET `name`=\&quot;&quot;</span> + to + <span class="stringliteral">&quot;\&quot; WHERE `name`=\&quot;&quot;</span> + from + <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="comment">// Update database</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        <a class="code" href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">_apply</a>(update);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    }</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;}</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160; </div>
<div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#adace6180bb32614655fb1f99bbf4c1ef">  466</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#adace6180bb32614655fb1f99bbf4c1ef">UpdateFetcher::CleanUp</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">AppliedFileStorage</a> <span class="keyword">const</span>&amp; storage)<span class="keyword"> const</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">if</span> (storage.empty())</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160; </div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    std::stringstream update;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordtype">size_t</span> remaining = storage.size();</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    update &lt;&lt; <span class="stringliteral">&quot;DELETE FROM `updates` WHERE `name` IN(&quot;</span>;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160; </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span>&amp; entry : storage)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    {</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        update &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; entry.first &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">if</span> ((--remaining) &gt; 0)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            update &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    }</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    update &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="comment">// Update database</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">_apply</a>(update.str());</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;}</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno"><a class="line" href="../../de/d9c/class_update_fetcher.html#a3f2c0b3f92c460124562e8d8a15d9498">  489</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d9c/class_update_fetcher.html#a3f2c0b3f92c460124562e8d8a15d9498">UpdateFetcher::UpdateState</a>(std::string <span class="keyword">const</span>&amp; name, <a class="code" href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cb">State</a> <span class="keyword">const</span> state)<span class="keyword"> const</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    std::string <span class="keyword">const</span> update = <span class="stringliteral">&quot;UPDATE `updates` SET `state`=\&#39;&quot;</span> + <a class="code" href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">AppliedFileEntry::StateConvert</a>(state) + <span class="stringliteral">&quot;\&#39; WHERE `name`=\&quot;&quot;</span> + <a class="code" href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">name</a> + <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160; </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">// Update database</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <a class="code" href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">_apply</a>(update);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;}</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno"><a class="line" href="../../de/d33/struct_update_fetcher_1_1_path_compare.html#a7e4711e6ff92c3aca3a86fd911981786">  497</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../de/d33/struct_update_fetcher_1_1_path_compare.html#a7e4711e6ff92c3aca3a86fd911981786">UpdateFetcher::PathCompare::operator()</a>(<a class="code" href="../../de/d9c/class_update_fetcher.html#adb2996b906800fb0cdb5cf7ae14353d0">LocaleFileEntry</a> <span class="keyword">const</span>&amp; <a class="code" href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a3282b06f67c5e15c0eaeb515ef8f86fd">left</a>, <a class="code" href="../../de/d9c/class_update_fetcher.html#adb2996b906800fb0cdb5cf7ae14353d0">LocaleFileEntry</a> <span class="keyword">const</span>&amp; <a class="code" href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a5bf95244357d6164916bfe6e0ccfbc79">right</a>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a3282b06f67c5e15c0eaeb515ef8f86fd">left</a>.first.filename().string() &lt; <a class="code" href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a5bf95244357d6164916bfe6e0ccfbc79">right</a>.first.filename().string();</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;}</div>
<div class="ttc" id="a_crypto_hash_8h_html"><div class="ttname"><a href="../../d3/d9b/_crypto_hash_8h.html">CryptoHash.h</a></div></div>
<div class="ttc" id="a_d_b_updater_8h_html"><div class="ttname"><a href="../../dc/dca/_d_b_updater_8h.html">DBUpdater.h</a></div></div>
<div class="ttc" id="a_database_env_fwd_8h_html_ab0c9feeec448a181290fcb39565b8253"><div class="ttname"><a href="../../db/d04/_database_env_fwd_8h.html#ab0c9feeec448a181290fcb39565b8253">QueryResult</a></div><div class="ttdeci">std::shared_ptr&lt; ResultSet &gt; QueryResult</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d04/_database_env_fwd_8h_source.html#l00028">DatabaseEnvFwd.h:28</a></div></div>
<div class="ttc" id="a_define_8h_html_a0bf9964a3ce962c07ad3d8b5432bbbcd"><div class="ttname"><a href="../../db/d35/_define_8h.html#a0bf9964a3ce962c07ad3d8b5432bbbcd">int32</a></div><div class="ttdeci">std::int32_t int32</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d35/_define_8h_source.html#l00110">Define.h:110</a></div></div>
<div class="ttc" id="a_define_8h_html_a22f78cc9780bf32aff91ae17c3101c8d"><div class="ttname"><a href="../../db/d35/_define_8h.html#a22f78cc9780bf32aff91ae17c3101c8d">uint32</a></div><div class="ttdeci">std::uint32_t uint32</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d35/_define_8h_source.html#l00114">Define.h:114</a></div></div>
<div class="ttc" id="a_define_8h_html_ae21bf3255b0d48ac2e9a7cfec6b9210c"><div class="ttname"><a href="../../db/d35/_define_8h.html#ae21bf3255b0d48ac2e9a7cfec6b9210c">SZFMTD</a></div><div class="ttdeci">#define SZFMTD</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d35/_define_8h_source.html#l00104">Define.h:104</a></div></div>
<div class="ttc" id="a_field_8h_html"><div class="ttname"><a href="../../df/d96/_field_8h.html">Field.h</a></div></div>
<div class="ttc" id="a_query_result_8h_html"><div class="ttname"><a href="../../de/d66/_query_result_8h.html">QueryResult.h</a></div></div>
<div class="ttc" id="a_tokenize_8h_html"><div class="ttname"><a href="../../d1/d43/_tokenize_8h.html">Tokenize.h</a></div></div>
<div class="ttc" id="a_update_fetcher_8h_html"><div class="ttname"><a href="../../dc/d0d/_update_fetcher_8h.html">UpdateFetcher.h</a></div></div>
<div class="ttc" id="aclass_acore_1_1_impl_1_1_generic_hash_html_aeff80fe722abc16c9307d6ae50f22425"><div class="ttname"><a href="../../dc/de8/class_acore_1_1_impl_1_1_generic_hash.html#aeff80fe722abc16c9307d6ae50f22425">Acore::Impl::GenericHash::GetDigestOf</a></div><div class="ttdeci">static Digest GetDigestOf(uint8 const *data, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d9b/_crypto_hash_8h_source.html#l00053">CryptoHash.h:53</a></div></div>
<div class="ttc" id="aclass_field_html"><div class="ttname"><a href="../../dc/d67/class_field.html">Field</a></div><div class="ttdoc">Class used to access individual fields of database query result.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d96/_field_8h_source.html#l00083">Field.h:84</a></div></div>
<div class="ttc" id="aclass_field_html_a4d8f9d6164f9d3d7a26891dbd5003fa6"><div class="ttname"><a href="../../dc/d67/class_field.html#a4d8f9d6164f9d3d7a26891dbd5003fa6">Field::GetString</a></div><div class="ttdeci">std::string GetString() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc4/_field_8cpp_source.html#l00228">Field.cpp:228</a></div></div>
<div class="ttc" id="aclass_field_html_a757dd8cac1b769fdb82d8a529bad9d5b"><div class="ttname"><a href="../../dc/d67/class_field.html#a757dd8cac1b769fdb82d8a529bad9d5b">Field::GetUInt64</a></div><div class="ttdeci">uint64 GetUInt64() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc4/_field_8cpp_source.html#l00141">Field.cpp:141</a></div></div>
<div class="ttc" id="aclass_update_exception_html"><div class="ttname"><a href="../../df/d9b/class_update_exception.html">UpdateException</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dca/_d_b_updater_8h_source.html#l00037">DBUpdater.h:38</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a0f766525f7f9757a0cf14059952825f0"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a0f766525f7f9757a0cf14059952825f0">UpdateFetcher::_setDirectories</a></div><div class="ttdeci">std::vector&lt; std::string &gt; const  * _setDirectories</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00155">UpdateFetcher.h:155</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a24699e8cc9d32551c24be563904bfdec"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a24699e8cc9d32551c24be563904bfdec">UpdateFetcher::Apply</a></div><div class="ttdeci">uint32 Apply(Path const &amp;path) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00424">UpdateFetcher.cpp:424</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a286570b46c2ddd612b97de8e4ef4bd49"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a286570b46c2ddd612b97de8e4ef4bd49">UpdateFetcher::_apply</a></div><div class="ttdeci">std::function&lt; void(std::string const  &amp;)&gt; const _apply</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00149">UpdateFetcher.h:149</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a2c9442584093618696273003dd090c18"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a2c9442584093618696273003dd090c18">UpdateFetcher::_dbModuleName</a></div><div class="ttdeci">std::string const _dbModuleName</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00154">UpdateFetcher.h:154</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a35150c2d5a93caeee6f61369fc1372b8"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a35150c2d5a93caeee6f61369fc1372b8">UpdateFetcher::AppliedFileStorage</a></div><div class="ttdeci">std::unordered_map&lt; std::string, AppliedFileEntry &gt; AppliedFileStorage</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00127">UpdateFetcher.h:127</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a3a9a202b32079b6f623de924eb64de30"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a3a9a202b32079b6f623de924eb64de30">UpdateFetcher::UpdateFetcher</a></div><div class="ttdeci">UpdateFetcher(Path const &amp;updateDirectory, std::function&lt; void(std::string const &amp;)&gt; const &amp;apply, std::function&lt; void(Path const &amp;path)&gt; const &amp;applyFile, std::function&lt; QueryResult(std::string const &amp;)&gt; const &amp;retrieve, std::string const &amp;dbModuleName, std::vector&lt; std::string &gt; const *setDirectories=nullptr)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00039">UpdateFetcher.cpp:39</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a3a9e3d284f6bc45a155a17a7bd3284e2"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a3a9e3d284f6bc45a155a17a7bd3284e2">UpdateFetcher::_sourceDirectory</a></div><div class="ttdeci">std::unique_ptr&lt; Path &gt; const _sourceDirectory</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00147">UpdateFetcher.h:147</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a3c4e792ed5dc1016da8f9bb709b6d193"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a3c4e792ed5dc1016da8f9bb709b6d193">UpdateFetcher::GetFileList</a></div><div class="ttdeci">LocaleFileStorage GetFileList() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00052">UpdateFetcher.cpp:52</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a3f2c0b3f92c460124562e8d8a15d9498"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a3f2c0b3f92c460124562e8d8a15d9498">UpdateFetcher::UpdateState</a></div><div class="ttdeci">void UpdateState(std::string const &amp;name, State const state) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00489">UpdateFetcher.cpp:489</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a4b3294e1e96be56b5b2b60638e9da35f"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a4b3294e1e96be56b5b2b60638e9da35f">UpdateFetcher::LocaleFileStorage</a></div><div class="ttdeci">std::set&lt; LocaleFileEntry, PathCompare &gt; LocaleFileStorage</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00125">UpdateFetcher.h:125</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a557f248b248b5cd62606f843eda0bc00"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a557f248b248b5cd62606f843eda0bc00">UpdateFetcher::Path</a></div><div class="ttdeci">std::filesystem::path Path</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00044">UpdateFetcher.h:44</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a67e1565cbdd009909badb09d67eea1cb"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cb">UpdateFetcher::State</a></div><div class="ttdeci">State</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00063">UpdateFetcher.h:64</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a67e1565cbdd009909badb09d67eea1cbab25140471fb922c632f3d126d2a3e5b4"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbab25140471fb922c632f3d126d2a3e5b4">UpdateFetcher::CUSTOM</a></div><div class="ttdeci">@ CUSTOM</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00066">UpdateFetcher.h:66</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a67e1565cbdd009909badb09d67eea1cbae4e3bbfa8ddc283a5eededb71917098a"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbae4e3bbfa8ddc283a5eededb71917098a">UpdateFetcher::RELEASED</a></div><div class="ttdeci">@ RELEASED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00065">UpdateFetcher.h:65</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a67e1565cbdd009909badb09d67eea1cbae5b766afead812f823b982c5421629a8"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbae5b766afead812f823b982c5421629a8">UpdateFetcher::ARCHIVED</a></div><div class="ttdeci">@ ARCHIVED</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00069">UpdateFetcher.h:68</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a67e1565cbdd009909badb09d67eea1cbaf24fbaf4f357560007067272d5d238f4"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a67e1565cbdd009909badb09d67eea1cbaf24fbaf4f357560007067272d5d238f4">UpdateFetcher::MODULE</a></div><div class="ttdeci">@ MODULE</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00067">UpdateFetcher.h:67</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a8da5fda372d28f07213d723c5a582d5c"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5c">UpdateFetcher::UpdateMode</a></div><div class="ttdeci">UpdateMode</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00057">UpdateFetcher.h:58</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a8da5fda372d28f07213d723c5a582d5ca8aca24718213eedb0d7a10d636a9323d"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5ca8aca24718213eedb0d7a10d636a9323d">UpdateFetcher::MODE_APPLY</a></div><div class="ttdeci">@ MODE_APPLY</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00059">UpdateFetcher.h:59</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a8da5fda372d28f07213d723c5a582d5caafa5bf4aecde3d595d1119d51bb2f930"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a8da5fda372d28f07213d723c5a582d5caafa5bf4aecde3d595d1119d51bb2f930">UpdateFetcher::MODE_REHASH</a></div><div class="ttdeci">@ MODE_REHASH</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00061">UpdateFetcher.h:60</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a8e362ef41c19586ac1b13ecf77148a6d"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a8e362ef41c19586ac1b13ecf77148a6d">UpdateFetcher::ReadSQLUpdate</a></div><div class="ttdeci">std::string ReadSQLUpdate(Path const &amp;file) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00192">UpdateFetcher.cpp:192</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_a94a1b6879c9277f6c03be9ab0334901b"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#a94a1b6879c9277f6c03be9ab0334901b">UpdateFetcher::_applyFile</a></div><div class="ttdeci">std::function&lt; void(Path const  &amp;path)&gt; const _applyFile</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00150">UpdateFetcher.h:150</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_aa2b76c97a4b001de538a4268dcbeb365"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#aa2b76c97a4b001de538a4268dcbeb365">UpdateFetcher::Update</a></div><div class="ttdeci">UpdateResult Update(bool const redundancyChecks, bool const allowRehash, bool const archivedRedundancy, int32 const cleanDeadReferencesMaxCount) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00216">UpdateFetcher.cpp:216</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_aa3e942e715d8e205307e2f73fe5b6903"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#aa3e942e715d8e205307e2f73fe5b6903">UpdateFetcher::UpdateEntry</a></div><div class="ttdeci">void UpdateEntry(AppliedFileEntry const &amp;entry, uint32 const speed=0) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00438">UpdateFetcher.cpp:438</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_ab062338b0cbf4f1cd2ce67ac3d14fba2"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#ab062338b0cbf4f1cd2ce67ac3d14fba2">UpdateFetcher::FillFileListRecursively</a></div><div class="ttdeci">void FillFileListRecursively(Path const &amp;path, LocaleFileStorage &amp;storage, State const state, uint32 const depth) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00062">UpdateFetcher.cpp:62</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_aba8b6a3e4101d39c2ce7ddd6856c7ad1"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#aba8b6a3e4101d39c2ce7ddd6856c7ad1">UpdateFetcher::DirectoryStorage</a></div><div class="ttdeci">std::vector&lt; UpdateFetcher::DirectoryEntry &gt; DirectoryStorage</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00128">UpdateFetcher.h:128</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_abd11bb24a80148b6df4d0d35c9c88c51"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#abd11bb24a80148b6df4d0d35c9c88c51">UpdateFetcher::~UpdateFetcher</a></div><div class="ttdeci">~UpdateFetcher()</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00048">UpdateFetcher.cpp:48</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_acd434dd3fa7a7b5dc0af64926d07dfcd"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#acd434dd3fa7a7b5dc0af64926d07dfcd">UpdateFetcher::RenameEntry</a></div><div class="ttdeci">void RenameEntry(std::string const &amp;from, std::string const &amp;to) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00447">UpdateFetcher.cpp:447</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_ace16a0c67cff7fc411d470b3085d90d8"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#ace16a0c67cff7fc411d470b3085d90d8">UpdateFetcher::HashToFileNameStorage</a></div><div class="ttdeci">std::unordered_map&lt; std::string, std::string &gt; HashToFileNameStorage</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00126">UpdateFetcher.h:126</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_ad8dd66f9b12ae37fd657a8983a9ea6a1"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#ad8dd66f9b12ae37fd657a8983a9ea6a1">UpdateFetcher::ReceiveAppliedFiles</a></div><div class="ttdeci">AppliedFileStorage ReceiveAppliedFiles() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00169">UpdateFetcher.cpp:169</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_adace6180bb32614655fb1f99bbf4c1ef"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#adace6180bb32614655fb1f99bbf4c1ef">UpdateFetcher::CleanUp</a></div><div class="ttdeci">void CleanUp(AppliedFileStorage const &amp;storage) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00466">UpdateFetcher.cpp:466</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_adb2996b906800fb0cdb5cf7ae14353d0"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#adb2996b906800fb0cdb5cf7ae14353d0">UpdateFetcher::LocaleFileEntry</a></div><div class="ttdeci">std::pair&lt; Path, State &gt; LocaleFileEntry</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00118">UpdateFetcher.h:116</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_aea00e99b87bd24fd182676bf79e68c95"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#aea00e99b87bd24fd182676bf79e68c95">UpdateFetcher::_retrieve</a></div><div class="ttdeci">std::function&lt; QueryResult(std::string const  &amp;)&gt; const _retrieve</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00151">UpdateFetcher.h:151</a></div></div>
<div class="ttc" id="aclass_update_fetcher_html_af5faa613edb979a761f04784e8e9143f"><div class="ttname"><a href="../../de/d9c/class_update_fetcher.html#af5faa613edb979a761f04784e8e9143f">UpdateFetcher::ReceiveIncludedDirectories</a></div><div class="ttdeci">DirectoryStorage ReceiveIncludedDirectories() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00095">UpdateFetcher.cpp:95</a></div></div>
<div class="ttc" id="adeps_2_s_f_m_t_2_readme_8txt_html_aac939c3bd649f24d0faa40c551bd3da7"><div class="ttname"><a href="../../d4/d4b/deps_2_s_f_m_t_2_readme_8txt.html#aac939c3bd649f24d0faa40c551bd3da7">files</a></div><div class="ttdeci">Mutsuo Makoto Matsumoto and Hiroshima University Makoto Hiroshima University and The University of Tokyo All rights reserved see LICENSE see html index html To make test see html howto compile html If you want to redistribute and or change source files</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d4b/deps_2_s_f_m_t_2_readme_8txt_source.html#l00023">README.txt:23</a></div></div>
<div class="ttc" id="afmt_2include_2fmt_2core_8h_html_a501bb1bb2f0cc5706178ed237958e73b"><div class="ttname"><a href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a501bb1bb2f0cc5706178ed237958e73b">count</a></div><div class="ttdeci">constexpr auto count() -&gt; size_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01039">core.h:1039</a></div></div>
<div class="ttc" id="afmt_2include_2fmt_2core_8h_html_a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297"><div class="ttname"><a href="../../d5/d71/fmt_2include_2fmt_2core_8h.html#a7fc0249f0f8ba720115d2430f5b86cbaab068931cc450442b63f5b3d276ea4297">arg_id_kind::name</a></div><div class="ttdeci">@ name</div></div>
<div class="ttc" id="afmt_2include_2fmt_2format_8h_html_aa1899efcee92a5f5ca77b11423b256c5"><div class="ttname"><a href="../../d0/ddf/fmt_2include_2fmt_2format_8h.html#aa1899efcee92a5f5ca77b11423b256c5">to_string</a></div><div class="ttdeci">auto to_string(const T &amp;value) -&gt; std::string</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/ddf/fmt_2include_2fmt_2format_8h_source.html#l02600">format.h:2600</a></div></div>
<div class="ttc" id="ajemalloc_2include_2jemalloc_2internal_2hash_8h_html_a7c29faa803cee6ffd8af53ea4c6a4f4f"><div class="ttname"><a href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h.html#a7c29faa803cee6ffd8af53ea4c6a4f4f">hash</a></div><div class="ttdeci">static void hash(const void *key, size_t len, const uint32_t seed, size_t r_hash[2])</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d09/jemalloc_2include_2jemalloc_2internal_2hash_8h_source.html#l00304">hash.h:304</a></div></div>
<div class="ttc" id="anamespace_acore_html_a6b121485ace4118b9006db1fb89f90f2"><div class="ttname"><a href="../../d1/d7d/namespace_acore.html#a6b121485ace4118b9006db1fb89f90f2">Acore::Tokenize</a></div><div class="ttdeci">std::vector&lt; std::string_view &gt; Tokenize(std::string_view str, char sep, bool keepEmpty)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/da4/_tokenize_8cpp_source.html#l00020">Tokenize.cpp:20</a></div></div>
<div class="ttc" id="anamespace_byte_converter_html_a6177d7ac84a4ea6819c57a124345540e"><div class="ttname"><a href="../../de/d2e/namespace_byte_converter.html#a6177d7ac84a4ea6819c57a124345540e">ByteConverter::apply</a></div><div class="ttdeci">void apply(T *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/db2/_byte_converter_8h_source.html#l00040">ByteConverter.h:40</a></div></div>
<div class="ttc" id="anamespace_g3_d_html_ae911b90657d7162d47997c702af655a8"><div class="ttname"><a href="../../df/de2/namespace_g3_d.html#ae911b90657d7162d47997c702af655a8">G3D::uint32</a></div><div class="ttdeci">uint32_t uint32</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dfa/g3dmath_8h_source.html#l00168">g3dmath.h:168</a></div></div>
<div class="ttc" id="anamespacealign_html_aff2772e23f6ac91520e57d4b3ac0c759a3282b06f67c5e15c0eaeb515ef8f86fd"><div class="ttname"><a href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a3282b06f67c5e15c0eaeb515ef8f86fd">align::left</a></div><div class="ttdeci">@ left</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01859">core.h:1859</a></div></div>
<div class="ttc" id="anamespacealign_html_aff2772e23f6ac91520e57d4b3ac0c759a5bf95244357d6164916bfe6e0ccfbc79"><div class="ttname"><a href="../../d2/d18/namespacealign.html#aff2772e23f6ac91520e57d4b3ac0c759a5bf95244357d6164916bfe6e0ccfbc79">align::right</a></div><div class="ttdeci">@ right</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d71/fmt_2include_2fmt_2core_8h_source.html#l01859">core.h:1859</a></div></div>
<div class="ttc" id="anamespacedetail_1_1digits_html_aad69d2373aa047bdd9e81494bf3da5ae"><div class="ttname"><a href="../../df/d60/namespacedetail_1_1digits.html#aad69d2373aa047bdd9e81494bf3da5ae">detail::digits::result</a></div><div class="ttdeci">result</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d50/format-inl_8h_source.html#l00622">format-inl.h:622</a></div></div>
<div class="ttc" id="anamespacempq_html_a4d9e28a606ab362cda8f825daad0fb49"><div class="ttname"><a href="../../d4/d71/namespacempq.html#a4d9e28a606ab362cda8f825daad0fb49">mpq.file</a></div><div class="ttdeci">file</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3e/mpq_8py_source.html#l00283">mpq.py:283</a></div></div>
<div class="ttc" id="anamespacestd_html"><div class="ttname"><a href="../../d8/dcc/namespacestd.html">std</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/dfa/g3dmath_8h_source.html#l00935">g3dmath.h:935</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_a0e09b50c268dc6897a1c70aa46de936e"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a0e09b50c268dc6897a1c70aa46de936e">LOG_FATAL</a></div><div class="ttdeci">#define LOG_FATAL(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00257">Log.h:257</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_a271e427d8e8481efd5cd5f537ec9e419"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a271e427d8e8481efd5cd5f537ec9e419">LOG_INFO</a></div><div class="ttdeci">#define LOG_INFO(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00269">Log.h:269</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_a43832e3fa8508deb4ce43e520005fcd9"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a43832e3fa8508deb4ce43e520005fcd9">LOG_ERROR</a></div><div class="ttdeci">#define LOG_ERROR(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00261">Log.h:261</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_a47ac782b14a7531c6232777165a1a161"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#a47ac782b14a7531c6232777165a1a161">LOG_DEBUG</a></div><div class="ttdeci">#define LOG_DEBUG(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00273">Log.h:273</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#ac0b4843dd5a1f2e3b7aaa7dbc9dc8ba5">LOG_TRACE</a></div><div class="ttdeci">#define LOG_TRACE(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00277">Log.h:277</a></div></div>
<div class="ttc" id="asrc_2common_2_logging_2_log_8h_html_adf09840a666e1d86bcd3439105db6edc"><div class="ttname"><a href="../../d3/d07/src_2common_2_logging_2_log_8h.html#adf09840a666e1d86bcd3439105db6edc">LOG_WARN</a></div><div class="ttdeci">#define LOG_WARN(filterType__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d07/src_2common_2_logging_2_log_8h_source.html#l00265">Log.h:265</a></div></div>
<div class="ttc" id="asrc_2common_2_utilities_2util_8h_html_a559d532d2bfeee7ed59f0b1dbce4e86a"><div class="ttname"><a href="../../d9/de9/src_2common_2_utilities_2util_8h.html#a559d532d2bfeee7ed59f0b1dbce4e86a">ByteArrayToHexStr</a></div><div class="ttdeci">std::string ByteArrayToHexStr(Container const &amp;c, bool reverse=false)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/de9/src_2common_2_utilities_2util_8h_source.html#l00413">Util.h:413</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_applied_file_entry_html"><div class="ttname"><a href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html">UpdateFetcher::AppliedFileEntry</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00071">UpdateFetcher.h:72</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_applied_file_entry_html_a803f0ee67f0d3944b0933cf97723b5d3"><div class="ttname"><a href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#a803f0ee67f0d3944b0933cf97723b5d3">UpdateFetcher::AppliedFileEntry::GetStateAsString</a></div><div class="ttdeci">std::string GetStateAsString() const</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00110">UpdateFetcher.h:110</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_applied_file_entry_html_a8fc429eae6816054b5828952a5698a4c"><div class="ttname"><a href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#a8fc429eae6816054b5828952a5698a4c">UpdateFetcher::AppliedFileEntry::name</a></div><div class="ttdeci">std::string const name</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00076">UpdateFetcher.h:76</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_applied_file_entry_html_ac35fc4abcc60015c56765ceebc6fdb8f"><div class="ttname"><a href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#ac35fc4abcc60015c56765ceebc6fdb8f">UpdateFetcher::AppliedFileEntry::StateConvert</a></div><div class="ttdeci">static State StateConvert(std::string const &amp;state)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00081">UpdateFetcher.h:81</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_applied_file_entry_html_af39f798a10c2675e870d4d62f1d0a10c"><div class="ttname"><a href="../../d0/d79/struct_update_fetcher_1_1_applied_file_entry.html#af39f798a10c2675e870d4d62f1d0a10c">UpdateFetcher::AppliedFileEntry::hash</a></div><div class="ttdeci">std::string const hash</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00077">UpdateFetcher.h:77</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_directory_entry_html"><div class="ttname"><a href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html">UpdateFetcher::DirectoryEntry</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00031">UpdateFetcher.cpp:32</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_directory_entry_html_a02538aefc1b014b60957d4c67793000f"><div class="ttname"><a href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#a02538aefc1b014b60957d4c67793000f">UpdateFetcher::DirectoryEntry::DirectoryEntry</a></div><div class="ttdeci">DirectoryEntry(Path const &amp;path_, State state_)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00033">UpdateFetcher.cpp:33</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_directory_entry_html_aca34dff6659f2da63f31e12bb41cf3d0"><div class="ttname"><a href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aca34dff6659f2da63f31e12bb41cf3d0">UpdateFetcher::DirectoryEntry::path</a></div><div class="ttdeci">Path const path</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00035">UpdateFetcher.cpp:35</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_directory_entry_html_aeddd31e8fbb23e54549e985f09c4ea96"><div class="ttname"><a href="../../de/d3e/struct_update_fetcher_1_1_directory_entry.html#aeddd31e8fbb23e54549e985f09c4ea96">UpdateFetcher::DirectoryEntry::state</a></div><div class="ttdeci">State const state</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00036">UpdateFetcher.cpp:36</a></div></div>
<div class="ttc" id="astruct_update_fetcher_1_1_path_compare_html_a7e4711e6ff92c3aca3a86fd911981786"><div class="ttname"><a href="../../de/d33/struct_update_fetcher_1_1_path_compare.html#a7e4711e6ff92c3aca3a86fd911981786">UpdateFetcher::PathCompare::operator()</a></div><div class="ttdeci">bool operator()(LocaleFileEntry const &amp;left, LocaleFileEntry const &amp;right) const</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d40/_update_fetcher_8cpp_source.html#l00497">UpdateFetcher.cpp:497</a></div></div>
<div class="ttc" id="astruct_update_result_html"><div class="ttname"><a href="../../d4/da6/struct_update_result.html">UpdateResult</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d0d/_update_fetcher_8h_source.html#l00029">UpdateFetcher.h:30</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
